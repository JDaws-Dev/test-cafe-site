<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artios Cafe - Daily Checklist</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      min-height: 100vh;
      color: #333;
    }
    
    /* Animation for temporary messages */
    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes fadeOut {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
        transform: scale(0.9);
      }
    }

    /* Login Screen */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      max-width: 400px;
      width: 100%;
      text-align: center;
    }

    .login-title {
      font-size: 2em;
      font-weight: 700;
      color: #ff9800;
      margin-bottom: 10px;
    }

    .login-subtitle {
      color: #666;
      margin-bottom: 30px;
    }

    .password-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 18px;
      margin-bottom: 20px;
      text-align: center;
      letter-spacing: 2px;
    }

    .password-input:focus {
      outline: none;
      border-color: #ff9800;
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }

    .login-btn {
      width: 100%;
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      color: white;
      border: none;
      padding: 15px;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 152, 0, 0.3);
    }

    .login-error {
      color: #dc3545;
      margin-top: 15px;
      display: none;
    }

    /* Main Checklist Interface */
    .checklist-container {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
    }

    .checklist-header {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .header-title {
      font-size: 1.8em;
      font-weight: 700;
    }

    .header-date {
      font-size: 1.2em;
      opacity: 0.95;
    }

    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Summary Section */
    .summary-section {
      background: #fff3e0;
      border: 2px solid #ff9800;
      border-radius: 12px;
      padding: 20px;
      margin: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
    }

    .summary-card {
      text-align: center;
    }

    .summary-label {
      color: #f57c00;
      font-size: 0.9em;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .summary-value {
      font-size: 2em;
      font-weight: 700;
      color: #333;
    }

    /* Controls Section */
    .controls-section {
      padding: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      background: #f8f9fa;
      border-bottom: 2px solid #e0e0e0;
    }

    .date-selector {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .date-input {
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
    }

    .date-input:focus {
      outline: none;
      border-color: #ff9800;
    }

    .refresh-btn, .print-btn {
      background: white;
      color: #333;
      border: 2px solid #e0e0e0;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover, .print-btn:hover {
      border-color: #ff9800;
      background: #fff3e0;
    }

    .filter-buttons {
      display: flex;
      gap: 10px;
      margin-left: auto;
    }

    .filter-btn {
      background: white;
      color: #666;
      border: 2px solid #e0e0e0;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .filter-btn.active {
      background: #ff9800;
      color: white;
      border-color: #ff9800;
    }

    /* Orders Section */
    .orders-section {
      padding: 20px;
    }

    .section-title {
      font-size: 1.3em;
      font-weight: 700;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ff9800;
    }

    /* Student Checklist */
    .student-checklist {
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .student-item {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid #e0e0e0;
      transition: background 0.2s ease;
    }

    .student-item:hover {
      background: #f8f9fa;
    }

    .student-item.delivered {
      background: #e8f5e8;
      opacity: 0.8;
    }

    .student-checkbox {
      width: 24px;
      height: 24px;
      margin-right: 20px;
      cursor: pointer;
      accent-color: #4caf50;
    }

    .student-info {
      flex: 1;
      display: grid;
      grid-template-columns: 200px 100px 1fr 100px;
      gap: 20px;
      align-items: center;
    }

    .student-name {
      font-weight: 600;
      color: #333;
      font-size: 1.05em;
    }

    .student-grade {
      color: #666;
      font-size: 0.9em;
      background: #f0f0f0;
      padding: 4px 12px;
      border-radius: 12px;
      text-align: center;
    }

    .student-items {
      color: #495057;
    }

    .student-total {
      font-weight: 700;
      color: #28a745;
      text-align: right;
      font-size: 1.1em;
    }

    /* Category Summary for Chick-fil-A Orders */
    .category-summary {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
    }

    .category-title {
      color: #1976d2;
      font-size: 1.2em;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .category-items {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 10px;
    }

    .category-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 12px;
      background: white;
      border-radius: 6px;
    }

    .category-item-name {
      font-weight: 500;
    }

    .category-item-count {
      font-weight: 700;
      color: #1976d2;
    }

    /* Loading State */
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .loading-spinner {
      display: inline-block;
      width: 30px;
      height: 30px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #ff9800;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-icon {
      font-size: 4em;
      margin-bottom: 20px;
      opacity: 0.3;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .student-info {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .student-name {
        font-size: 1.1em;
        margin-bottom: 5px;
      }

      .controls-section {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-buttons {
        margin-left: 0;
        justify-content: space-between;
      }

      .summary-section {
        grid-template-columns: 1fr;
      }
    }

    /* Print Styles */
    @media print {
      body {
        background: white;
      }

      .checklist-header {
        background: none;
        color: black;
        border-bottom: 2px solid black;
      }

      .controls-section,
      .logout-btn {
        display: none;
      }

      .student-item {
        page-break-inside: avoid;
      }

      .student-checkbox {
        border: 2px solid black;
        width: 20px;
        height: 20px;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-container" id="login-screen">
    <div class="login-box">
      <h1 class="login-title">üçΩÔ∏è Artios Cafe</h1>
      <p class="login-subtitle">Daily Checklist Portal</p>
      
      <input type="password" 
             class="password-input" 
             id="password-input" 
             placeholder="Enter password"
             maxlength="20">
      
      <button class="login-btn" onclick="login()">
        Access Checklist
      </button>
      
      <div class="login-error" id="login-error">
        Incorrect password. Please try again.
      </div>
    </div>
  </div>

  <!-- Main Checklist Interface -->
  <div class="checklist-container" id="checklist-screen">
    <div class="checklist-header">
      <div class="header-top">
        <h1 class="header-title">üìã Daily Food Orders</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
      <div class="header-date" id="header-date">Loading...</div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-section">
      <div class="summary-card">
        <div class="summary-label">Total Orders</div>
        <div class="summary-value" id="total-orders">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Students</div>
        <div class="summary-value" id="total-students">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Delivered</div>
        <div class="summary-value" id="total-delivered">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Remaining</div>
        <div class="summary-value" id="total-remaining">0</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls-section">
      <div class="date-selector">
        <label for="date-input">Date:</label>
        <input type="date" id="date-input" class="date-input">
        <button class="refresh-btn" onclick="loadOrders()">üîÑ Refresh</button>
      </div>
      
      <button class="print-btn" onclick="window.print()">üñ®Ô∏è Print</button>
      
      <div class="filter-buttons">
        <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
        <button class="filter-btn" data-filter="pending" onclick="setFilter('pending')">Pending</button>
        <button class="filter-btn" data-filter="delivered" onclick="setFilter('delivered')">Delivered</button>
      </div>
    </div>

    <!-- Orders Section -->
    <div class="orders-section">
      <!-- Chick-fil-A Order Summary -->
      <div class="category-summary" id="chickfila-summary" style="display: none;">
        <div class="category-title">üêî Chick-fil-A Order Summary</div>
        <div class="category-items" id="chickfila-items">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>

      <!-- Student Checklist -->
      <div class="section-title">Student Distribution Checklist</div>
      <div class="student-checklist" id="student-checklist">
        <div class="loading">
          <span class="loading-spinner"></span>
          Loading orders...
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const CAFE_PASSWORD = 'cafe2025';
    const API_URL = 'https://script.google.com/macros/s/AKfycbzgQFKeMYxYAHH8iP2ASjGk8nGS8KNZ4XbC7tqHYG5TQE04YEwmNh-WFEoSBcHkrvZs/exec';
    
    let currentFilter = 'all';
    let allOrders = [];
    let deliveredOrders = new Set();

    // Check if already logged in
    document.addEventListener('DOMContentLoaded', function() {
      const isLoggedIn = sessionStorage.getItem('cafe_logged_in');
      if (isLoggedIn === 'true') {
        showChecklist();
      }
      
      // Set today's date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date-input').value = today;
      
      // Enter key on password field
      document.getElementById('password-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') login();
      });
    });

    function login() {
      const password = document.getElementById('password-input').value;
      
      if (password === CAFE_PASSWORD) {
        sessionStorage.setItem('cafe_logged_in', 'true');
        showChecklist();
      } else {
        document.getElementById('login-error').style.display = 'block';
        document.getElementById('password-input').value = '';
      }
    }

    function logout() {
      sessionStorage.removeItem('cafe_logged_in');
      window.location.reload();
    }

    function showChecklist() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('checklist-screen').style.display = 'block';
      loadOrders();
    }

    async function loadOrders() {
      const dateInput = document.getElementById('date-input').value;
      if (!dateInput) return;
      
      // Update header date
      const date = new Date(dateInput + 'T12:00:00');
      const dateStr = date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      document.getElementById('header-date').textContent = dateStr;
      
      // Show loading
      document.getElementById('student-checklist').innerHTML = `
        <div class="loading">
          <span class="loading-spinner"></span>
          Loading orders for ${dateStr}...
        </div>
      `;
      
      try {
        // Fetch orders from Google Sheets
        const response = await fetch(`${API_URL}?action=get_daily_orders&date=${dateInput}`);
        const data = await response.json();
        
        if (data.success) {
          allOrders = data.orders || [];
          
          // Load saved delivery status from localStorage
          const savedStatus = localStorage.getItem(`delivered_${dateInput}`);
          if (savedStatus) {
            deliveredOrders = new Set(JSON.parse(savedStatus));
          } else {
            deliveredOrders = new Set();
          }
          
          displayOrders();
          updateSummary();
          updateChickFilASummary();
        } else {
          showError('Failed to load orders');
        }
      } catch (error) {
        console.error('Error loading orders:', error);
        showError('Network error. Please check your connection.');
      }
    }

    function displayOrders() {
      const container = document.getElementById('student-checklist');
      
      if (allOrders.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì≠</div>
            <h3>No Orders for This Date</h3>
            <p>There are no lunch orders scheduled for this day.</p>
          </div>
        `;
        return;
      }
      
      // Group orders by student
      const studentOrders = {};
      allOrders.forEach(order => {
        const key = `${order.childName}_${order.childId}`;
        if (!studentOrders[key]) {
          studentOrders[key] = {
            name: order.childName,
            firstName: order.childFirstName,
            lastName: order.childLastName,
            grade: order.grade,
            items: [],
            total: 0,
            orderId: order.orderId,
            childId: order.childId
          };
        }
        studentOrders[key].items.push(order.itemName);
        studentOrders[key].total += order.itemPrice;
      });
      
      // Sort by last name
      const sortedStudents = Object.values(studentOrders).sort((a, b) => 
        a.lastName.localeCompare(b.lastName)
      );
      
      // Build HTML
      let html = '';
      sortedStudents.forEach(student => {
        const studentKey = `${student.orderId}_${student.childId}`;
        const isDelivered = deliveredOrders.has(studentKey);
        
        // Apply filter
        if (currentFilter === 'delivered' && !isDelivered) return;
        if (currentFilter === 'pending' && isDelivered) return;
        
        html += `
          <div class="student-item ${isDelivered ? 'delivered' : ''}" data-student="${studentKey}">
            <input type="checkbox" 
                   class="student-checkbox" 
                   ${isDelivered ? 'checked' : ''}
                   onchange="toggleDelivered('${studentKey}')">
            <div class="student-info">
              <div class="student-name">${student.name}</div>
              <div class="student-grade">${student.grade}</div>
              <div class="student-items">${student.items.join(' + ')}</div>
              <div class="student-total">$${student.total.toFixed(2)}</div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html || '<div class="empty-state">No orders match the current filter.</div>';
    }

    function toggleDelivered(studentKey) {
      const dateInput = document.getElementById('date-input').value;
      
      if (deliveredOrders.has(studentKey)) {
        deliveredOrders.delete(studentKey);
      } else {
        deliveredOrders.add(studentKey);
      }
      
      // Save to localStorage
      localStorage.setItem(`delivered_${dateInput}`, JSON.stringify(Array.from(deliveredOrders)));
      
      // Update display
      const studentItem = document.querySelector(`[data-student="${studentKey}"]`);
      if (studentItem) {
        studentItem.classList.toggle('delivered');
      }
      
      updateSummary();
      
      // Also save to Google Sheets (optional - for persistence across devices)
      // This would require adding the update_distribution endpoint to Code.gs
    }

    function updateSummary() {
      // Count unique students
      const studentMap = {};
      allOrders.forEach(order => {
        const key = `${order.childName}_${order.childId}`;
        if (!studentMap[key]) {
          studentMap[key] = {
            orderId: order.orderId,
            childId: order.childId
          };
        }
      });
      
      const totalStudents = Object.keys(studentMap).length;
      const totalDelivered = Array.from(deliveredOrders).filter(key => {
        return Object.values(studentMap).some(s => `${s.orderId}_${s.childId}` === key);
      }).length;
      
      document.getElementById('total-orders').textContent = allOrders.length;
      document.getElementById('total-students').textContent = totalStudents;
      document.getElementById('total-delivered').textContent = totalDelivered;
      document.getElementById('total-remaining').textContent = totalStudents - totalDelivered;
    }

    function updateChickFilASummary() {
      const itemCounts = {};
      
      // Count all items (excluding chips which are Artios-provided)
      allOrders.forEach(order => {
        if (!order.itemName.toLowerCase().includes('chips')) {
          itemCounts[order.itemName] = (itemCounts[order.itemName] || 0) + 1;
        }
      });
      
      if (Object.keys(itemCounts).length === 0) {
        document.getElementById('chickfila-summary').style.display = 'none';
        return;
      }
      
      // Display summary
      const container = document.getElementById('chickfila-items');
      let html = '';
      
      // Sort by count (highest first)
      Object.entries(itemCounts)
        .sort((a, b) => b[1] - a[1])
        .forEach(([item, count]) => {
          html += `
            <div class="category-item">
              <span class="category-item-name">${item}</span>
              <span class="category-item-count">${count}</span>
            </div>
          `;
        });
      
      container.innerHTML = html;
      document.getElementById('chickfila-summary').style.display = 'block';
    }

    function setFilter(filter) {
      currentFilter = filter;
      
      // Update button states
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      
      // Refresh display
      displayOrders();
    }

    function showError(message) {
      document.getElementById('student-checklist').innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">‚ö†Ô∏è</div>
          <h3>Error</h3>
          <p>${message}</p>
          <button class="refresh-btn" onclick="loadOrders()" style="margin-top: 20px;">Try Again</button>
        </div>
      `;
    }
  </script>
</body>
</html>
