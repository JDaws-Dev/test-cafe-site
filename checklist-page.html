<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artios Cafe - Daily Checklist</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      min-height: 100vh;
      color: #333;
    }

    /* Login Screen */
    .login-container {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
    }

    .login-box {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      max-width: 400px;
      width: 100%;
      text-align: center;
    }

    .login-title {
      font-size: 2em;
      font-weight: 700;
      color: #ff9800;
      margin-bottom: 10px;
    }

    .login-subtitle {
      color: #666;
      margin-bottom: 30px;
    }

    .password-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-size: 18px;
      margin-bottom: 20px;
      text-align: center;
      letter-spacing: 2px;
    }

    .password-input:focus {
      outline: none;
      border-color: #ff9800;
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }

    .login-btn {
      width: 100%;
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      color: white;
      border: none;
      padding: 15px;
      border-radius: 10px;
      font-size: 18px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(255, 152, 0, 0.3);
    }

    .login-error {
      color: #dc3545;
      margin-top: 15px;
      display: none;
    }

    /* Main Interface */
    .checklist-container {
      display: none;
      max-width: 100%;
      margin: 0 auto;
      background: white;
      min-height: 100vh;
    }

    .checklist-header {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      color: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .header-title {
      font-size: 1.4em;
      font-weight: 700;
    }

    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
    }

    .header-date {
      font-size: 1em;
      opacity: 0.95;
    }

    /* Summary Section - Mobile First */
    .summary-section {
      background: #fff3e0;
      border: 2px solid #ff9800;
      border-radius: 12px;
      padding: 15px;
      margin: 15px;
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .summary-card {
      text-align: center;
      background: white;
      padding: 15px;
      border-radius: 8px;
    }

    .summary-label {
      color: #f57c00;
      font-size: 0.75em;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 5px;
    }

    .summary-value {
      font-size: 1.8em;
      font-weight: 700;
      color: #333;
    }

    /* Controls - Mobile Optimized */
    .controls-section {
      padding: 15px;
      background: #f8f9fa;
      border-bottom: 2px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .date-row {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .date-label {
      font-weight: 600;
      text-align: center;
    }

    .date-input, .refresh-btn, .print-btn {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
    }

    .date-input:focus {
      outline: none;
      border-color: #ff9800;
    }

    .refresh-btn, .print-btn {
      background: white;
      color: #333;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .refresh-btn:hover, .print-btn:hover {
      border-color: #ff9800;
      background: #fff3e0;
    }

    .filter-buttons {
      display: flex;
      gap: 8px;
    }

    .filter-btn {
      flex: 1;
      background: white;
      color: #666;
      border: 2px solid #e0e0e0;
      padding: 12px 8px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .filter-btn.active {
      background: #ff9800;
      color: white;
      border-color: #ff9800;
    }

    /* Order Summaries - Simplified for Mobile */
    .order-summary {
      background: #e3f2fd;
      border: 2px solid #2196f3;
      border-radius: 12px;
      padding: 15px;
      margin: 15px;
    }

    .summary-title {
      color: #1976d2;
      font-size: 1.1em;
      font-weight: 700;
      text-align: center;
      margin-bottom: 15px;
    }

    .summary-content {
      background: white;
      padding: 12px;
      border-radius: 8px;
    }

    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 6px;
      border-left: 4px solid #2196f3;
    }

    .item-name {
      font-weight: 500;
      font-size: 14px;
    }

    .item-count {
      font-weight: 700;
      color: #1976d2;
      background: white;
      padding: 4px 8px;
      border-radius: 12px;
      min-width: 30px;
      text-align: center;
      font-size: 14px;
    }

    .summary-total {
      font-weight: 700;
      text-align: center;
      margin-top: 15px;
      padding: 12px;
      background: #1976d2;
      color: white;
      border-radius: 8px;
      font-size: 1em;
    }

    /* Student Checklist - Completely Mobile Optimized */
    .section-title {
      font-size: 1.2em;
      font-weight: 700;
      color: #333;
      margin: 20px 15px 15px 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ff9800;
    }

    .student-checklist {
      background: white;
      margin: 0 15px 15px 15px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .student-item {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      transition: background 0.2s ease;
    }

    .student-item:hover {
      background: #f8f9fa;
    }

    .student-item.delivered {
      background: #e8f5e8;
      opacity: 0.8;
    }

    .student-item.updating {
      background: #fff3e0;
      pointer-events: none;
    }

    .student-content {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .student-header {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .student-checkbox {
      width: 24px;
      height: 24px;
      cursor: pointer;
      accent-color: #4caf50;
      flex-shrink: 0;
    }

    .student-name {
      font-weight: 700;
      color: #333;
      font-size: 1.2em;
      flex: 1;
    }

    .student-details {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-left: 39px; /* Align with checkbox */
    }

    .student-grade {
      background: #f0f0f0;
      color: #666;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      width: fit-content;
    }

    .student-items {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      border-left: 4px solid #ff9800;
      font-weight: 500;
      color: #555;
    }

    .student-total {
      background: #e8f5e8;
      color: #28a745;
      padding: 8px 12px;
      border-radius: 6px;
      font-weight: 700;
      font-size: 1.1em;
      text-align: center;
      width: fit-content;
    }

    /* Loading and Empty States */
    .loading, .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #666;
    }

    .loading-spinner {
      display: inline-block;
      width: 25px;
      height: 25px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #ff9800;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-icon {
      font-size: 3em;
      margin-bottom: 15px;
      opacity: 0.3;
    }

    /* Notifications */
    .notification {
      position: fixed;
      top: 10px;
      left: 10px;
      right: 10px;
      background: #4caf50;
      color: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 10000;
      font-weight: 600;
      text-align: center;
    }

    .notification.error {
      background: #f44336;
    }

    /* Desktop Adjustments */
    @media (min-width: 768px) {
      .checklist-header {
        padding: 20px 30px;
      }

      .header-title {
        font-size: 1.8em;
      }

      .header-date {
        font-size: 1.2em;
      }

      .summary-section {
        grid-template-columns: repeat(3, 1fr);
        margin: 20px;
        padding: 20px;
      }

      .controls-section {
        flex-direction: row;
        align-items: center;
        padding: 20px;
      }

      .date-row {
        flex-direction: row;
        align-items: center;
        gap: 15px;
      }

      .date-input, .refresh-btn, .print-btn {
        width: auto;
        min-width: 120px;
      }

      .filter-buttons {
        margin-left: auto;
      }

      .filter-btn {
        flex: none;
        padding: 8px 16px;
      }

      .student-item {
        padding: 15px 20px;
      }

      .student-content {
        flex-direction: row;
        align-items: center;
        gap: 20px;
      }

      .student-header {
        flex: none;
        width: 300px;
      }

      .student-details {
        flex: 1;
        flex-direction: row;
        align-items: center;
        margin-left: 0;
        gap: 20px;
      }

      .student-total {
        margin-left: auto;
      }
    }

    @media (min-width: 1024px) {
      .summary-section {
        grid-template-columns: repeat(6, 1fr);
      }

      .checklist-container {
        max-width: 1400px;
        margin: 0 auto;
      }
    }

    /* Print Styles */
    @media print {
      body { background: white; }
      .checklist-header { background: none; color: black; }
      .controls-section, .logout-btn { display: none; }
      .student-checkbox { border: 2px solid black; }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-container" id="login-screen">
    <div class="login-box">
      <h1 class="login-title">🍽️ Artios Cafe</h1>
      <p class="login-subtitle">Daily Checklist Portal</p>
      
      <input type="password" 
             class="password-input" 
             id="password-input" 
             placeholder="Enter password"
             maxlength="20">
      
      <button class="login-btn" onclick="login()">
        Access Checklist
      </button>
      
      <div class="login-error" id="login-error">
        Incorrect password. Please try again.
      </div>
    </div>
  </div>

  <!-- Main Interface -->
  <div class="checklist-container" id="checklist-screen">
    <div class="checklist-header">
      <div class="header-top">
        <h1 class="header-title">📋 Daily Food Orders</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
      <div class="header-date" id="header-date">Today</div>
    </div>

    <!-- Summary Cards -->
    <div class="summary-section">
      <div class="summary-card">
        <div class="summary-label">Total Items</div>
        <div class="summary-value" id="total-orders">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Students</div>
        <div class="summary-value" id="total-students">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Chick-fil-A</div>
        <div class="summary-value" id="chickfila-count">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Artios Items</div>
        <div class="summary-value" id="artios-count">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Delivered</div>
        <div class="summary-value" id="total-delivered">0</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Remaining</div>
        <div class="summary-value" id="total-remaining">0</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="controls-section">
      <div class="date-row">
        <div class="date-label">Date:</div>
        <input type="date" id="date-input" class="date-input">
        <button class="refresh-btn" onclick="loadOrders()">🔄 Refresh</button>
        <button class="print-btn" onclick="window.print()">🖨️ Print</button>
      </div>
      
      <div class="filter-buttons">
        <button class="filter-btn active" data-filter="all" onclick="setFilter('all')">All</button>
        <button class="filter-btn" data-filter="pending" onclick="setFilter('pending')">Pending</button>
        <button class="filter-btn" data-filter="delivered" onclick="setFilter('delivered')">Delivered</button>
      </div>
    </div>

    <!-- Order Summaries -->
    <div class="order-summary" id="chickfila-summary" style="display: none;">
      <div class="summary-title">🐔 CHICK-FIL-A ORDER</div>
      <div class="summary-content" id="chickfila-content"></div>
    </div>

    <div class="order-summary" id="artios-summary" style="display: none;">
      <div class="summary-title">🏫 ARTIOS ITEMS</div>
      <div class="summary-content" id="artios-content"></div>
    </div>

    <!-- Student Checklist -->
    <div class="section-title">Student Distribution Checklist</div>
    <div class="student-checklist" id="student-checklist">
      <div class="loading">
        <span class="loading-spinner"></span>
        Loading orders...
      </div>
    </div>
  </div>

  <script>
    // Configuration - USING CORRECT URL FROM login.html
    const CAFE_PASSWORD = 'cafe2025';
    const API_URL = 'https://script.google.com/macros/s/AKfycbzgQFKeMYxYAHH8iP2ASjGk8nGS8KNZ4XbC7tqHYG5TQE04YEwmNh-WFEoSBcHkrvZs/exec';
    
    let currentFilter = 'all';
    let allOrders = [];
    let deliveredOrders = new Set();

    document.addEventListener('DOMContentLoaded', function() {
      // Set today's date
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date-input').value = today;
      
      // Auto-load when date changes
      document.getElementById('date-input').addEventListener('change', loadOrders);
      
      // Enter key on password
      document.getElementById('password-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') login();
      });

      // Check if already logged in
      if (sessionStorage.getItem('cafe_logged_in') === 'true') {
        showChecklist();
      }
    });

    function login() {
      const password = document.getElementById('password-input').value;
      
      if (password === CAFE_PASSWORD) {
        sessionStorage.setItem('cafe_logged_in', 'true');
        showChecklist();
      } else {
        document.getElementById('login-error').style.display = 'block';
        document.getElementById('password-input').value = '';
      }
    }

    function logout() {
      sessionStorage.removeItem('cafe_logged_in');
      window.location.reload();
    }

    function showChecklist() {
      document.getElementById('login-screen').style.display = 'none';
      document.getElementById('checklist-screen').style.display = 'block';
      loadOrders(); // Load immediately
    }

    async function loadOrders() {
      const dateInput = document.getElementById('date-input').value;
      if (!dateInput) return;
      
      console.log('Loading orders for:', dateInput);
      
      // Update header
      const date = new Date(dateInput + 'T12:00:00');
      const dateStr = date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        month: 'long', 
        day: 'numeric',
        year: 'numeric'
      });
      document.getElementById('header-date').textContent = dateStr;
      
      // Show loading immediately
      showLoading();
      
      try {
        const response = await fetch(`${API_URL}?action=get_daily_orders&date=${dateInput}`, {
          method: 'GET',
          mode: 'cors'
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        console.log('API Response:', data);
        
        if (data.success) {
          allOrders = data.orders || [];
          console.log('Loaded orders:', allOrders.length);
          
          loadDeliveryStatus();
          displayAll();
        } else {
          showError('No orders found for this date');
        }
      } catch (error) {
        console.error('Error:', error);
        showError('Unable to load orders. Check connection and try again.');
      }
    }

    function showLoading() {
      document.getElementById('student-checklist').innerHTML = `
        <div class="loading">
          <span class="loading-spinner"></span>
          Loading orders...
        </div>
      `;
    }

    function loadDeliveryStatus() {
      deliveredOrders = new Set();
      allOrders.forEach(order => {
        if (order.distributed === true) {
          deliveredOrders.add(`${order.orderId}_${order.childId}`);
        }
      });
    }

    function displayAll() {
      displayOrders();
      updateSummary();
      updateOrderSummaries();
    }

    function displayOrders() {
      const container = document.getElementById('student-checklist');
      
      if (allOrders.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">📭</div>
            <h3>No Orders</h3>
            <p>No lunch orders for this date.</p>
          </div>
        `;
        return;
      }
      
      // Group by student
      const studentOrders = {};
      allOrders.forEach(order => {
        const key = `${order.childName}_${order.childId}_${order.orderId}`;
        if (!studentOrders[key]) {
          studentOrders[key] = {
            name: order.childName,
            lastName: order.childLastName || order.childName.split(' ')[1] || '',
            grade: order.grade,
            items: [],
            total: 0,
            orderId: order.orderId,
            childId: order.childId
          };
        }
        studentOrders[key].items.push(order.itemName);
        studentOrders[key].total += order.itemPrice;
      });
      
      // Sort by last name
      const sortedStudents = Object.values(studentOrders).sort((a, b) => 
        a.lastName.localeCompare(b.lastName)
      );
      
      let html = '';
      sortedStudents.forEach(student => {
        const studentKey = `${student.orderId}_${student.childId}`;
        const isDelivered = deliveredOrders.has(studentKey);
        
        // Apply filter
        if (currentFilter === 'delivered' && !isDelivered) return;
        if (currentFilter === 'pending' && isDelivered) return;
        
        html += `
          <div class="student-item ${isDelivered ? 'delivered' : ''}" data-student="${studentKey}">
            <div class="student-content">
              <div class="student-header">
                <input type="checkbox" 
                       class="student-checkbox" 
                       ${isDelivered ? 'checked' : ''}
                       onchange="toggleDelivered('${studentKey}', '${student.orderId}', '${student.childId}')">
                <div class="student-name">${student.name}</div>
              </div>
              <div class="student-details">
                <div class="student-grade">${student.grade}</div>
                <div class="student-items">${student.items.join(' + ')}</div>
                <div class="student-total">$${student.total.toFixed(2)}</div>
              </div>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html || `
        <div class="empty-state">
          <div class="empty-icon">🔍</div>
          <h3>No Results</h3>
          <p>No orders match the current filter.</p>
        </div>
      `;
    }

    async function toggleDelivered(studentKey, orderId, childId) {
      const checkbox = document.querySelector(`[data-student="${studentKey}"] .student-checkbox`);
      const studentItem = document.querySelector(`[data-student="${studentKey}"]`);
      
      if (!checkbox || !studentItem) return;
      
      const isNowDelivered = checkbox.checked;
      studentItem.classList.add('updating');
      
      try {
        const response = await fetch(
          `${API_URL}?action=update_distribution&order_id=${encodeURIComponent(orderId)}&child_id=${encodeURIComponent(childId)}&distributed=${isNowDelivered}`
        );
        const result = await response.json();
        
        if (result.success) {
          if (isNowDelivered) {
            deliveredOrders.add(studentKey);
            studentItem.classList.add('delivered');
          } else {
            deliveredOrders.delete(studentKey);
            studentItem.classList.remove('delivered');
          }
          
          updateSummary();
          showNotification(isNowDelivered ? 'Marked as delivered' : 'Marked as pending');
        } else {
          checkbox.checked = !isNowDelivered;
          showNotification('Update failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (error) {
        checkbox.checked = !isNowDelivered;
        showNotification('Network error', 'error');
      } finally {
        studentItem.classList.remove('updating');
      }
    }

    function updateSummary() {
      const studentMap = {};
      allOrders.forEach(order => {
        const key = `${order.orderId}|${order.childId}`;
        studentMap[key] = true;
      });
      
      const totalStudents = Object.keys(studentMap).length;
      const totalDelivered = Array.from(deliveredOrders).filter(key => studentMap[key]).length;
      
      document.getElementById('total-orders').textContent = allOrders.length;
      document.getElementById('total-students').textContent = totalStudents;
      document.getElementById('total-delivered').textContent = totalDelivered;
      document.getElementById('total-remaining').textContent = totalStudents - totalDelivered;
    }

    function updateOrderSummaries() {
      const chickfilaItems = {};
      const artiosItems = {};
      
      allOrders.forEach(order => {
        const itemName = order.itemName;
        const lowerName = itemName.toLowerCase();
        
        if (lowerName.includes('drink') || lowerName.includes('chips')) {
          artiosItems[itemName] = (artiosItems[itemName] || 0) + 1;
        } else {
          chickfilaItems[itemName] = (chickfilaItems[itemName] || 0) + 1;
        }
      });
      
      // Update Chick-fil-A
      const chickFilATotal = Object.values(chickfilaItems).reduce((sum, count) => sum + count, 0);
      if (chickFilATotal > 0) {
        let html = '';
        Object.entries(chickfilaItems).forEach(([name, count]) => {
          html += `
            <div class="category-item">
              <span class="item-name">${name}</span>
              <span class="item-count">${count}</span>
            </div>
          `;
        });
        html += `<div class="summary-total">TOTAL: ${chickFilATotal} items</div>`;
        document.getElementById('chickfila-content').innerHTML = html;
        document.getElementById('chickfila-summary').style.display = 'block';
      } else {
        document.getElementById('chickfila-summary').style.display = 'none';
      }
      
      // Update Artios
      const artiosTotal = Object.values(artiosItems).reduce((sum, count) => sum + count, 0);
      if (artiosTotal > 0) {
        let html = '';
        Object.entries(artiosItems).forEach(([name, count]) => {
          html += `
            <div class="category-item">
              <span class="item-name">${name}</span>
              <span class="item-count">${count}</span>
            </div>
          `;
        });
        html += `<div class="summary-total">TOTAL: ${artiosTotal} items</div>`;
        document.getElementById('artios-content').innerHTML = html;
        document.getElementById('artios-summary').style.display = 'block';
      } else {
        document.getElementById('artios-summary').style.display = 'none';
      }
      
      document.getElementById('chickfila-count').textContent = chickFilATotal;
      document.getElementById('artios-count').textContent = artiosTotal;
    }

    function setFilter(filter) {
      currentFilter = filter;
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      displayOrders();
    }

    function showError(message) {
      document.getElementById('student-checklist').innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">⚠️</div>
          <h3>Error</h3>
          <p>${message}</p>
          <button class="refresh-btn" onclick="loadOrders()" style="margin-top: 15px; width: auto; padding: 10px 20px;">Try Again</button>
        </div>
      `;
    }

    function showNotification(message, type = 'success') {
      // Remove existing
      const existing = document.querySelector('.notification');
      if (existing) existing.remove();
      
      const notification = document.createElement('div');
      notification.className = `notification ${type === 'error' ? 'error' : ''}`;
      notification.textContent = message;
      
      document.body.appendChild(notification);
      
      setTimeout(() => notification.remove(), 3000);
    }
  </script>
</body>
</html>
