<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Order Lunch - Artios Academies Cafe</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f8f9fa;
      color: #202124;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 100vh;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
    }

    .back-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      backdrop-filter: blur(10px);
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.3);
      transform: translateY(-2px);
    }

    .header-brand {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin-bottom: 20px;
    }

    .artios-logo {
      width: 60px;
      height: 60px;
      flex-shrink: 0;
      object-fit: contain;
    }

    .header-text {
      text-align: left;
    }

    .header h1 {
      font-size: 2.2em;
      font-weight: 600;
      margin: 0;
      line-height: 1.2;
    }

    .header .subtitle {
      font-size: 1.1em;
      font-weight: 300;
      margin: 5px 0 0 0;
      opacity: 0.9;
    }

    .store-status {
      position: absolute;
      top: 10px;
      right: 20px;
      background: rgba(255,255,255,0.2);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8em;
    }

    .main-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 30px;
      padding: 30px;
    }

    .menu-section {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 25px;
    }

    .cart-section {
      background: #fff;
      border: 2px solid #e9ecef;
      border-radius: 15px;
      padding: 25px;
      height: fit-content;
      position: sticky;
      top: 20px;
    }

    .day-tabs {
      display: flex;
      margin-bottom: 25px;
      background: white;
      border-radius: 10px;
      padding: 5px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex-wrap: wrap;
      border-bottom: 2px solid #e0e0e0;
      overflow-x: auto;
      align-items: center;
    }

    .day-tab {
      flex: 1;
      padding: 15px 25px;
      cursor: pointer;
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
      white-space: nowrap;
      font-weight: 500;
      color: #666;
      text-align: center;
      background: transparent;
      border: none;
      border-radius: 8px;
      min-width: 120px;
    }

    .day-tab:hover {
      background: rgba(66, 133, 244, 0.1);
      color: #4285f4;
    }

    .day-tab.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      border-bottom-color: #4285f4;
    }

    .day-tab.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      color: #999;
    }

    .day-tab.disabled:hover {
      background: none;
      color: #999;
    }

    .menu-for-day {
      display: none;
    }

    .menu-for-day.active {
      display: block;
    }

    .menu-category {
      margin-bottom: 30px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .menu-category.collapsed .menu-items {
      display: none;
    }

    .menu-category-header {
      background: linear-gradient(135deg, rgba(52, 168, 83, 0.15) 0%, rgba(52, 168, 83, 0.05) 100%);
      border-left: 4px solid #34a853;
      padding: 15px 20px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s ease;
    }

    .menu-category-header:hover {
      background: linear-gradient(135deg, rgba(52, 168, 83, 0.25) 0%, rgba(52, 168, 83, 0.15) 100%);
    }

    .menu-category-header h4 {
      color: #34a853;
      font-size: 1.3em;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 0;
    }

    .collapse-icon {
      color: #34a853;
      font-size: 1.2em;
      font-weight: bold;
      transition: transform 0.3s ease;
    }

    .menu-category.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .menu-items {
      padding: 20px;
      background: white;
    }

    .menu-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 10px;
      transition: all 0.3s ease;
      display: flex;
      gap: 15px;
      align-items: flex-start;
    }

    .menu-item:hover {
      border-color: #4285f4;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }

    .menu-item-image {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
      border: 2px solid #e0e0e0;
      transition: all 0.3s ease;
    }

    .menu-item:hover .menu-item-image {
      border-color: #4285f4;
      transform: scale(1.05);
    }

    .menu-item-content {
      flex: 1;
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .item-name {
      font-weight: 600;
      color: #333;
      font-size: 1.1em;
    }

    .item-price {
      font-weight: 700;
      color: #34a853;
      font-size: 1.2em;
    }

    .item-desc {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 15px;
      line-height: 1.4;
    }

    .item-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .child-selector-inline {
      flex: 1;
      margin-right: 15px;
    }

    .child-selector-inline select {
      width: 100%;
      padding: 8px 12px;
      border: 2px solid #e9ecef;
      border-radius: 6px;
      font-size: 14px;
    }

    .add-btn {
      background: linear-gradient(135deg, #00b894, #00a085);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      font-size: 14px;
    }

    .add-btn:hover:not(:disabled) {
      transform: scale(1.05);
      box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
    }

    .add-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .cart h2 {
      color: #2c3e50;
      margin-bottom: 20px;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .child-selector {
      margin-bottom: 20px;
    }

    .child-selector select {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 16px;
    }

    .cart-items {
      margin-bottom: 20px;
      max-height: 400px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .empty-cart {
      text-align: center;
      color: #999;
      padding: 40px 20px;
      font-style: italic;
    }

    .child-cart-section {
      margin-bottom: 20px;
    }

    .child-cart-header {
      background: #4285f4;
      color: white;
      padding: 10px 15px;
      border-radius: 6px 6px 0 0;
      font-weight: 600;
      font-size: 0.9em;
    }

    .cart-item {
      background: white;
      border: 1px solid #e0e0e0;
      padding: 12px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .cart-item:last-child {
      border-radius: 0 0 6px 6px;
    }

    .cart-item-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .cart-item-name {
      font-weight: 500;
      color: #333;
    }

    .cart-item-details {
      font-size: 0.85em;
      color: #666;
    }

    .cart-item-price {
      font-weight: 700;
      color: #34a853;
    }

    .cart-item-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .qty-btn {
      background: #e74c3c;
      color: white;
      border: none;
      width: 25px;
      height: 25px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .qty-btn:hover {
      background: #c0392b;
      transform: scale(1.1);
    }

    .quantity {
      font-weight: 600;
      min-width: 20px;
      text-align: center;
    }

    .remove-item-btn {
      background: #ff5722;
      color: white;
      border: none;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.3s ease;
      margin-left: 10px;
      flex-shrink: 0;
    }

    .remove-item-btn:hover {
      background: #d32f2f;
      transform: scale(1.1);
    }

    .promo-section {
      background: #fff3e0;
      border: 2px solid #ff9800;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .promo-section h4 {
      color: #f57c00;
      margin-bottom: 10px;
      font-size: 0.9em;
      font-weight: 600;
      text-align: center;
    }

    .promo-input {
      width: 100%;
      padding: 10px;
      border: 2px solid #ffcc02;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      text-transform: uppercase;
      background: white;
      transition: all 0.3s ease;
    }

    .promo-input:focus {
      outline: none;
      border-color: #ff9800;
      box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.1);
    }

    .promo-status {
      margin-top: 8px;
      text-align: center;
      font-size: 0.8em;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .promo-status.valid {
      color: #4caf50;
      opacity: 1;
    }

    .promo-status.invalid {
      color: #f44336;
      opacity: 1;
    }

    .total {
      text-align: center;
      font-size: 1.5em;
      font-weight: bold;
      color: #2c3e50;
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }

    .cart-total {
      background: white;
      border: 2px solid #4285f4;
      border-radius: 8px;
      padding: 20px;
    }

    .total-label {
      font-size: 1.1em;
      font-weight: 600;
      color: #4285f4;
      margin-bottom: 10px;
    }

    .total-amount {
      font-size: 2em;
      font-weight: 700;
      color: #34a853;
      margin-bottom: 20px;
    }

    .checkout-btn {
      width: 100%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border: none;
      padding: 15px;
      border-radius: 10px;
      font-size: 1.2em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .checkout-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
    }

    .checkout-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .parent-info {
      margin-bottom: 20px;
    }

    .parent-info input {
      width: 100%;
      padding: 12px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      margin-bottom: 10px;
      font-size: 16px;
    }

    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      font-weight: 500;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .status-message.show {
      opacity: 1;
    }

    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .status-message.info {
      background: #e3f2fd;
      color: #1976d2;
      border: 1px solid #bbdefb;
    }

    .store-closed {
      background: #e74c3c;
      color: white;
      padding: 15px;
      text-align: center;
      border-radius: 10px;
      margin-bottom: 20px;
      font-weight: 600;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
        gap: 20px;
        padding: 20px;
      }
      
      .header h1 {
        font-size: 1.8em;
      }
      
      .day-tabs {
        flex-direction: column;
        gap: 5px;
      }
      
      .day-tab {
        min-width: auto;
      }

      .cart-section {
        position: static;
      }

      .header-brand {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .header-text {
        text-align: center;
      }

      .artios-logo {
        width: 50px;
        height: 50px;
      }

      .menu-item {
        flex-direction: column;
        gap: 10px;
      }

      .menu-item-image {
        width: 100%;
        height: 150px;
        align-self: center;
      }

      .item-actions {
        flex-direction: column;
        gap: 10px;
      }

      .child-selector-inline {
        margin-right: 0;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="store-status" id="store-status">
        Checking store hours...
      </div>
      <button class="back-btn" onclick="window.location.href='dashboard.html'">‚Üê Back to Dashboard</button>
      
      <div class="header-brand">
        <img class="artios-logo" src="artios-logo.png" alt="Artios Academies Logo" onerror="this.style.display='none'">
        <div class="header-text">
          <h1>Order Lunch</h1>
          <div class="subtitle">Artios Academies Cafe</div>
        </div>
      </div>
    </div>

    <div id="store-status-banner"></div>

    <div class="main-content">
      <div class="menu-section">
        <div class="day-tabs" id="day-tabs">
          <!-- Tabs will be generated by JavaScript -->
        </div>

        <div id="menu-container">
          <!-- Menu for each day will be generated by JavaScript -->
        </div>
      </div>

      <div class="cart-section">
        <div class="cart">
          <h2>üõí Your Order</h2>
          
          <div class="child-selector">
            <select id="child-select">
              <option value="">Select Child</option>
            </select>
          </div>

          <div class="cart-items" id="cart-items">
            <div class="empty-cart">Your cart is empty</div>
          </div>

          <div class="promo-section">
            <h4>üéüÔ∏è Discount Codes</h4>
            <input type="text" 
                   id="promo-code" 
                   class="promo-input" 
                   placeholder="Enter discount code"
                   maxlength="20">
            <div class="promo-status" id="promo-status"></div>
          </div>

          <div class="total" id="total">Total: $0.00</div>

          <div class="parent-info">
            <input type="email" id="parent-email" placeholder="Parent Email" readonly>
            <input type="tel" id="parent-phone" placeholder="Parent Phone (optional)">
          </div>

          <button class="checkout-btn" id="checkout-btn" onclick="proceedToCheckout()" disabled>
            Place Order
          </button>

          <div class="status-message" id="status-message"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const GOOGLE_SHEETS_CONFIG = {
      webAppUrl: 'https://script.google.com/macros/s/AKfycbxWSO9AKq5uWU7iReEoZcSx3Vn0oeL30ovCeTryKOmC2ze1kP-r7PhWBeAeIY4-82G3/exec',
      useGoogleSheets: true
    };

    // Menu data with images from index.html
    const menuData = {
      entrees: [
        { id: 'chicken-sandwich', name: 'Chicken Sandwich', price: 6.50, desc: 'Classic boneless breast of chicken', image: 'assets/chickensandwich.png' },
        { id: 'spicy-chicken', name: 'Spicy Chicken Sandwich', price: 6.75, desc: 'Boneless breast with spicy seasoning', image: 'assets/spicysandwich.png' },
        { id: 'nuggets-8', name: 'Nuggets (8ct)', price: 6.50, desc: 'Bite-sized boneless chicken pieces', image: 'assets/nuggets.png' },
        { id: 'grilled-nuggets', name: 'Grilled Nuggets (8ct)', price: 7.50, desc: 'Grilled boneless chicken pieces', image: 'assets/grillednuggets.png' },
        { id: 'grilled-sandwich', name: 'Grilled Sandwich', price: 8.25, desc: 'Grilled chicken breast sandwich', image: 'assets/grilledsandwich.png' },
        { id: 'grilled-gf', name: 'Grilled Sandwich (GF Bun)', price: 9.50, desc: 'Grilled chicken with gluten-free bun', image: 'assets/grilledsandwich.png' },
        { id: 'chicken-wrap', name: 'Chicken Wrap', price: 9.75, desc: 'Grilled chicken in tortilla wrap', image: 'assets/chickenwrap.png' },
        { id: 'veggie-wrap', name: 'Southwest Veggie Wrap', price: 9.50, desc: 'Vegetarian wrap with southwest flavors', image: 'assets/veggiewrap.png' },
        { id: 'chicken-strips', name: 'Chicken Strips (3ct)', price: 6.75, desc: 'Hand-breaded chicken strips', image: 'assets/chickenstrips.png' }
      ],
      salads: [
        { id: 'cobb-salad', name: 'Cobb Salad', price: 11.25, desc: 'Mixed greens with chicken, bacon, cheese, and more', image: 'assets/cobbsalad.png' },
        { id: 'southwest-salad', name: 'Southwest Salad', price: 11.50, desc: 'Mixed greens with chicken, corn, peppers', image: 'assets/southwestsalad.png' },
        { id: 'market-salad', name: 'Market Fresh Salad', price: 11.50, desc: 'Mixed greens with chicken and seasonal toppings', image: 'assets/marketsalad.png' }
      ],
      sides: [
        { id: 'fries-only', name: 'Fries', price: 3.75, desc: 'Waffle potato fries', image: 'assets/fries.png' },
        { id: 'fruit-only', name: 'Fruit Cup', price: 5.50, desc: 'Fresh seasonal fruit', image: 'assets/fruitcup.png' },
        { id: 'mac-only', name: 'Mac & Cheese', price: 5.50, desc: 'Creamy macaroni and cheese', image: 'assets/MacnCheese_5oz_pdp.png' },
        { id: 'salad-only', name: 'Side Salad', price: 5.50, desc: 'Mixed greens with toppings', image: 'assets/sidesalad.png' },
        { id: 'parfait-only', name: 'Cookie Parfait', price: 5.75, desc: 'Cookie pieces with cream', image: 'assets/berryparfaitcookiecrumble.png' },
        { id: 'chips-only', name: 'Chips', price: 1.50, desc: 'Variety of chips (provided by Artios)', image: 'assets/chips.jpg' }
      ],
      drinks: [
        { id: 'regular-drink', name: 'Regular Drink', basePrice: 1.50, desc: 'Water, Sodas (choose at pickup)', category: 'regular' },
        { id: 'premium-drink', name: 'Premium Drink', basePrice: 3.00, desc: 'Iced Coffees, Vitamin Water (choose at pickup)', category: 'premium' }
      ]
    };

    // Global variables
    let currentDay = 'Monday';
    let cart = [];
    let children = [];
    let selectedChild = '';
    let appliedPromo = null;
    let authenticatedEmail = '';
    let currentWeekMonday = null;
    let isNextWeek = false;

    const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];

    // Store hours (24-hour format)
    const storeHours = {
      cutoffHour: 8,
      cutoffMinute: 15,
      days: [1, 2, 3, 4, 5] // Monday to Friday
    };

    // Updated promo codes as requested
    const promoCodes = {
      'STAFF2025': { discount: 0.10, description: '10% Staff Discount' },
      'JOHN': { discount: 0.50, description: '50% JOHN Discount' }
    };

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      if (!checkAuthentication()) {
        return;
      }
      
      loadUserData();
      checkStoreHours();
      generateDayTabs();
      generateMenus();
      setupEventListeners();
      updateCartDisplay();
    });

    function checkAuthentication() {
      authenticatedEmail = sessionStorage.getItem('authenticatedEmail');
      const authExpiry = parseInt(sessionStorage.getItem('authExpiry'));
      
      if (!authenticatedEmail || !authExpiry || Date.now() >= authExpiry) {
        window.location.href = 'login.html';
        return false;
      }
      
      return true;
    }

    function loadUserData() {
      // Set parent email from authentication
      document.getElementById('parent-email').value = authenticatedEmail;
      
      // For demo purposes, create some sample children
      // In a real app, this would come from the family account data
      children = ['Emma Johnson', 'Liam Johnson', 'Sophia Johnson'];
      populateChildSelector();
    }

    function populateChildSelector() {
      const childSelect = document.getElementById('child-select');
      childSelect.innerHTML = '<option value="">Select Child</option>';
      
      children.forEach(child => {
        const option = document.createElement('option');
        option.value = child;
        option.textContent = child;
        childSelect.appendChild(option);
      });

      childSelect.addEventListener('change', function() {
        selectedChild = this.value;
        updateCheckoutButton();
      });
    }

    function checkStoreHours() {
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      const currentDay = now.getDay();
      
      const isWeekday = storeHours.days.includes(currentDay);
      const isPastCutoff = (currentHour > storeHours.cutoffHour) || 
                         (currentHour === storeHours.cutoffHour && currentMinute >= storeHours.cutoffMinute);
      
      const statusDiv = document.getElementById('store-status');
      
      if (!isWeekday) {
        statusDiv.textContent = 'üïê Weekend Ordering';
        statusDiv.style.background = 'rgba(255, 152, 0, 0.8)';
      } else if (isPastCutoff) {
        statusDiv.textContent = 'üïê Past Daily Cutoff';
        statusDiv.style.background = 'rgba(244, 67, 54, 0.8)';
      } else {
        statusDiv.textContent = '‚úÖ Store Open';
        statusDiv.style.background = 'rgba(76, 175, 80, 0.8)';
      }
    }

    function generateDayTabs() {
      const tabsContainer = document.getElementById('day-tabs');
      const now = new Date();
      
      days.forEach(function(day, index) {
        const tab = document.createElement('button');
        tab.className = 'day-tab';
        tab.dataset.day = day;
        tab.textContent = day;
        
        if (index === 0) {
          tab.classList.add('active');
        }
        
        tab.addEventListener('click', function() { switchDay(day); });
        tabsContainer.appendChild(tab);
      });
    }

    function generateMenus() {
      const container = document.getElementById('menu-container');
      
      days.forEach(function(day) {
        const dayMenu = document.createElement('div');
        dayMenu.className = 'menu-for-day';
        dayMenu.dataset.day = day;
        
        if (day === currentDay) {
          dayMenu.classList.add('active');
        }
        
        Object.keys(menuData).forEach(function(category) {
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'menu-category';
          categoryDiv.dataset.category = category;
          
          let categoryTitle = category.charAt(0).toUpperCase() + category.slice(1);
          
          // Create collapsible header
          const headerDiv = document.createElement('div');
          headerDiv.className = 'menu-category-header';
          headerDiv.innerHTML = `
            <h4>${categoryTitle}</h4>
            <span class="collapse-icon">‚ñº</span>
          `;
          
          const itemsDiv = document.createElement('div');
          itemsDiv.className = 'menu-items';
          
          menuData[category].forEach(function(item) {
            const itemDiv = document.createElement('div');
            itemDiv.className = 'menu-item';
            
            let priceDisplay;
            if (category === 'drinks') {
              priceDisplay = '$' + item.basePrice.toFixed(2);
            } else {
              priceDisplay = '$' + item.price.toFixed(2);
            }
            
            // Create menu item with image (skip drinks for images)
            let imageHtml = '';
            if (category !== 'drinks' && item.image) {
              imageHtml = `<img src="${item.image}" alt="${item.name}" class="menu-item-image" onerror="this.style.display='none'">`;
            }
            
            itemDiv.innerHTML = `
              ${imageHtml}
              <div class="menu-item-content">
                <div class="item-header">
                  <div class="item-name">${item.name}</div>
                  <div class="item-price">${priceDisplay}</div>
                </div>
                <div class="item-desc">${item.desc}</div>
                <div class="item-actions">
                  <div class="child-selector-inline">
                    <select class="item-child-select" data-item-id="${item.id}" data-day="${day}">
                      <option value="">Select Child</option>
                    </select>
                  </div>
                  <button class="add-btn" onclick="addToCartFromItem('${item.id}', '${item.name.replace(/'/g, "\\'")}', ${item.price || item.basePrice}, '${day}', '${category}')" disabled>
                    Add to Cart
                  </button>
                </div>
              </div>
            `;
            
            itemsDiv.appendChild(itemDiv);
          });
          
          categoryDiv.appendChild(headerDiv);
          categoryDiv.appendChild(itemsDiv);
          
          // Setup collapse functionality
          setupCategoryToggle(categoryDiv);
          
          dayMenu.appendChild(categoryDiv);
        });
        
        container.appendChild(dayMenu);
      });
      
      updateChildSelectors();
    }

    function setupCategoryToggle(categoryDiv) {
      const header = categoryDiv.querySelector('.menu-category-header');
      header.addEventListener('click', function() {
        categoryDiv.classList.toggle('collapsed');
      });
    }

    function updateChildSelectors() {
      document.querySelectorAll('.item-child-select').forEach(select => {
        const currentValue = select.value;
        select.innerHTML = '<option value="">Select Child</option>';
        
        children.forEach(child => {
          const option = document.createElement('option');
          option.value = child;
          option.textContent = child;
          select.appendChild(option);
        });
        
        if (currentValue) {
          select.value = currentValue;
        }
        
        select.addEventListener('change', function() {
          const button = this.parentElement.nextElementSibling;
          button.disabled = !this.value;
        });
      });
    }

    function switchDay(day) {
      document.querySelectorAll('.day-tab').forEach(function(tab) {
        tab.classList.remove('active');
        if (tab.dataset.day === day) {
          tab.classList.add('active');
        }
      });

      document.querySelectorAll('.menu-for-day').forEach(function(menu) {
        menu.classList.remove('active');
        if (menu.dataset.day === day) {
          menu.classList.add('active');
        }
      });

      currentDay = day;
    }

    function setupEventListeners() {
      document.getElementById('promo-code').addEventListener('input', function(e) {
        validatePromoCode(e.target.value);
      });
    }

    function addToCartFromItem(id, name, price, day, category) {
      const select = document.querySelector(`select[data-item-id="${id}"][data-day="${day}"]`);
      const selectedChild = select.value;
      
      if (!selectedChild) {
        showStatus('Please select a child first!', 'error');
        return;
      }

      const existingItem = cart.find(item => 
        item.id === id && 
        item.child === selectedChild && 
        item.day === day
      );
      
      if (existingItem) {
        existingItem.quantity += 1;
      } else {
        cart.push({
          id: id,
          name: name,
          price: price,
          quantity: 1,
          child: selectedChild,
          day: day,
          category: category,
          childId: children.indexOf(selectedChild) + 1
        });
      }
      
      updateCartDisplay();
      showStatus(`Added ${name} for ${selectedChild}`, 'success');
    }

    function removeFromCart(id, child, day) {
      const itemIndex = cart.findIndex(item => 
        item.id === id && 
        item.child === child && 
        item.day === day
      );
      
      if (itemIndex > -1) {
        if (cart[itemIndex].quantity > 1) {
          cart[itemIndex].quantity -= 1;
        } else {
          cart.splice(itemIndex, 1);
        }
      }
      updateCartDisplay();
    }

    function updateCartDisplay() {
      const cartContainer = document.getElementById('cart-items');
      
      if (cart.length === 0) {
        cartContainer.innerHTML = '<div class="empty-cart">Your cart is empty</div>';
      } else {
        // Group by child
        const itemsByChild = {};
        cart.forEach(item => {
          if (!itemsByChild[item.child]) {
            itemsByChild[item.child] = [];
          }
          itemsByChild[item.child].push(item);
        });
        
        let html = '';
        Object.keys(itemsByChild).forEach(childName => {
          html += `<div class="child-cart-section">`;
          html += `<div class="child-cart-header">${childName}</div>`;
          
          itemsByChild[childName].forEach(item => {
            html += `
              <div class="cart-item">
                <div class="cart-item-content">
                  <div class="cart-item-name">${item.name}</div>
                  <div class="cart-item-details">${item.day}</div>
                  <div class="cart-item-price">$${(item.price * item.quantity).toFixed(2)}</div>
                </div>
                <div class="cart-item-controls">
                  <button class="qty-btn" onclick="removeFromCart('${item.id}', '${item.child}', '${item.day}')">-</button>
                  <span class="quantity">${item.quantity}</span>
                  <button class="qty-btn" onclick="addToCartFromItem('${item.id}', '${item.name.replace(/'/g, "\\'")}', ${item.price}, '${item.day}', '${item.category}')">+</button>
                </div>
              </div>
            `;
          });
          
          html += `</div>`;
        });
        
        cartContainer.innerHTML = html;
      }
      
      updateTotal();
      updateCheckoutButton();
    }

    function updateTotal() {
      let subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      let discount = 0;
      
      if (appliedPromo) {
        discount = subtotal * appliedPromo.discount;
      }
      
      const total = subtotal - discount;
      
      let totalHTML = `Subtotal: $${subtotal.toFixed(2)}`;
      if (discount > 0) {
        totalHTML += `<br><span style="color: #e74c3c;">Discount: -$${discount.toFixed(2)}</span>`;
        totalHTML += `<br><strong>Total: $${total.toFixed(2)}</strong>`;
      } else {
        totalHTML = `Total: $${total.toFixed(2)}`;
      }
      
      document.getElementById('total').innerHTML = totalHTML;
    }

    function updateCheckoutButton() {
      const checkoutBtn = document.getElementById('checkout-btn');
      const canCheckout = cart.length > 0;
      checkoutBtn.disabled = !canCheckout;
    }

    function validatePromoCode(code) {
      const promoStatus = document.getElementById('promo-status');
      const trimmedCode = code.trim().toUpperCase();
      
      if (trimmedCode === '') {
        appliedPromo = null;
        promoStatus.textContent = '';
        promoStatus.className = 'promo-status';
      } else if (promoCodes[trimmedCode]) {
        appliedPromo = promoCodes[trimmedCode];
        promoStatus.textContent = `‚úÖ ${appliedPromo.description} applied!`;
        promoStatus.className = 'promo-status valid';
      } else {
        appliedPromo = null;
        promoStatus.textContent = '‚ùå Invalid Code';
        promoStatus.className = 'promo-status invalid';
      }
      
      updateTotal();
    }

    function proceedToCheckout() {
      if (cart.length === 0) {
        showStatus('Please add items to cart!', 'error');
        return;
      }

      const parentEmail = document.getElementById('parent-email').value;
      const parentPhone = document.getElementById('parent-phone').value;

      if (!parentEmail) {
        showStatus('Parent email is required!', 'error');
        return;
      }

      // Calculate totals
      let subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
      let discount = appliedPromo ? subtotal * appliedPromo.discount : 0;
      let total = subtotal - discount;

      // Prepare order data
      const orderData = {
        orderId: generateOrderId(),
        parentEmail: parentEmail,
        parentPhone: parentPhone,
        children: getUniqueChildren(),
        items: cart.map(item => ({
          ...item,
          date: getDateForDay(item.day)
        })),
        subtotal: subtotal,
        discount: discount,
        total: total,
        promoCode: appliedPromo ? Object.keys(promoCodes).find(key => promoCodes[key] === appliedPromo) : '',
        timestamp: new Date().toISOString()
      };

      // Submit order
      submitOrder(orderData);
    }

    function getUniqueChildren() {
      const uniqueChildren = [...new Set(cart.map(item => item.child))];
      return uniqueChildren.map((childName, index) => {
        const nameParts = childName.split(' ');
        return {
          id: (index + 1).toString(),
          firstName: nameParts[0] || childName,
          lastName: nameParts.slice(1).join(' ') || '',
          grade: 'K-12' // Default grade, could be enhanced
        };
      });
    }

    function getDateForDay(dayName) {
      const today = new Date();
      const currentDay = today.getDay();
      const targetDay = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'].indexOf(dayName);
      
      let daysUntilTarget = targetDay - currentDay;
      if (daysUntilTarget <= 0) {
        daysUntilTarget += 7; // Next week
      }
      
      const targetDate = new Date(today);
      targetDate.setDate(today.getDate() + daysUntilTarget);
      
      return targetDate.toISOString().split('T')[0]; // YYYY-MM-DD format
    }

    function generateOrderId() {
      const timestamp = Date.now();
      const random = Math.floor(Math.random() * 1000);
      return `ORD-${timestamp}-${random}`;
    }

    function submitOrder(orderData) {
      const checkoutBtn = document.getElementById('checkout-btn');
      checkoutBtn.disabled = true;
      checkoutBtn.textContent = 'Placing Order...';
      
      showStatus('Submitting your order...', 'info');

      fetch(GOOGLE_SHEETS_CONFIG.webAppUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(orderData)
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          showStatus(`‚úÖ Order placed successfully! Order ID: ${data.orderId}`, 'success');
          
          // Clear cart
          cart = [];
          updateCartDisplay();
          
          // Show success message with payment instructions
          setTimeout(() => {
            alert(`Order placed successfully!\n\nOrder ID: ${data.orderId}\nTotal: $${orderData.total.toFixed(2)}\n\nPlease send payment via Venmo and include the order ID in the payment note.\n\nYou will receive a confirmation email shortly.`);
          }, 1000);
          
        } else {
          showStatus(`‚ùå Order failed: ${data.error}`, 'error');
        }
      })
      .catch(error => {
        console.error('Order submission error:', error);
        showStatus('‚ùå Network error. Please try again.', 'error');
      })
      .finally(() => {
        checkoutBtn.disabled = false;
        checkoutBtn.textContent = 'Place Order';
      });
    }

    
    function showStatus(message, type) {
      const statusDiv = document.getElementById('status-message');
      statusDiv.textContent = message;
      statusDiv.className = `status-message ${type} show`;

      setTimeout(() => {
        statusDiv.classList.remove('show');
      }, 5000);
    }

    // Make functions available globally
    window.addToCartFromItem = addToCartFromItem;
    window.removeFromCart = removeFromCart;
  </script>
</body>
</html>
