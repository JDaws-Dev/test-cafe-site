<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Artios Cafe ‚Äî Place Order</title>
<style>
  :root{
    --brand:#667eea; --brand2:#764ba2;
    --ok:#10b981; --warn:#f59e0b; --danger:#ef4444;
    --bg:#f8fafc; --panel:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
  .container{max-width:1100px;margin:0 auto;padding:24px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 10px 20px rgba(0,0,0,.04)}
  header.hero{padding:24px 20px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;border-radius:14px;margin-bottom:18px;display:flex;align-items:center;justify-content:space-between;gap:16px}
  .email-pill{background:rgba(255,255,255,.2);padding:8px 12px;border-radius:999px;font-size:.9rem}
  h1{font-size:1.5rem;margin:0}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){ .grid-2{grid-template-columns:1fr 1fr} }
  .section{padding:18px}
  .section h2{margin:0 0 12px 0;font-size:1.15rem}
  label{font-weight:600;font-size:.92rem}
  input[type="text"], select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:1rem}
  .row{display:grid;grid-template-columns:1fr 180px auto;gap:10px}
  .btn{appearance:none;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
  .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff}
  .btn.ghost{background:#fff;border:1px solid var(--border);color:var(--text)}
  .btn.warn{background:var(--warn);color:#111}
  .btn.ok{background:var(--ok);color:#fff}
  .btn.danger{background:var(--danger);color:#fff}
  .child-chip{display:flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#fff}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .muted{color:var(--muted)}
  .banner{display:flex;align-items:flex-start;gap:10px;padding:12px;border-radius:12px;border:1px dashed var(--border);background:#f1f5f9}
  .banner.attn{border-color:#c7d2fe;background:#eef2ff}
  .banner.ok{border-color:#bbf7d0;background:#f0fdf4}
  .menu{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
  .item{border:1px solid var(--border);border-radius:12px;padding:12px;background:#fff;display:flex;flex-direction:column;gap:10px}
  .item h4{margin:0;font-size:1rem}
  .small{font-size:.85rem}
  .dim{opacity:.55}
  .foot{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:8px}
  .switch{display:flex;gap:8px;flex-wrap:wrap}
  .switch label{display:flex;align-items:center;gap:6px;font-weight:500}
  .total{font-weight:800}
  .toast{position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;transform:translateY(10px);transition:.25s}
  .toast.show{opacity:1;transform:translateY(0)}
</style>
</head>
<body>
<div class="container">
  <header class="hero">
    <div>
      <h1>Artios Cafe ‚Äî Place Order</h1>
      <div class="muted">Enter your kids once, then select meals.</div>
    </div>
    <div class="email-pill" id="userEmail">‚Äî</div>
  </header>

  <div class="grid grid-2">
    <!-- LEFT: Children -->
    <div class="card section" id="childrenCard">
      <h2>1) Add your children</h2>
      <div class="banner attn" id="prereqBanner">
        <div>üëâ <strong>Add at least one child <em>with a grade</em></strong> to enable menu selections.</div>
      </div>

      <div class="row" style="margin-top:12px">
        <div>
          <label for="childName">Child name</label>
          <input id="childName" type="text" placeholder="e.g., Ella Rivers" />
        </div>
        <div>
          <label for="childGrade">Grade</label>
          <select id="childGrade">
            <option value="">‚Äî Select ‚Äî</option>
            <option value="K">K</option>
            <option value="1">1</option><option value="2">2</option>
            <option value="3">3</option><option value="4">4</option>
            <option value="5">5</option><option value="6">6</option>
            <option value="7">7</option><option value="8">8</option>
            <option value="9">9</option><option value="10">10</option>
            <option value="11">11</option><option value="12">12</option>
          </select>
        </div>
        <div style="align-self:end">
          <button class="btn primary" id="addChildBtn">Add child</button>
        </div>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
        <button class="btn ghost" id="saveProfilesBtn">üíæ Save profiles</button>
        <button class="btn ghost" id="loadProfilesBtn" disabled>‚Ü©Ô∏è Use saved profiles</button>
        <button class="btn ghost" id="clearProfilesBtn">üóëÔ∏è Clear saved</button>
      </div>

      <div class="chips" id="childChips" style="margin-top:14px"></div>
      <div class="muted small" style="margin-top:8px">Tip: profiles are saved to this browser and tied to your login email.</div>
    </div>

    <!-- RIGHT: Menu -->
    <div class="card section" id="menuCard">
      <h2>2) Select menu items</h2>
      <div class="banner" id="menuLock">
        <div>üîí Menu is locked. Add each child & grade first.</div>
      </div>

      <div class="menu" id="menuList" style="margin-top:12px"></div>
      <div class="foot">
        <div class="muted">Selections are per-child.</div>
        <div class="total">Total: $<span id="total">0.00</span></div>
      </div>
      <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn ok" id="reviewBtn" disabled>Review order</button>
        <button class="btn danger" id="clearBtn">Clear selections</button>
      </div>
    </div>
  </div>

  <!-- Review -->
  <div class="card section" style="margin-top:16px">
    <h2>3) Review & Pay</h2>
    <div id="review"></div>
    <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="submitBtn" disabled>Submit order</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== CONFIG ===== */
const API_URL = 'https://script.google.com/macros/s/AKfycbzgQFKeMYxYAHH8iP2ASjGk8nGS8KNZ4XbC7tqHYG5TQE04YEwmNh-WFEoSBcHkrvZs/exec';

/* ===== STATE ===== */
let state = {
  email: '',
  children: [],         // [{id, name, grade}]
  savedProfiles: [],    // localStorage mirror
  items: [              // sample menu (replace with your live menu if needed)
    { id:'cfa-sand', name:'CFA Sandwich', price:7.00 },
    { id:'cfa-nugs', name:'CFA Nuggets (8ct)', price:7.00 },
    { id:'cfa-spicy', name:'Spicy Sandwich', price:7.50 },
    { id:'chips', name:'Chips', price:1.50 },
    { id:'cookie', name:'Cookie', price:1.50 },
    { id:'drink', name:'Bottled Water', price:1.00 },
  ],
  selections: {},       // itemId -> Set(childId)
};

/* ===== UTIL ===== */
const $ = (id)=>document.getElementById(id);
const fmt = (n)=>Number(n||0).toFixed(2);
const toast = (msg)=>{ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1800); };
const keyForEmail = (email)=>`artios:cafe:profiles:${(email||'').toLowerCase()}`;

/* ===== INIT ===== */
(function init(){
  // load auth email from your session
  const authed = sessionStorage.getItem('authenticatedEmail') || '';
  state.email = authed;
  $('userEmail').textContent = authed || 'Not signed in';

  // load existing saved profiles availability
  refreshSavedButtons();

  // wire events
  $('addChildBtn').addEventListener('click', onAddChild);
  $('saveProfilesBtn').addEventListener('click', onSaveProfiles);
  $('loadProfilesBtn').addEventListener('click', onLoadProfiles);
  $('clearProfilesBtn').addEventListener('click', onClearSaved);
  $('clearBtn').addEventListener('click', clearSelections);
  $('reviewBtn').addEventListener('click', renderReview);
  $('submitBtn').addEventListener('click', submitOrder);

  // render menu
  renderMenu();
  renderChildren();
  applyPrereqLock();
})();

/* ===== CHILDREN ===== */
function onAddChild(){
  const name = $('childName').value.trim();
  const grade = $('childGrade').value.trim();
  if(!name || !grade){ toast('Please enter name and grade'); return; }
  const id = `${Date.now()}-${Math.random().toString(36).slice(2,7)}`;
  state.children.push({ id, name, grade });
  $('childName').value = '';
  $('childGrade').value = '';
  renderChildren();
  renderMenu();          // to add per-child switches
  applyPrereqLock();
}

function removeChild(id){
  state.children = state.children.filter(c=>c.id!==id);
  // also clean any selections for this child
  Object.keys(state.selections).forEach(itemId=>{
    if(state.selections[itemId]) {
      state.selections[itemId].delete(id);
      if(state.selections[itemId].size===0) delete state.selections[itemId];
    }
  });
  renderChildren();
  renderMenu();
  applyPrereqLock();
  updateTotals();
}

function renderChildren(){
  const wrap = $('childChips');
  wrap.innerHTML = '';
  if(!state.children.length){
    wrap.innerHTML = '<div class="muted">No children added yet.</div>';
    $('reviewBtn').disabled = true;
    $('submitBtn').disabled = true;
    return;
  }
  state.children.forEach(c=>{
    const chip = document.createElement('div');
    chip.className='child-chip';
    chip.innerHTML = `
      <strong>${c.name}</strong>
      <span class="muted">Grade ${c.grade}</span>
      <button class="btn ghost" style="padding:4px 8px" aria-label="Remove" title="Remove">‚úï</button>
    `;
    chip.querySelector('button').addEventListener('click', ()=>removeChild(c.id));
    wrap.appendChild(chip);
  });
}

/* ===== SAVED PROFILES (localStorage) ===== */
function refreshSavedButtons(){
  const has = !!localStorage.getItem(keyForEmail(state.email));
  $('loadProfilesBtn').disabled = !has;
}

function onSaveProfiles(){
  if(!state.email){ toast('Please log in first.'); return; }
  if(!state.children.length){ toast('Add at least one child before saving.'); return; }
  localStorage.setItem(keyForEmail(state.email), JSON.stringify(state.children));
  refreshSavedButtons();
  toast('Profiles saved.');
}

function onLoadProfiles(){
  const raw = localStorage.getItem(keyForEmail(state.email));
  if(!raw){ toast('No saved profiles found.'); return; }
  try{
    const arr = JSON.parse(raw);
    if(Array.isArray(arr)){
      state.children = arr.map(c=>({...c, id: c.id || `${Date.now()}-${Math.random().toString(36).slice(2,7)}`}));
      renderChildren();
      renderMenu();
      applyPrereqLock();
      toast('Profiles loaded.');
    }else{
      toast('Saved data corrupted.');
    }
  }catch(e){ toast('Failed to load profiles.'); }
}

function onClearSaved(){
  localStorage.removeItem(keyForEmail(state.email));
  refreshSavedButtons();
  toast('Saved profiles cleared.');
}

/* ===== MENU & SELECTIONS ===== */
function applyPrereqLock(){
  const locked = state.children.length===0;
  $('menuLock').style.display = locked ? 'flex' : 'none';
  $('prereqBanner').classList.toggle('ok', !locked);
  $('reviewBtn').disabled = locked;
  // disable all per-child switches
  document.querySelectorAll('.per-child input[type="checkbox"]').forEach(cb=>{
    cb.disabled = locked;
  });
}

function renderMenu(){
  const host = $('menuList');
  host.innerHTML = '';
  state.items.forEach(item=>{
    const card = document.createElement('div');
    card.className = 'item';
    card.innerHTML = `
      <h4>${item.name}</h4>
      <div class="muted small">$${fmt(item.price)}</div>
      <div class="per-child switch">${renderChildSwitchesHTML(item.id)}</div>
      <div class="foot">
        <span class="muted small">Select which kids get this item.</span>
        <strong>$<span id="sub-${item.id}">0.00</span></strong>
      </div>
    `;
    host.appendChild(card);
  });
  // wire child switches
  state.children.forEach(c=>{
    state.items.forEach(it=>{
      const id = `pick-${it.id}-${c.id}`;
      const el = document.getElementById(id);
      if(el){
        el.checked = !!(state.selections[it.id] && state.selections[it.id].has(c.id));
        el.addEventListener('change', ()=>togglePick(it.id, c.id, it.price));
      }
    });
  });
  // if no children, disable switches
  applyPrereqLock();
  updateTotals();
}

function renderChildSwitchesHTML(itemId){
  if(!state.children.length){
    return `<div class="dim small">No children yet</div>`;
  }
  return state.children.map(c=>{
    const id = `pick-${itemId}-${c.id}`;
    return `
      <label><input id="${id}" type="checkbox" disabled /> ${c.name}</label>
    `;
  }).join('');
}

function togglePick(itemId, childId, price){
  if(!$('reviewBtn').disabled){ $('submitBtn').disabled = false; }
  if(!state.selections[itemId]) state.selections[itemId] = new Set();
  if(state.selections[itemId].has(childId)){
    state.selections[itemId].delete(childId);
    if(state.selections[itemId].size===0) delete state.selections[itemId];
  }else{
    state.selections[itemId].add(childId);
  }
  // update per-item subtotal
  const sub = (state.selections[itemId]? state.selections[itemId].size : 0) * price;
  const el = $('sub-'+itemId);
  if(el) el.textContent = fmt(sub);
  updateTotals();
}

function clearSelections(){
  state.selections = {};
  renderMenu();
  $('submitBtn').disabled = true;
  toast('Selections cleared.');
}

function updateTotals(){
  let total = 0;
  state.items.forEach(it=>{
    const count = state.selections[it.id] ? state.selections[it.id].size : 0;
    total += count * it.price;
  });
  $('total').textContent = fmt(total);
  $('reviewBtn').disabled = (total<=0);
  $('submitBtn').disabled = (total<=0 || state.children.length===0);
}

/* ===== REVIEW & SUBMIT ===== */
function renderReview(){
  const lines = [];
  state.items.forEach(it=>{
    const picks = state.selections[it.id];
    if(picks && picks.size){
      const kids = state.children.filter(c=>picks.has(c.id)).map(c=>`${c.name} (G${c.grade})`);
      lines.push(`<li>${it.name} ‚Äî ${kids.length} √ó $${fmt(it.price)}<br><span class="muted small">${kids.join(', ')}</span></li>`);
    }
  });
  $('review').innerHTML = lines.length ? `<ul>${lines.join('')}</ul>` : '<div class="muted">Nothing selected yet.</div>';
}

async function submitOrder(){
  const itemsPayload = [];
  Object.entries(state.selections).forEach(([itemId, set])=>{
    const item = state.items.find(i=>i.id===itemId);
    if(!item) return;
    [...set].forEach(childId=>{
      const c = state.children.find(x=>x.id===childId);
      if(!c) return;
      // keep payload simple; your backend can adapt
      itemsPayload.push({
        childId,
        childName: c.name,
        grade: c.grade,
        id: item.id,
        name: item.name,
        price: item.price,
      });
    });
  });

  if(!itemsPayload.length){ toast('Select at least one item.'); return; }

  const order = {
    orderId: 'O' + Date.now(),
    parentEmail: state.email || '',
    timestamp: new Date().toISOString(),
    children: state.children.map(c=>({id:c.id, firstName:c.name.split(' ')[0]||c.name, lastName:c.name.split(' ').slice(1).join(' '), grade:c.grade})),
    items: itemsPayload
  };

  try{
    const res = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(order)
    });
    const data = await res.json().catch(()=>({}));
    if(res.ok && data && data.success!==false){
      toast('Order submitted!');
      clearSelections();
      $('review').innerHTML = '';
    }else{
      toast('Submit failed.');
      console.error('Submit error', data);
    }
  }catch(err){
    console.error(err);
    toast('Network error.');
  }
}
</script>
</body>
</html>
