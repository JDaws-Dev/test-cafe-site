<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Artios Academies Cafe - Family Dashboard</title>
  <link rel="icon" type="image/png" href="artios-logo.png">
  <link rel="apple-touch-icon" href="artios-logo.png">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f8f9fa;
      color: #202124;
      line-height: 1.6;
    }

    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 100vh;
    }

    /* Header with Authentication */
    .auth-header {
      background: linear-gradient(135deg, #8B9F3C 0%, #6d7d2f 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .family-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .family-avatar {
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
    }

    .family-details h2 {
      margin: 0;
      font-size: 1.3em;
    }

    .family-details p {
      margin: 5px 0 0 0;
      opacity: 0.9;
      font-size: 0.9em;
    }

    .auth-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Main Dashboard Content */
    .dashboard-content {
      padding: 30px;
    }

    .welcome-section {
      background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
      border: 2px solid #4caf50;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      text-align: center;
    }

    .welcome-title {
      color: #2e7d32;
      font-size: 1.5em;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .welcome-subtitle {
      color: #333;
      margin-bottom: 20px;
    }

    /* Quick Actions Grid */
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .action-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .action-card:hover {
      border-color: #8B9F3C;
      box-shadow: 0 4px 20px rgba(66, 133, 244, 0.1);
      transform: translateY(-2px);
    }

    .action-icon {
      font-size: 3em;
      margin-bottom: 15px;
      display: block;
    }

    .action-title {
      font-size: 1.3em;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }

    .action-desc {
      color: #666;
      margin-bottom: 20px;
      font-size: 0.95em;
    }

    .action-btn {
      background: #8B9F3C;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .action-btn:hover {
      background: #3367d6;
      transform: translateY(-1px);
      text-decoration: none;
      color: white;
    }

    .action-btn.secondary {
      background: #ff9800;
    }

    .action-btn.secondary:hover {
      background: #f57c00;
    }

    .action-btn.success {
      background: #4caf50;
    }

    .action-btn.success:hover {
      background: #43a047;
    }

    /* Recent Orders Summary */
    .recent-orders {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
    }

    .recent-orders h3 {
      color: #8B9F3C;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .orders-loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .orders-summary {
      display: none;
    }

    .order-item {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-details {
      flex: 1;
    }

    .order-id {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .order-date {
      font-size: 0.9em;
      color: #666;
    }

    .order-total {
      text-align: right;
    }

    .order-amount {
      font-size: 1.3em;
      font-weight: 700;
      color: #4caf50;
    }

    .order-status {
      font-size: 0.8em;
      color: #4caf50;
      margin-top: 2px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .auth-header {
        flex-direction: column;
        text-align: center;
      }

      .dashboard-content {
        padding: 20px;
      }

      .quick-actions-grid {
        grid-template-columns: 1fr;
      }

      .family-info {
        flex-direction: column;
        text-align: center;
      }

      .order-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      .order-total {
        text-align: left;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Authenticated Header -->
    <div class="auth-header">
      <div class="family-info">
        <div class="family-avatar" id="family-avatar">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
        <div class="family-details">
          <h2 id="family-greeting">Welcome back!</h2>
          <p id="family-email">Loading...</p>
        </div>
      </div>
      <div class="auth-actions">
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="dashboard-content">
      <!-- Welcome Section -->
      <div class="welcome-section">
        <div class="welcome-title">üçΩÔ∏è Artios Academies Cafe Dashboard</div>
        <p class="welcome-subtitle">
          Manage your family's lunch orders, view history, and place new orders
        </p>
        <div style="font-size: 0.9em; color: #666;">
          Secure family portal ‚Ä¢ Private order history ‚Ä¢ Easy ordering
        </div>
      </div>

      <!-- Add cutoff time notification -->
      <div style="background: #fff3e0; border: 2px solid #f59e0b; border-radius: 12px; padding: 20px; margin: 15px 0; text-align: center;">
        <h4 style="color: #f57c00; margin: 0 0 10px 0;">‚è∞ Important Ordering Information</h4>
        <div style="font-weight: 600; color: #92400e; font-size: 1.1em;">
          Daily Order Cutoff: 10:00 AM
        </div>
        <div style="margin-top: 10px; color: #666; font-size: 0.9em;">
          Orders and cancellations must be placed before 10:00 AM on the day of service
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions-grid">
        <div class="action-card" onclick="goToOrdering()">
          <span class="action-icon">üìù</span>
          <div class="action-title">Place New Order</div>
          <div class="action-desc">Order lunch for your children for this week</div>
          <div class="action-btn">Start Ordering</div>
        </div>

        <div class="action-card" onclick="viewOrderHistory()">
          <span class="action-icon">üìã</span>
          <div class="action-title">Order History</div>
          <div class="action-desc">View all past orders, cancel items, or request refunds</div>
          <div class="action-btn secondary">View Orders</div>
        </div>

        <div class="action-card" onclick="contactSupport()">
          <span class="action-icon">‚ùì</span>
          <div class="action-title">Get Help</div>
          <div class="action-desc">Questions about orders, payments, or menu items</div>
          <div class="action-btn success">Contact Us</div>
        </div>
      </div>

      <!-- Recent Orders Summary -->
      <div class="recent-orders">
        <h3>‚úÖ Recent Order Confirmations</h3>
        <div class="orders-loading" id="orders-loading">
          Loading your recent orders...
        </div>
        <div class="orders-summary" id="orders-summary">
          <!-- Will be populated by JavaScript -->
        </div>
        <div style="text-align: center; margin-top: 15px;">
          <a href="#" onclick="viewOrderHistory()" style="color: #8B9F3C; text-decoration: none; font-weight: 600;">
            View All Orders ‚Üí
          </a>
        </div>
      </div>

      <!-- Footer Info -->
      <div style="text-align: center; color: #666; font-size: 0.9em; padding-top: 20px; border-top: 1px solid #e0e0e0;">
        <p><strong>Artios Academies of Sugar Hill</strong></p>
        <p>Questions? Contact <strong>CRivers@artiosacademies.com</strong></p>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const GOOGLE_SHEETS_CONFIG = {
      webAppUrl: 'https://script.google.com/macros/s/AKfycbzgQFKeMYxYAHH8iP2ASjGk8nGS8KNZ4XbC7tqHYG5TQE04YEwmNh-WFEoSBcHkrvZs/exec',
      useGoogleSheets: true
    };

    let authenticatedEmail = '';

    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication first
      if (!checkAuthentication()) {
        return; // Will redirect to login
      }

      // Initialize dashboard
      initializeDashboard();
      loadRecentOrders();
    });

    function checkAuthentication() {
      authenticatedEmail = sessionStorage.getItem('authenticatedEmail');
      const authExpiry = parseInt(sessionStorage.getItem('authExpiry'));
      
      console.log('Checking dashboard authentication...');
      console.log('Email:', authenticatedEmail);
      console.log('Expiry:', new Date(authExpiry));
      
      if (!authenticatedEmail || !authExpiry || Date.now() >= authExpiry) {
        console.log('‚ùå Authentication failed - redirecting to login');
        redirectToLogin();
        return false;
      }
      
      console.log('‚úÖ Dashboard authentication successful');
      return true;
    }

    function redirectToLogin() {
      sessionStorage.removeItem('authenticatedEmail');
      sessionStorage.removeItem('authExpiry');
      window.location.href = 'login.html';
    }

    function initializeDashboard() {
      // Set family info in header
      document.getElementById('family-email').textContent = authenticatedEmail;
      document.getElementById('family-greeting').textContent = 'Welcome back!';
      
      // Set family avatar initial
      const familyInitial = authenticatedEmail.charAt(0).toUpperCase();
      document.getElementById('family-avatar').textContent = familyInitial;
    }

    function loadRecentOrders() {
      if (!GOOGLE_SHEETS_CONFIG.useGoogleSheets) {
        document.getElementById('orders-loading').style.display = 'none';
        document.getElementById('orders-summary').style.display = 'block';
        document.getElementById('orders-summary').innerHTML = `
          <p style="text-align: center; color: #666; padding: 20px;">
            No recent orders to display.
          </p>
        `;
        return;
      }

      fetch(`${GOOGLE_SHEETS_CONFIG.webAppUrl}?action=lookup_orders&email=${encodeURIComponent(authenticatedEmail)}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('orders-loading').style.display = 'none';
          document.getElementById('orders-summary').style.display = 'block';
          
          if (data.success && data.orders && data.orders.length > 0) {
            // Get the most recent orders (last 5 or so)
            const recentOrders = data.orders
              .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
              .slice(0, 5);
            
            let ordersHtml = '';
            
            recentOrders.forEach(order => {
              const orderDate = new Date(order.timestamp);
              const dateStr = orderDate.toLocaleDateString('en-US', { 
                month: 'short', 
                day: 'numeric',
                year: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
              });
              
              // Count active items
              const activeItems = order.items.filter(item => item.status !== 'cancelled').length;
              const cancelledItems = order.items.filter(item => item.status === 'cancelled').length;
              
              ordersHtml += `
                <div class="order-item">
                  <div class="order-details">
                    <div class="order-id">Order #${order.orderId.slice(-8)}</div>
                    <div class="order-date">
                      ${dateStr} ‚Ä¢ ${activeItems} item${activeItems !== 1 ? 's' : ''}
                      ${cancelledItems > 0 ? ` ‚Ä¢ <span style="color: #ef4444;">${cancelledItems} cancelled</span>` : ''}
                    </div>
                  </div>
                  <div class="order-total">
                    <div class="order-amount">$${order.total.toFixed(2)}</div>
                    <div class="order-status">‚úì Confirmed</div>
                  </div>
                </div>
              `;
            });
            
            document.getElementById('orders-summary').innerHTML = ordersHtml;
          } else {
            document.getElementById('orders-summary').innerHTML = `
              <div style="text-align: center; color: #666; padding: 20px; background: white; border-radius: 8px;">
                <p>No orders found.</p>
                <p style="margin-top: 10px;">
                  <a href="#" onclick="goToOrdering()" style="color: #8B9F3C;">Place your first order ‚Üí</a>
                </p>
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('Error loading recent orders:', error);
          document.getElementById('orders-loading').style.display = 'none';
          document.getElementById('orders-summary').style.display = 'block';
          document.getElementById('orders-summary').innerHTML = `
            <p style="text-align: center; color: #f44336; padding: 20px;">
              Unable to load recent orders. Please try again later.
            </p>
          `;
        });
    }

    function goToOrdering() {
      window.location.href = 'orders.html';
    }

    function viewOrderHistory() {
      window.location.href = 'manage-orders.html';
    }

    function contactSupport() {
      window.open('mailto:CRivers@artiosacademies.com?subject=Cafe Support Request', '_blank');
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        sessionStorage.removeItem('authenticatedEmail');
        sessionStorage.removeItem('authExpiry');
        window.location.href = 'login.html';
      }
    }
  </script>
</body>
</html>
