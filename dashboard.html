<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Artios Academies Cafe - Family Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f8f9fa;
      color: #202124;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      min-height: 100vh;
    }

    /* Header with Authentication */
    .auth-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }

    .family-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .family-avatar {
      width: 50px;
      height: 50px;
      background: rgba(255,255,255,0.2);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 20px;
    }

    .family-details h2 {
      margin: 0;
      font-size: 1.3em;
    }

    .family-details p {
      margin: 5px 0 0 0;
      opacity: 0.9;
      font-size: 0.9em;
    }

    .auth-actions {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .logout-btn {
      background: rgba(255,255,255,0.2);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* Main Dashboard Content */
    .dashboard-content {
      padding: 30px;
    }

    .welcome-section {
      background: linear-gradient(135deg, #e8f5e8 0%, #f1f8e9 100%);
      border: 2px solid #4caf50;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
      text-align: center;
    }

    .welcome-title {
      color: #2e7d32;
      font-size: 1.5em;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .welcome-subtitle {
      color: #333;
      margin-bottom: 20px;
    }

    /* Week Indicator */
    .week-indicator {
      background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
      border: 2px solid #f59e0b;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 30px;
      text-align: center;
      font-weight: 600;
      color: #92400e;
      font-size: 1.1em;
    }

    /* Quick Actions Grid */
    .quick-actions-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }

    .action-card {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .action-card:hover {
      border-color: #4285f4;
      box-shadow: 0 4px 20px rgba(66, 133, 244, 0.1);
      transform: translateY(-2px);
    }

    .action-icon {
      font-size: 3em;
      margin-bottom: 15px;
      display: block;
    }

    .action-title {
      font-size: 1.3em;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }

    .action-desc {
      color: #666;
      margin-bottom: 20px;
      font-size: 0.95em;
    }

    .action-btn {
      background: #4285f4;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      font-size: 16px;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
    }

    .action-btn:hover {
      background: #3367d6;
      transform: translateY(-1px);
      text-decoration: none;
      color: white;
    }

    .action-btn.secondary {
      background: #ff9800;
    }

    .action-btn.secondary:hover {
      background: #f57c00;
    }

    .action-btn.success {
      background: #4caf50;
    }

    .action-btn.success:hover {
      background: #43a047;
    }

    /* Recent Orders Summary */
    .recent-orders {
      background: #f8f9fa;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 25px;
      margin-bottom: 30px;
    }

    .recent-orders h3 {
      color: #4285f4;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .orders-loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }

    .orders-summary {
      display: none;
    }

    .order-day-group {
      margin-bottom: 20px;
      background: white;
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #e0e0e0;
    }

    .order-day-header {
      font-weight: 600;
      color: #4285f4;
      margin-bottom: 10px;
      font-size: 1.1em;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-item {
      background: white;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .order-details {
      flex: 1;
    }

    .order-child {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
    }

    .order-food {
      font-size: 0.9em;
      color: #666;
    }

    .order-price {
      font-weight: 700;
      color: #4caf50;
      font-size: 1em;
    }

    .no-orders-message {
      text-align: center;
      color: #666;
      padding: 20px;
      background: white;
      border-radius: 8px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      .auth-header {
        flex-direction: column;
        text-align: center;
      }

      .dashboard-content {
        padding: 20px;
      }

      .quick-actions-grid {
        grid-template-columns: 1fr;
      }

      .family-info {
        flex-direction: column;
        text-align: center;
      }

      .order-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Authenticated Header -->
    <div class="auth-header">
      <div class="family-info">
        <div class="family-avatar" id="family-avatar">üë®‚Äçüë©‚Äçüëß‚Äçüë¶</div>
        <div class="family-details">
          <h2 id="family-greeting">Welcome back!</h2>
          <p id="family-email">Loading...</p>
        </div>
      </div>
      <div class="auth-actions">
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <div class="dashboard-content">
      <!-- Welcome Section -->
      <div class="welcome-section">
        <div class="welcome-title">üçΩÔ∏è Artios Academies Cafe Dashboard</div>
        <p class="welcome-subtitle">
          Manage your family's lunch orders, view history, and place new orders
        </p>
        <div style="font-size: 0.9em; color: #666;">
          Secure family portal ‚Ä¢ Private order history ‚Ä¢ Easy ordering
        </div>
      </div>

      <!-- Week Indicator -->
      <div class="week-indicator" id="week-indicator">
        Loading week information...
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions-grid">
        <div class="action-card" onclick="goToOrdering()">
          <span class="action-icon">üìù</span>
          <div class="action-title">Place New Order</div>
          <div class="action-desc">Order lunch for your children for next week</div>
          <div class="action-btn">Start Ordering</div>
        </div>

        <div class="action-card" onclick="viewOrderHistory()">
          <span class="action-icon">üìã</span>
          <div class="action-title">Order History</div>
          <div class="action-desc">View all past orders, cancel items, or request refunds</div>
          <div class="action-btn secondary">View Orders</div>
        </div>

        <div class="action-card" onclick="contactSupport()">
          <span class="action-icon">‚ùì</span>
          <div class="action-title">Get Help</div>
          <div class="action-desc">Questions about orders, payments, or menu items</div>
          <div class="action-btn success">Contact Us</div>
        </div>
      </div>

      <!-- Recent Orders Summary -->
      <div class="recent-orders">
        <h3>üìÖ Your Orders for Next Week</h3>
        <div class="orders-loading" id="orders-loading">
          Loading your upcoming orders...
        </div>
        <div class="orders-summary" id="orders-summary">
          <!-- Will be populated by JavaScript -->
        </div>
        <div style="text-align: center; margin-top: 15px;">
          <a href="#" onclick="viewOrderHistory()" style="color: #4285f4; text-decoration: none; font-weight: 600;">
            View All Orders ‚Üí
          </a>
        </div>
      </div>

      <!-- Footer Info -->
      <div style="text-align: center; color: #666; font-size: 0.9em; padding-top: 20px; border-top: 1px solid #e0e0e0;">
        <p><strong>Artios Academies of Sugar Hill</strong></p>
        <p>Questions? Contact <strong>CRivers@artiosacademies.com</strong></p>
      </div>
    </div>
  </div>

  <script>
    // Configuration
    const GOOGLE_SHEETS_CONFIG = {
      webAppUrl: 'https://script.google.com/macros/s/AKfycbzgQFKeMYxYAHH8iP2ASjGk8nGS8KNZ4XbC7tqHYG5TQE04YEwmNh-WFEoSBcHkrvZs/exec',
      useGoogleSheets: true
    };

    let authenticatedEmail = '';

    document.addEventListener('DOMContentLoaded', function() {
      // Check authentication first
      if (!checkAuthentication()) {
        return; // Will redirect to login
      }

      // Initialize dashboard
      initializeDashboard();
      updateWeekIndicator();
      loadNextWeekOrders();
    });

    function checkAuthentication() {
      authenticatedEmail = sessionStorage.getItem('authenticatedEmail');
      const authExpiry = parseInt(sessionStorage.getItem('authExpiry'));
      
      console.log('Checking dashboard authentication...');
      console.log('Email:', authenticatedEmail);
      console.log('Expiry:', new Date(authExpiry));
      
      if (!authenticatedEmail || !authExpiry || Date.now() >= authExpiry) {
        console.log('‚ùå Authentication failed - redirecting to login');
        redirectToLogin();
        return false;
      }
      
      console.log('‚úÖ Dashboard authentication successful');
      return true;
    }

    function redirectToLogin() {
      sessionStorage.removeItem('authenticatedEmail');
      sessionStorage.removeItem('authExpiry');
      window.location.href = 'login.html';
    }

    function initializeDashboard() {
      // Set family info in header
      document.getElementById('family-email').textContent = authenticatedEmail;
      document.getElementById('family-greeting').textContent = 'Welcome back!';
      
      // Set family avatar initial
      const familyInitial = authenticatedEmail.charAt(0).toUpperCase();
      document.getElementById('family-avatar').textContent = familyInitial;
    }

    function getOrderingWeekMonday() {
      const now = new Date();
      const day = now.getDay();
      const hour = now.getHours();
      
      // Create a new date to avoid mutating
      const monday = new Date(now);
      
      // Determine which Monday we're ordering for
      if ((day === 5 && hour >= 9) || day === 6 || day === 0) {
        // After Friday 9 AM or on weekend: get NEXT Monday
        const daysUntilNextMonday = day === 0 ? 1 : (8 - day);
        monday.setDate(monday.getDate() + daysUntilNextMonday);
      } else {
        // Monday-Thursday or Friday before 9 AM: get THIS Monday
        const daysBackToMonday = day === 0 ? -6 : (1 - day);
        monday.setDate(monday.getDate() + daysBackToMonday);
      }
      
      monday.setHours(0, 0, 0, 0);
      return monday;
    }

    function updateWeekIndicator() {
      const monday = getOrderingWeekMonday();
      const friday = new Date(monday);
      friday.setDate(monday.getDate() + 4);
      
      const options = { month: 'short', day: 'numeric' };
      const startStr = monday.toLocaleDateString('en-US', options);
      const endStr = friday.toLocaleDateString('en-US', options);
      
      // Check if it's next week
      const now = new Date();
      const currentWeekMonday = getCurrentWeekMonday(now);
      const isNextWeek = monday > currentWeekMonday;
      
      let message = '';
      if (isNextWeek) {
        message = `üìÖ Orders are now being taken for NEXT WEEK: ${startStr} - ${endStr}`;
      } else {
        message = `üìÖ Orders are being taken for THIS WEEK: ${startStr} - ${endStr}`;
      }
      
      const indicator = document.getElementById('week-indicator');
      if (indicator) {
        indicator.textContent = message;
      }
    }

    function getCurrentWeekMonday(date) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      d.setDate(diff);
      d.setHours(0, 0, 0, 0);
      return d;
    }

    function loadNextWeekOrders() {
      if (!GOOGLE_SHEETS_CONFIG.useGoogleSheets) {
        document.getElementById('orders-loading').style.display = 'none';
        document.getElementById('orders-summary').style.display = 'block';
        document.getElementById('orders-summary').innerHTML = `
          <p style="text-align: center; color: #666; padding: 20px;">
            Recent orders will appear here once orders are placed.
          </p>
        `;
        return;
      }

      // Get the Monday we're ordering for
      const orderingMonday = getOrderingWeekMonday();
      const orderingFriday = new Date(orderingMonday);
      orderingFriday.setDate(orderingMonday.getDate() + 4);

      fetch(`${GOOGLE_SHEETS_CONFIG.webAppUrl}?action=lookup_orders&email=${encodeURIComponent(authenticatedEmail)}`)
        .then(response => response.json())
        .then(data => {
          document.getElementById('orders-loading').style.display = 'none';
          document.getElementById('orders-summary').style.display = 'block';
          
          if (data.success && data.orders && data.orders.length > 0) {
            // Filter orders for the ordering week
            const nextWeekOrders = [];
            
            data.orders.forEach(order => {
              order.items.forEach(item => {
                // Parse the item date
                const itemDateStr = item.date ? item.date.split('T')[0] : '';
                if (!itemDateStr) return;
                
                const itemDate = new Date(itemDateStr + 'T12:00:00');
                
                // Check if this item is in the ordering week
                if (itemDate >= orderingMonday && itemDate <= orderingFriday && item.status !== 'cancelled') {
                  nextWeekOrders.push({
                    ...item,
                    orderId: order.orderId,
                    date: itemDateStr,
                    dayOfWeek: getDayName(itemDate)
                  });
                }
              });
            });

            if (nextWeekOrders.length > 0) {
              displayNextWeekOrders(nextWeekOrders, orderingMonday);
            } else {
              document.getElementById('orders-summary').innerHTML = `
                <div class="no-orders-message">
                  <p>No orders placed yet for next week.</p>
                  <p style="margin-top: 10px;">
                    <a href="#" onclick="goToOrdering()" style="color: #4285f4;">Click here to place an order ‚Üí</a>
                  </p>
                </div>
              `;
            }
          } else {
            document.getElementById('orders-summary').innerHTML = `
              <div class="no-orders-message">
                <p>No orders found. Ready to place your first order?</p>
                <p style="margin-top: 10px;">
                  <a href="#" onclick="goToOrdering()" style="color: #4285f4;">Start ordering ‚Üí</a>
                </p>
              </div>
            `;
          }
        })
        .catch(error => {
          console.error('Error loading recent orders:', error);
          document.getElementById('orders-loading').style.display = 'none';
          document.getElementById('orders-summary').style.display = 'block';
          document.getElementById('orders-summary').innerHTML = `
            <p style="text-align: center; color: #f44336; padding: 20px;">
              Unable to load recent orders. Please try again later.
            </p>
          `;
        });
    }

    function getDayName(date) {
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      return days[date.getDay()];
    }

    function displayNextWeekOrders(orders, orderingMonday) {
      // Group orders by day
      const ordersByDay = {};
      const dayOrder = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
      
      // Initialize all days
      dayOrder.forEach(day => {
        ordersByDay[day] = [];
      });
      
      // Group the orders
      orders.forEach(order => {
        if (ordersByDay[order.dayOfWeek]) {
          ordersByDay[order.dayOfWeek].push(order);
        }
      });
      
      let ordersHtml = '';
      
      dayOrder.forEach((day, index) => {
        const dayDate = new Date(orderingMonday);
        dayDate.setDate(orderingMonday.getDate() + index);
        const dateStr = dayDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        
        const dayOrders = ordersByDay[day];
        
        if (dayOrders.length > 0) {
          let dayTotal = 0;
          let itemsHtml = '';
          
          dayOrders.forEach(order => {
            dayTotal += order.price;
            itemsHtml += `
              <div class="order-item">
                <div class="order-details">
                  <div class="order-child">${order.childName}</div>
                  <div class="order-food">${order.name}</div>
                </div>
                <div class="order-price">$${order.price.toFixed(2)}</div>
              </div>
            `;
          });
          
          ordersHtml += `
            <div class="order-day-group">
              <div class="order-day-header">
                <span>${day}, ${dateStr}</span>
                <span style="color: #4caf50;">$${dayTotal.toFixed(2)}</span>
              </div>
              ${itemsHtml}
            </div>
          `;
        }
      });
      
      if (ordersHtml) {
        document.getElementById('orders-summary').innerHTML = ordersHtml;
      } else {
        document.getElementById('orders-summary').innerHTML = `
          <div class="no-orders-message">
            <p>No orders placed yet for next week.</p>
            <p style="margin-top: 10px;">
              <a href="#" onclick="goToOrdering()" style="color: #4285f4;">Click here to place an order ‚Üí</a>
            </p>
          </div>
        `;
      }
    }

    function goToOrdering() {
      window.location.href = 'orders.html';
    }

    function viewOrderHistory() {
      window.location.href = 'manage-orders.html';
    }

    function contactSupport() {
      window.open('mailto:CRivers@artiosacademies.com?subject=Cafe Support Request', '_blank');
    }

    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        sessionStorage.removeItem('authenticatedEmail');
        sessionStorage.removeItem('authExpiry');
        window.location.href = 'login.html';
      }
    }
  </script>
</body>
</html>
