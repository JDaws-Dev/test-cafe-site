<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Admin Hub - Artios Academies Cafe</title>
    <link rel="icon" type="image/png" href="artios-logo.png">
    <link rel="apple-touch-icon" href="artios-logo.png">
    <style>
        :root {
            /* Artios Brand Colors */
            --artios-green: #8B9F3C;
            --artios-green-dark: #6d7d2f;
            --artios-green-light: #a5b85c;
            --artios-green-pale: #f4f6ed;

            /* Primary gradient using Artios green */
            --primary-gradient: linear-gradient(135deg, #8B9F3C 0%, #6d7d2f 100%);
            --accent-gradient: linear-gradient(135deg, #a5b85c 0%, #8B9F3C 100%);

            /* Semantic gradients */
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --info-gradient: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);

            /* Text colors */
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-on-primary: #ffffff;

            /* Background colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f4f6ed;

            /* Border and shadows */
            --border-color: #e5e7eb;
            --border-accent: #d1d9b0;
            --shadow-sm: 0 1px 3px 0 rgb(0 0 0 / 0.1);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -1px rgb(0 0 0 / 0.06);
            --shadow-lg: 0 10px 25px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.05);

            /* Border radius */
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;

            /* Transitions */
            --transition-fast: 150ms ease-in-out;
            --transition-normal: 250ms ease-in-out;
        }
 
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Google Sans', 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Login Screen */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-gradient);
            padding: 20px;
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            width: 100px;
            height: 100px;
            margin: 0 auto 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--primary-gradient);
            border-radius: 20px;
            padding: 18px;
            box-shadow: 0 8px 25px rgba(139, 159, 60, 0.3);
        }

        .login-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: brightness(0) invert(1);
        }

        .login-title {
            font-size: 2em;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 10px;
        }

        .login-subtitle {
            color: var(--text-secondary);
            margin-bottom: 30px;
        }

        .password-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .password-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .login-btn {
            width: 100%;
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .login-error {
            color: #ef4444;
            margin-top: 15px;
            display: none;
        }

        /* Admin Dashboard */
        .admin-container {
            display: none;
            min-height: 100vh;
            background: var(--bg-secondary);
        }

        .admin-header {
            background: var(--primary-gradient);
            color: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-title h1 {
            font-size: 1.8em;
            font-weight: 700;
        }

        .header-subtitle {
            opacity: 0.9;
            font-size: 0.95em;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        /* Tab Navigation */
        .tab-navigation {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tab-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            overflow-x: auto;
        }

        .tab-btn {
            flex: 1;
            min-width: 150px;
            padding: 18px 24px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .tab-btn.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: var(--bg-secondary);
        }

        .tab-icon {
            font-size: 1.2em;
        }

        /* Tab Content */
        .content-area {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Common Card Styles */
        .card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            margin-bottom: 24px;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .card-title {
            font-size: 1.3em;
            font-weight: 700;
            color: var(--text-primary);
            white-space: nowrap; /* Prevent title wrapping */
        }

        /* Status Messages */
        .status-message {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .status-message.show {
            display: flex;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading-spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Blackout Dates Specific Styles */
        .date-input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .input-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .input-section h4 {
            color: #667eea;
            margin-bottom: 5px;
            font-size: 1.1em;
        }

        .form-input {
            padding: 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .action-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 15px;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        /* Blackout Date List */
        .blackout-date-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .blackout-date-item:hover {
            background: var(--bg-secondary);
            border-color: #667eea;
        }

        .blackout-date-info {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .blackout-date {
            font-weight: 600;
            color: var(--text-primary);
            min-width: 180px;
        }

        .blackout-reason {
            color: var(--text-secondary);
            background: var(--bg-secondary);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
        }

        .remove-blackout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .remove-blackout-btn:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        /* Calendar Styles */
        .calendar-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }

        .month-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .month-navigation button {
            background: white;
            border: 2px solid var(--border-color);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .month-navigation button:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .current-month {
            font-size: 1.2em;
            font-weight: 700;
            color: var(--text-primary);
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* Mon-Fri only */
            gap: 8px;
        }

        .calendar-header {
            padding: 10px;
            text-align: center;
            font-weight: 700;
            color: #667eea;
            font-size: 0.9em;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            min-height: 80px;
            padding: 4px;
        }

        .calendar-day:hover {
            background: var(--bg-secondary);
            border-color: #667eea;
            transform: scale(1.05);
        }

        .calendar-day.weekend {
            background: #f3f4f6;
            color: #9ca3af;
        }

        .calendar-day.past {
            color: #d1d5db;
            cursor: default;
        }

        .calendar-day.today {
            background: #dbeafe;
            border-color: #3b82f6;
            font-weight: 700;
        }

        .calendar-day.blackout {
            background: #fee2e2;
            border-color: #ef4444;
            color: #dc2626;
            font-weight: 700;
        }

        /* Enhanced calendar day content */
        .calendar-day-number {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .calendar-day-reason {
            font-size: 0.65em;
            text-align: center;
            line-height: 1.2;
            opacity: 0.9;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            word-break: break-word;
        }

        .blackout-indicator {
            position: absolute;
            top: 2px;
            right: 4px;
            font-size: 12px;
            color: #ef4444;
            font-weight: bold;
        }

        .empty-day {
            border: none;
            cursor: default;
        }

        /* Tooltip for additional info */
        .calendar-tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.85em;
            white-space: nowrap;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 5px;
        }

        .calendar-tooltip::before {
            content: '';
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-bottom: 4px solid #333;
        }

        .calendar-day:hover .calendar-tooltip {
            opacity: 1;
        }

        /* Legend */
        .calendar-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            border: 2px solid var(--border-color);
        }

        .legend-today {
            background: #dbeafe;
            border-color: #3b82f6;
        }

        .legend-blackout {
            background: #fee2e2;
            border-color: #ef4444;
        }

        .legend-weekend {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        /* Under Construction Placeholder */
        .tab-placeholder { 
            border: 2px dashed #e5e7eb; 
            border-radius: 14px; 
            padding: 60px 24px; 
            text-align: center; 
            background: #fafafa; 
            margin: 16px 0; 
            font-size: 16px; 
            color: #6b7280; 
        }
        
        .tab-placeholder h3 { 
            margin: 0 0 12px 0; 
            font-size: 24px; 
            color: #111827; 
        }
        
        .tab-placeholder .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .tab-placeholder p { 
            margin: 0;
            line-height: 1.6;
        }

        /* Communications Tab Styles */
        .comm-contact-row {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }

        .comm-contact-row:hover {
            border-color: #667eea;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .comm-contact-info {
            flex: 1;
            margin-left: 15px;
        }

        .comm-contact-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 4px;
            font-size: 1.1em;
        }

        .comm-contact-email {
            color: #667eea;
            font-size: 0.95em;
            margin-bottom: 4px;
        }

        .comm-contact-children {
            color: #666;
            font-size: 0.9em;
        }

        .comm-contact-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .comm-contact-actions {
            display: flex;
            gap: 8px;
        }

        .comm-action-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .comm-edit-btn {
            background: #667eea;
            color: white;
        }

        .comm-edit-btn:hover {
            background: #5a67d8;
        }

        .comm-delete-btn {
            background: #ef4444;
            color: white;
        }

        .comm-delete-btn:hover {
            background: #dc2626;
        }

        .comm-select-all-row {
            background: #f7f8fa;
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 12px 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        /* Order Management Styles */
        .om-order-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            margin-bottom: 20px;
            overflow: hidden;
        }

        .om-order-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .om-order-header:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        .om-order-header.expanded {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
        }

        .om-order-info h3 {
            margin: 0 0 8px 0;
            font-size: 1.3em;
            font-weight: 600;
        }

        .om-order-meta {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .om-expand-icon {
            font-size: 1.5em;
            transition: transform 0.3s ease;
        }

        .om-expand-icon.expanded {
            transform: rotate(180deg);
        }

        .om-order-details {
            display: none;
            padding: 0;
        }

        .om-order-details.expanded {
            display: block;
        }

        .om-children-container {
            background: #f8f9fa;
        }

        .om-child-section {
            border-bottom: 1px solid #e9ecef;
            padding: 20px;
        }

        .om-child-section:last-child {
            border-bottom: none;
        }

        .om-child-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .om-child-info h4 {
            margin: 0;
            color: #2d3748;
            font-size: 1.2em;
        }

        .om-child-grade {
            color: #666;
            font-size: 0.9em;
            margin-top: 2px;
        }

        .om-items-grid {
            display: grid;
            gap: 10px;
        }

        .om-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s ease;
        }

        .om-item:hover {
            border-color: #cbd5e0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .om-item-info {
            flex: 1;
        }

        .om-item-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .om-item-details {
            font-size: 0.9em;
            color: #666;
        }

        .om-item-price {
            font-weight: 600;
            color: #38a169;
            margin-right: 15px;
        }

        .om-item-price.discounted {
            color: #f56565;
        }

        .om-original-price {
            text-decoration: line-through;
            color: #999;
            font-size: 0.9em;
            margin-right: 8px;
        }

        .om-discount-badge {
            background: #fed7d7;
            color: #c53030;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.75em;
            margin-left: 8px;
        }

        .om-item-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
            text-transform: uppercase;
            margin-left: 10px;
        }

        .om-status-active {
            background: #c6f6d5;
            color: #22543d;
        }

        .om-status-cancelled {
            background: #fed7d7;
            color: #c53030;
        }

        .om-item-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .om-cancel-item {
            background: #f56565;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background 0.2s ease;
        }

        .om-cancel-item:hover {
            background: #e53e3e;
        }

        .om-cancel-item:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
        }

        .om-cancel-item:disabled:hover {
            background: #e2e8f0;
        }

        .om-order-totals {
            background: #edf2f7;
            padding: 20px;
            border-top: 1px solid #e2e8f0;
        }

        .om-totals-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .om-totals-row.final {
            font-weight: 600;
            font-size: 1.1em;
            border-top: 1px solid #cbd5e0;
            padding-top: 8px;
            margin-top: 8px;
        }

        .om-order-actions {
            padding: 15px 20px;
            background: #f7fafc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .om-bulk-cancel {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
        }

        .om-bulk-cancel:hover {
            background: #c53030;
        }

        .om-cancelled-order {
            opacity: 0.7;
        }

        .om-cancelled-order .om-order-header {
            background: linear-gradient(135deg, #e53e3e 0%, #c53030 100%);
        }

        .om-badge {
            background: #e53e3e;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 10px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .date-input-group {
                grid-template-columns: 1fr;
            }

            .calendar-container {
                padding: 10px;
                margin: 0 -10px; /* Extend to edges */
            }

            .calendar-grid {
                gap: 4px; /* Smaller gap on mobile */
            }

            .calendar-day {
                font-size: 0.75em;
                min-height: 50px;
                padding: 2px;
            }

            .calendar-day-number {
                font-size: 0.9em;
            }

            .calendar-day-reason {
                font-size: 0.5em;
                -webkit-line-clamp: 1;
            }

            .calendar-header {
                font-size: 0.7em;
                padding: 5px 2px;
            }

            .blackout-date-info {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }

            .blackout-date {
                min-width: auto;
            }

            .calendar-legend {
                gap: 10px;
            }

            .legend-item {
                font-size: 0.8em;
            }

            /* Mobile-friendly tabs */
            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                gap: 4px;
            }

            .tab-btn {
                flex: 1;
                min-width: 60px;
                max-width: 80px;
                font-size: 0.7em;
                padding: 10px 8px;
                flex-direction: column;
                gap: 4px;
            }

            .tab-btn span:not(.tab-icon) {
                display: none; /* Hide text labels on mobile */
            }

            .tab-icon {
                font-size: 1.5em;
            }

            /* Mobile-friendly header */
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .header-actions {
                width: 100%;
                justify-content: space-between;
            }

            /* Card adjustments */
            .card {
                margin: 10px;
            }

            .card-title {
                font-size: 1em; /* Smaller title on mobile */
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .card-header {
                flex-wrap: nowrap; /* Keep header content on one line */
                gap: 8px;
            }

            /* Financials tab mobile fixes */
            #financials .card > div[style*="padding"] {
                padding: 15px !important;
            }

            /* Fix two-column grid to single column on mobile */
            #financials > div[style*="grid-template-columns: 1fr 1fr"] {
                display: block !important;
            }

            #financials > div[style*="grid-template-columns: 1fr 1fr"] > .card {
                margin-bottom: 20px;
            }

            /* Make sure text doesn't overflow in discount/customer cards */
            #financials .card div[style*="display: flex"] {
                flex-wrap: wrap;
                gap: 5px;
            }

            /* Better spacing for discount breakdown */
            #fin-discount-breakdown > div {
                font-size: 0.85em !important;
            }

            /* Payments tab mobile */
            #payments-tab .card {
                overflow-x: auto;
            }

            #payments-tab table {
                min-width: 600px;
            }

            #payments-tab input[type="text"],
            #payments-tab select,
            #payments-tab input[type="month"] {
                width: 100% !important;
                max-width: none;
            }

            /* Larger touch targets */
            input[type="checkbox"] {
                width: 20px;
                height: 20px;
                cursor: pointer;
            }

            .action-btn {
                padding: 12px 20px;
                font-size: 1em;
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-container" id="login-screen">
        <div class="login-box">
            <div class="login-logo">
                <img src="artios-logo.png" alt="Artios Academies Logo">
            </div>
            <h1 class="login-title">Admin Portal</h1>
            <p class="login-subtitle">Artios Academies Cafe Management</p>
            
            <input type="password" 
                   class="password-input" 
                   id="password-input" 
                   placeholder="Enter admin password"
                   autocomplete="off">
            
            <button class="login-btn" onclick="attemptLogin()">
                Access Admin Portal
            </button>
            
            <div class="login-error" id="login-error">
                Incorrect password. Please try again.
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div class="admin-container" id="admin-dashboard">
        <!-- Header -->
        <div class="admin-header">
            <div class="header-content">
                <div class="header-title">
                    <div>
                        <h1>Artios Cafe Admin Hub</h1>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="user-badge">👤 Administrator</div>
                    <button class="logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <div class="tab-container">
                <button class="tab-btn active" onclick="switchTab('blackout-dates')" data-tab="blackout-dates">
                    <span class="tab-icon">📅</span>
                    <span>Blackout Dates</span>
                </button>
                <button class="tab-btn" onclick="switchTab('order-management')" data-tab="order-management">
                    <span class="tab-icon">💳</span>
                    <span>Order Management</span>
                </button>
                <button class="tab-btn" onclick="switchTab('financials')" data-tab="financials">
                    <span class="tab-icon">📊</span>
                    <span>Financials</span>
                </button>
                <button class="tab-btn" onclick="switchTab('communications')" data-tab="communications">
                    <span class="tab-icon">📧</span>
                    <span>Communications</span>
                </button>

                <button class="tab-btn" onclick="switchTab('payments')" data-tab="payments">
                    <span class="tab-icon">💰</span>
                    <span>Payments</span>
                </button>

            </div>
        </div>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Status Messages -->
            <div id="status-message" class="status-message"></div>

            <!-- Tab 1: Blackout Dates -->
            <div class="tab-content active" id="blackout-dates">
                <!-- Add Blackout Dates Card -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">📅 Add Blackout Dates</h2>
                    </div>
                    
                    <div class="date-input-group">
                        <!-- Single Date -->
                        <div class="input-section">
                            <h4>Single Date</h4>
                            <input type="date" 
                                   id="single-blackout-date" 
                                   class="form-input">
                            <input type="text" 
                                   id="single-blackout-reason" 
                                   class="form-input"
                                   placeholder="Reason (e.g., Teacher Workday)">
                            <button onclick="addSingleBlackoutDate()" 
                                    class="action-btn btn-primary">
                                Add Single Date
                            </button>
                        </div>

                        <!-- Date Range -->
                        <div class="input-section">
                            <h4>Date Range (Vacation Periods)</h4>
                            <input type="date" 
                                   id="range-start-date" 
                                   class="form-input"
                                   placeholder="Start Date">
                            <input type="date" 
                                   id="range-end-date" 
                                   class="form-input"
                                   placeholder="End Date">
                            <input type="text" 
                                   id="range-blackout-reason" 
                                   class="form-input"
                                   placeholder="Reason (e.g., Spring Break)">
                            <button onclick="addRangeBlackoutDates()" 
                                    class="action-btn btn-warning">
                                Add Date Range
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Calendar View Card -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">📆 Calendar View</h2>
                    </div>
                    <div class="calendar-container">
                        <div class="month-navigation">
                            <button onclick="changeMonth(-1)">← Previous</button>
                            <span class="current-month" id="current-month-display"></span>
                            <button onclick="changeMonth(1)">Next →</button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Calendar will be generated here -->
                        </div>
                        <div class="calendar-legend">
                            <div class="legend-item">
                                <div class="legend-color legend-today"></div>
                                <span>Today</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color legend-blackout"></div>
                                <span>Blackout Date</span>
                            </div>
                            <div class="legend-item">
                                <div class="legend-color legend-weekend"></div>
                                <span>Weekend</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Current Blackout Dates List -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">📋 Current Blackout Dates</h2>
                        <button onclick="loadBlackoutDates()" 
                                class="action-btn btn-success">
                            🔄 Refresh
                        </button>
                    </div>
                    
                    <div id="blackout-dates-list">
                        <div class="loading">
                            <span class="loading-spinner"></span>
                            Loading blackout dates...
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Order Management -->
            <div class="tab-content" id="order-management">
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">📋 Order Management</h2>
                        <button onclick="OM.refresh()" class="action-btn btn-success">
                            🔄 Refresh Orders
                        </button>
                    </div>
                    
                    <!-- Controls -->
                    <div style="padding: 20px; border-bottom: 1px solid #e9ecef;">
                        <div style="display: flex; gap: 20px; align-items: flex-end; flex-wrap: wrap;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666;">Search By:</label>
                                <select id="search-type" onchange="OM.updateSearchPlaceholder()"
                                        style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 150px;">
                                    <option value="email">Email</option>
                                    <option value="student">Student Name</option>
                                </select>
                            </div>

                            <div style="flex: 1; min-width: 250px;">
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666;">Search:</label>
                                <input type="text" id="search-input" placeholder="Enter family email..."
                                       style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 100%;"
                                       onkeypress="if(event.key==='Enter') OM.search()">
                            </div>

                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666;">Sort By:</label>
                                <select id="sort-orders" onchange="OM.sortAndDisplay()"
                                        style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="date">Date (Newest First)</option>
                                    <option value="family">Family Name (A-Z)</option>
                                </select>
                            </div>

                            <button onclick="OM.search()" class="action-btn btn-primary">
                                🔍 Search Orders
                            </button>
                        </div>
                        
                        <!-- Stats -->
                        <div style="display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap;">
                            <span style="padding: 5px 15px; background: #e3f2fd; border-radius: 20px; font-size: 0.9em;">
                                Total Orders: <strong id="total-count">0</strong>
                            </span>
                            <span style="padding: 5px 15px; background: #ffebee; border-radius: 20px; font-size: 0.9em;">
                                Cancelled: <strong id="cancel-count">0</strong>
                            </span>
                            <span style="padding: 5px 15px; background: #e8f5e8; border-radius: 20px; font-size: 0.9em;">
                                Total Items: <strong id="item-count">0</strong>
                            </span>
                        </div>
                    </div>
                    
                    <!-- Orders Display -->
                    <div style="padding: 20px;">
                        <div id="order-display" style="max-height: 700px; overflow-y: auto;">
                            <div style="text-align: center; padding: 40px; color: #999;">
                                Enter an email address or student name and click "Search Orders" to begin
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Financials -->
            <div class="tab-content" id="financials">
                <!-- Financial Summary Cards -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px;">
                    <!-- Revenue Card -->
                    <div class="card" style="background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%); color: white;">
                        <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="margin: 0; font-size: 0.9em; opacity: 0.9;">💰 Total Revenue</h3>
                        </div>
                        <div style="padding: 20px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="fin-total-revenue">$0.00</div>
                            <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;" id="fin-revenue-period">All Time</div>
                        </div>
                    </div>

                    <!-- Refunds Card -->
                    <div class="card" style="background: linear-gradient(135deg, #f44336 0%, #e57373 100%); color: white;">
                        <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="margin: 0; font-size: 0.9em; opacity: 0.9;">💸 Total Refunds</h3>
                        </div>
                        <div style="padding: 20px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="fin-total-refunds">$0.00</div>
                            <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;" id="fin-refund-count">0 items</div>
                        </div>
                    </div>

                    <!-- Net Revenue Card -->
                    <div class="card" style="background: linear-gradient(135deg, #2196f3 0%, #64b5f6 100%); color: white;">
                        <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="margin: 0; font-size: 0.9em; opacity: 0.9;">📈 Net Revenue</h3>
                        </div>
                        <div style="padding: 20px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="fin-net-revenue">$0.00</div>
                            <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;" id="fin-net-margin">0% margin</div>
                        </div>
                    </div>

                    <!-- Average Order Value Card -->
                    <div class="card" style="background: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%); color: white;">
                        <div class="card-header" style="border-bottom: 1px solid rgba(255,255,255,0.2);">
                            <h3 style="margin: 0; font-size: 0.9em; opacity: 0.9;">🎯 Avg Order Value</h3>
                        </div>
                        <div style="padding: 20px; text-align: center;">
                            <div style="font-size: 2.5em; font-weight: bold;" id="fin-avg-order">$0.00</div>
                            <div style="font-size: 0.85em; opacity: 0.9; margin-top: 5px;" id="fin-total-orders">0 orders</div>
                        </div>
                    </div>
                </div>

                <!-- Date Range Filter -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h2 class="card-title">📅 Date Range</h2>
                    </div>
                    <div style="padding: 20px;">
                        <!-- Quick Date Buttons -->
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 0.9em; color: #666; font-weight: 600;">Quick Select:</label>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                                <button onclick="FIN.setThisMonth()" class="action-btn" style="background: var(--artios-green); color: white;">This Month</button>
                                <button onclick="FIN.setLastMonth()" class="action-btn" style="background: var(--artios-green); color: white;">Last Month</button>
                                <button onclick="FIN.setYearToDate()" class="action-btn" style="background: var(--artios-green); color: white;">Year to Date</button>
                                <button onclick="FIN.setSchoolYear()" class="action-btn" style="background: var(--artios-green); color: white;">School Year</button>
                            </div>
                        </div>

                        <!-- Date Inputs -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666; font-weight: 600;">Start Date:</label>
                                <input type="date" id="fin-start-date" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666; font-weight: 600;">End Date:</label>
                                <input type="date" id="fin-end-date" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666; font-weight: 600;">Export Type:</label>
                                <select id="export-type" style="padding: 10px; border: 1px solid #ddd; border-radius: 6px; width: 100%;">
                                    <option value="full">Full Report</option>
                                    <option value="summary">Summary Only</option>
                                    <option value="orders">Orders Detail</option>
                                    <option value="students">Student Breakdown</option>
                                </select>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-start;">
                            <button onclick="FIN.loadFinancials()" class="action-btn btn-primary">📊 Generate Report</button>
                            <button onclick="FIN.clearDates()" class="action-btn" style="background: #e5e7eb; color: #374151; border: 1px solid #d1d5db;">Clear Dates</button>
                            <button onclick="FIN.exportData()" class="action-btn" style="background: #4caf50;">📥 Download CSV</button>
                        </div>
                    </div>
                </div>

                <!-- Revenue Reconciliation Card (Full Width) -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h2 class="card-title">💵 Revenue Reconciliation</h2>
                    </div>
                    <div style="padding: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1em;">
                                <span style="font-weight: 500;">Original Menu Prices (before discounts):</span>
                                <span style="font-weight: 600;" id="fin-original-subtotal">$0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95em; color: #dc3545; padding-left: 20px;">
                                <span>− Combo Meal Discounts:</span>
                                <span id="fin-combo-discount-display">$0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95em; color: #dc3545; padding-left: 20px;">
                                <span>− Promo Code Discounts:</span>
                                <span id="fin-promo-discount-display">$0.00</span>
                            </div>
                            <div style="height: 1px; background: #dee2e6; margin: 12px 0;"></div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 1em;">
                                <span style="font-weight: 600;">= Gross Revenue (at checkout):</span>
                                <span style="font-weight: 700;" id="fin-gross-revenue">$0.00</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95em; color: #f44336; padding-left: 20px;">
                                <span>− Refunds (cancelled items):</span>
                                <span id="fin-refunds-display">$0.00</span>
                            </div>
                            <div style="height: 2px; background: #4caf50; margin: 12px 0;"></div>
                            <div style="display: flex; justify-content: space-between; font-size: 1.2em;">
                                <span style="font-weight: 700;">NET REVENUE (Actual $ in Hand):</span>
                                <span style="font-weight: 700; color: #4caf50;" id="fin-net-display">$0.00</span>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 12px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px; font-size: 0.9em;">
                            <strong>💡 For Financial Records:</strong><br>
                            • <strong>Gross Revenue</strong> = Total charged at checkout (before cancellations)<br>
                            • <strong>Net Revenue</strong> = Actual money you keep (after refunds)<br>
                            • Use <strong>Net Revenue</strong> for bank reconciliation and accounting
                        </div>
                    </div>
                </div>

                <!-- Two Column Layout -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <!-- Discount Summary Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">🎟️ Discounts Applied</h2>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 15px; padding: 10px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 4px; font-size: 0.85em;">
                                <strong>Note:</strong> Only includes discounts on active items (excludes refunded items)
                            </div>
                            <div style="margin-bottom: 20px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                    <span style="font-weight: 600;">Total Discounts:</span>
                                    <span style="font-size: 1.2em; color: #f44336; font-weight: bold;" id="fin-total-discounts">$0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 0.9em; color: #666;">
                                    <span>Orders with Discounts:</span>
                                    <span id="fin-discount-orders">0</span>
                                </div>
                            </div>
                            <div id="fin-discount-breakdown" style="font-size: 0.9em;">
                                <!-- Discount breakdown will go here -->
                            </div>
                        </div>
                    </div>

                    <!-- Customer Stats Card -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">👥 Customer Analytics</h2>
                        </div>
                        <div style="padding: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e9ecef;">
                                <span style="font-weight: 600;">Total Families:</span>
                                <span style="font-size: 1.2em; font-weight: bold; color: #2196f3;" id="fin-total-families">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95em;">
                                <span>New Customers:</span>
                                <span id="fin-new-customers">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95em;">
                                <span>Repeat Customers:</span>
                                <span id="fin-repeat-customers">0</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.95em;">
                                <span>Avg Orders per Family:</span>
                                <span id="fin-avg-orders-family">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Customers Table -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h2 class="card-title">🏆 Top Families by Revenue</h2>
                    </div>
                    <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">#</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Family Email</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Orders</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Items</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600;">Total Revenue</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600;">Avg Order</th>
                                </tr>
                            </thead>
                            <tbody id="fin-top-customers">
                                <tr>
                                    <td colspan="6" style="padding: 40px; text-align: center; color: #999;">
                                        Click "Generate Report" to load financial data
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Item Sales Analysis -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">🍽️ Popular Menu Items</h2>
                    </div>
                    <div style="padding: 20px; max-height: 500px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Rank</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Item Name</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Quantity Sold</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600;">Revenue</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600;">% of Total</th>
                                </tr>
                            </thead>
                            <tbody id="fin-popular-items">
                                <tr>
                                    <td colspan="5" style="padding: 40px; text-align: center; color: #999;">
                                        Click "Generate Report" to load item sales data
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Tab 4: Communications -->
            <div class="tab-content" id="communications">
                <!-- Family Contact List -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h2 class="card-title">📧 Communications Center</h2>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                            <button onclick="COMM.loadFamilies()" class="action-btn btn-primary">🔄 Load Families</button>
                            <button onclick="COMM.showBulkEmail()" class="action-btn" style="background: #ff9800;">✉️ Send Bulk Email</button>
                            <button onclick="COMM.exportContacts()" class="action-btn" style="background: #4caf50;">📥 Export All Contacts</button>
                            <button onclick="COMM.exportSelected()" class="action-btn" style="background: #2196f3;">📥 Export Selected</button>
                        </div>
                    </div>
                </div>

                <!-- Filters & Search -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h2 class="card-title">🔍 Filter & Search</h2>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666;">Search:</label>
                                <input type="text" id="comm-search" placeholder="Search by name or email..."
                                       style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 250px;"
                                       oninput="COMM.filterFamilies()">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666;">Activity Filter:</label>
                                <select id="comm-activity-filter" onchange="COMM.filterFamilies()"
                                        style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="all">All Families</option>
                                    <option value="active">Active (Last 30 days)</option>
                                    <option value="recent">Recent (Last 60 days)</option>
                                    <option value="inactive">Inactive (60+ days)</option>
                                    <option value="hasAccount">Has Account</option>
                                    <option value="noAccount">No Account</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666;">Grade Filter:</label>
                                <select id="comm-grade-filter" onchange="COMM.filterFamilies()"
                                        style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="all">All Grades</option>
                                </select>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666;">Sort By:</label>
                                <select id="comm-sort" onchange="COMM.sortFamilies()"
                                        style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="lastName">Last Name (A-Z)</option>
                                    <option value="email">Email (A-Z)</option>
                                    <option value="lastOrder">Last Order Date</option>
                                    <option value="totalOrders">Total Orders</option>
                                    <option value="totalSpent">Total Spent</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 6px;">
                            <span id="comm-filter-results">0 families loaded</span>
                        </div>
                    </div>
                </div>

                <!-- Family List Table -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">👥 Family Contact List</h2>
                    </div>
                    <div style="padding: 20px; max-height: 600px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6; position: sticky; top: 0;">
                                    <th style="padding: 12px;">
                                        <input type="checkbox" id="comm-select-all" onchange="COMM.toggleSelectAll()">
                                    </th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Last Name</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Family Email</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Has Account</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Students</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Total Orders</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600;">Total Spent</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Last Order</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Status</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="comm-family-list">
                                <tr>
                                    <td colspan="10" style="padding: 40px; text-align: center; color: #999;">
                                        Click "Load Families" to populate the contact list
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bulk Email Modal -->
            <div id="bulk-email-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 10000; padding: 20px; overflow-y: auto;">
                <div style="max-width: 800px; margin: 50px auto; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                    <div style="background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                        <h2 style="margin: 0;">📧 Send Bulk Email</h2>
                    </div>
                    <div style="padding: 30px;">
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Recipients:</label>
                            <div id="bulk-email-recipients" style="padding: 15px; background: #f8f9fa; border-radius: 6px; max-height: 150px; overflow-y: auto;">
                                <span style="color: #666;">No families selected</span>
                            </div>
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Subject:</label>
                            <input type="text" id="bulk-email-subject" placeholder="Email subject..."
                                   style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em;">
                        </div>

                        <div style="margin-bottom: 20px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600;">Message:</label>
                            <textarea id="bulk-email-message" rows="10" placeholder="Type your message here..."
                                      style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1em; font-family: inherit; resize: vertical;"></textarea>
                            <div style="margin-top: 5px; font-size: 0.85em; color: #666;">
                                Tip: Use {FAMILY_NAME} to personalize emails
                            </div>
                        </div>

                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="COMM.closeBulkEmail()" class="action-btn" style="background: #6c757d;">Cancel</button>
                            <button onclick="COMM.sendBulkEmail()" class="action-btn btn-primary">Send Email</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Email Templates Modal -->

            <!-- Tab 5: Payments / Venmo Reconciliation -->
            <div class="tab-content" id="payments">
                <!-- Header Card -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h1 class="card-title">💰 Venmo Reconciliation</h1>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;">
                            <button onclick="PAYMENTS.loadOrders()" class="action-btn btn-primary">🔄 Load Orders</button>
                            <button onclick="PAYMENTS.exportUnpaidList()" class="action-btn" style="background: #ff9800;">📥 Export Unpaid List</button>
                        </div>
                    </div>
                </div>

                <!-- Filters & Summary -->
                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-header">
                        <h2 class="card-title">🔍 Filter & Summary</h2>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666;">Month:</label>
                                <input type="month" id="payment-month-filter"
                                       style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;"
                                       onchange="PAYMENTS.filterOrders()">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666;">Payment Status:</label>
                                <div style="display: flex; gap: 10px;">
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="radio" name="payment-filter" value="unpaid" checked onchange="PAYMENTS.filterOrders()">
                                        <span>Unpaid Only</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="radio" name="payment-filter" value="all" onchange="PAYMENTS.filterOrders()">
                                        <span>All</span>
                                    </label>
                                    <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
                                        <input type="radio" name="payment-filter" value="paid" onchange="PAYMENTS.filterOrders()">
                                        <span>Paid Only</span>
                                    </label>
                                </div>
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666;">Search:</label>
                                <input type="text" id="payment-search" placeholder="Search by name or email..."
                                       style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 250px;"
                                       oninput="PAYMENTS.filterOrders()">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; color: #666;">Sort By:</label>
                                <select id="payment-sort" onchange="PAYMENTS.sortOrders()"
                                        style="padding: 8px; border: 1px solid #ddd; border-radius: 6px;">
                                    <option value="lastName">Last Name (A-Z)</option>
                                    <option value="orderDateNewest">Order Date (Newest First)</option>
                                    <option value="orderDateOldest">Order Date (Oldest First)</option>
                                    <option value="amountHigh">Amount (Highest First)</option>
                                    <option value="amountLow">Amount (Lowest First)</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 6px; display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                            <span id="payment-filter-results" style="font-weight: 600;">0 orders loaded</span>
                            <span id="payment-unpaid-summary" style="color: #d32f2f; font-weight: 600;">$0.00 unpaid</span>
                        </div>
                    </div>
                </div>

                <!-- Orders Table -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">💳 Orders List</h2>
                    </div>
                    <div style="padding: 20px; max-height: 700px; overflow-y: auto;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6; position: sticky; top: 0;">
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Paid?</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Last Name</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Parent Email</th>
                                    <th style="padding: 12px; text-align: left; font-weight: 600;">Order ID</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Order Date</th>
                                    <th style="padding: 12px; text-align: right; font-weight: 600;">Amount</th>
                                    <th style="padding: 12px; text-align: center; font-weight: 600;">Items</th>
                                </tr>
                            </thead>
                            <tbody id="payment-orders-list">
                                <tr>
                                    <td colspan="7" style="padding: 40px; text-align: center; color: #999;">
                                        Click "Load Orders" to populate the list
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>


    <script>
        // Configuration
        const ADMIN_PASSWORD = 'admin2025';
        const API_URL = 'https://script.google.com/macros/s/AKfycbzgQFKeMYxYAHH8iP2ASjGk8nGS8KNZ4XbC7tqHYG5TQE04YEwmNh-WFEoSBcHkrvZs/exec';

        // State
        let isAuthenticated = false;
        let currentTab = 'blackout-dates';
        let blackoutDates = [];
        let currentCalendarMonth = new Date();

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Check if already authenticated (session storage)
            const authStatus = sessionStorage.getItem('admin_authenticated');
            if (authStatus === 'true') {
                showAdminDashboard();
            }

            // Setup enter key for password field
            document.getElementById('password-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    attemptLogin();
                }
            });
        });

        // Authentication
        function attemptLogin() {
            const password = document.getElementById('password-input').value;
            
            if (password === ADMIN_PASSWORD) {
                isAuthenticated = true;
                sessionStorage.setItem('admin_authenticated', 'true');
                showAdminDashboard();
            } else {
                document.getElementById('login-error').style.display = 'block';
                document.getElementById('password-input').value = '';
                
                // Hide error after 3 seconds
                setTimeout(() => {
                    document.getElementById('login-error').style.display = 'none';
                }, 3000);
            }
        }

        function showAdminDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('admin-dashboard').style.display = 'block';
            
            // Properly initialize the first tab
            switchTab(currentTab);
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                isAuthenticated = false;
                sessionStorage.removeItem('admin_authenticated');
                document.getElementById('login-screen').style.display = 'flex';
                document.getElementById('admin-dashboard').style.display = 'none';
                document.getElementById('password-input').value = '';
            }
        }

        // Tab Management
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabName);
            });

            currentTab = tabName;
            
            // Load data for the selected tab
            loadTabData(tabName);
        }

        function loadTabData(tabName) {
            console.log(`Loading data for tab: ${tabName}`);

            if (tabName === 'blackout-dates') {
                loadBlackoutDates();
                generateCalendar();
            }
            // Communications tab loads on-demand when user clicks Load Families button
        }

        // ==========================================
        // BLACKOUT DATES FUNCTIONALITY
        // ==========================================

        async function loadBlackoutDates() {
            document.getElementById('blackout-dates-list').innerHTML = `
                <div class="loading">
                    <span class="loading-spinner"></span>
                    Loading blackout dates...
                </div>
            `;

            try {
                const response = await apiCall('get_blackout_dates');
                
                if (response.success) {
                    blackoutDates = response.blackoutDates || [];
                    displayBlackoutDates();
                    generateCalendar(); // Refresh calendar
                } else {
                    throw new Error(response.error || 'Failed to load blackout dates');
                }
            } catch (error) {
                console.error('Error loading blackout dates:', error);
                document.getElementById('blackout-dates-list').innerHTML = `
                    <div style="color: #ef4444; text-align: center; padding: 20px;">
                        Failed to load blackout dates. Please try again.
                    </div>
                `;
            }
        }

        function displayBlackoutDates() {
            const container = document.getElementById('blackout-dates-list');
            
            if (blackoutDates.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 40px;">
                        No blackout dates configured
                    </div>
                `;
                return;
            }

            // Sort dates chronologically
            blackoutDates.sort((a, b) => new Date(a.date) - new Date(b.date));

            // Group by month for better organization
            const groupedDates = {};
            blackoutDates.forEach(item => {
                const date = new Date(item.date + 'T12:00:00');
                const monthKey = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                if (!groupedDates[monthKey]) {
                    groupedDates[monthKey] = [];
                }
                groupedDates[monthKey].push(item);
            });

            let html = '';
            Object.keys(groupedDates).forEach(month => {
                html += `<div style="margin-bottom: 20px;">
                    <h4 style="color: #667eea; margin-bottom: 10px; font-size: 1.1em;">${month}</h4>`;
                
                groupedDates[month].forEach(item => {
                    const date = new Date(item.date + 'T12:00:00');
                    const dateStr = date.toLocaleDateString('en-US', {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric'
                    });

                    html += `
                        <div class="blackout-date-item">
                            <div class="blackout-date-info">
                                <span class="blackout-date">${dateStr}</span>
                                <span class="blackout-reason">${item.reason || 'No reason specified'}</span>
                            </div>
                            <button class="remove-blackout-btn" onclick="removeBlackoutDate('${item.date}')">
                                Remove
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
            });

            container.innerHTML = html;
        }

        async function addSingleBlackoutDate() {
            const date = document.getElementById('single-blackout-date').value;
            const reason = document.getElementById('single-blackout-reason').value || 'School Closed';

            if (!date) {
                showMessage('Please select a date', 'error');
                return;
            }

            try {
                const response = await apiCall('add_blackout_date', {
                    date: date,
                    reason: reason
                });

                if (response.success) {
                    showMessage('Blackout date added successfully', 'success');
                    document.getElementById('single-blackout-date').value = '';
                    document.getElementById('single-blackout-reason').value = '';
                    loadBlackoutDates();
                } else {
                    throw new Error(response.error || 'Failed to add blackout date');
                }
            } catch (error) {
                console.error('Error adding blackout date:', error);
                showMessage(error.message || 'Failed to add blackout date', 'error');
            }
        }

        async function addRangeBlackoutDates() {
            const startDate = document.getElementById('range-start-date').value;
            const endDate = document.getElementById('range-end-date').value;
            const reason = document.getElementById('range-blackout-reason').value || 'Vacation Period';

            if (!startDate || !endDate) {
                showMessage('Please select both start and end dates', 'error');
                return;
            }

            if (new Date(startDate) > new Date(endDate)) {
                showMessage('End date must be after start date', 'error');
                return;
            }

            try {
                const response = await apiCall('add_blackout_range', {
                    start_date: startDate,
                    end_date: endDate,
                    reason: reason
                });

                if (response.success) {
                    showMessage(`Added ${response.datesAdded} blackout dates`, 'success');
                    document.getElementById('range-start-date').value = '';
                    document.getElementById('range-end-date').value = '';
                    document.getElementById('range-blackout-reason').value = '';
                    loadBlackoutDates();
                } else {
                    throw new Error(response.error || 'Failed to add date range');
                }
            } catch (error) {
                console.error('Error adding date range:', error);
                showMessage(error.message || 'Failed to add date range', 'error');
            }
        }

        async function removeBlackoutDate(date) {
            if (!confirm(`Remove blackout date for ${formatDate(date)}?`)) {
                return;
            }

            try {
                const response = await apiCall('remove_blackout_date', {
                    date: date
                });

                if (response.success) {
                    showMessage('Blackout date removed', 'success');
                    loadBlackoutDates();
                } else {
                    throw new Error(response.error || 'Failed to remove date');
                }
            } catch (error) {
                console.error('Error removing blackout date:', error);
                showMessage(error.message || 'Failed to remove blackout date', 'error');
            }
        }

        function generateCalendar() {
            const container = document.getElementById('calendar-grid');
            const monthDisplay = document.getElementById('current-month-display');
            
            if (!container) return;

            const year = currentCalendarMonth.getFullYear();
            const month = currentCalendarMonth.getMonth();
            
            // Update month display
            monthDisplay.textContent = currentCalendarMonth.toLocaleDateString('en-US', { 
                month: 'long', 
                year: 'numeric' 
            });

            // Clear calendar
            container.innerHTML = '';

            // Add day headers (Mon-Fri only)
            const dayHeaders = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];
            dayHeaders.forEach(day => {
                const header = document.createElement('div');
                header.className = 'calendar-header';
                header.textContent = day;
                container.appendChild(header);
            });

            // Get first day of month and number of days
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Add empty cells for days before month starts (adjusted for Mon-Fri grid)
            // 0=Sun, 1=Mon, 2=Tue, etc. We want Mon=0 position
            const adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1; // Convert Sun=0 to be after Fri
            for (let i = 0; i < adjustedFirstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'empty-day';
                container.appendChild(emptyDay);
            }

            // Add days of month (Mon-Fri only)
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = new Date(year, month, day);
                const dayOfWeek = currentDate.getDay();

                // Skip weekends (0=Sun, 6=Sat)
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    continue;
                }

                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const blackoutInfo = blackoutDates.find(bd => bd.date === dateStr);
                const isBlackout = !!blackoutInfo;
                const isPast = currentDate < today;
                const isToday = currentDate.getTime() === today.getTime();

                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';

                if (isBlackout) dayElement.classList.add('blackout');
                if (isPast) dayElement.classList.add('past');
                if (isToday) dayElement.classList.add('today');

                // Create day content with enhanced display
                const dayNumber = document.createElement('div');
                dayNumber.className = 'calendar-day-number';
                dayNumber.textContent = day;
                dayElement.appendChild(dayNumber);

                // Add reason display for blackout dates
                if (isBlackout && blackoutInfo.reason) {
                    const reasonElement = document.createElement('div');
                    reasonElement.className = 'calendar-day-reason';
                    reasonElement.textContent = blackoutInfo.reason;
                    dayElement.appendChild(reasonElement);

                    // Add tooltip for full reason if truncated
                    const tooltip = document.createElement('div');
                    tooltip.className = 'calendar-tooltip';
                    tooltip.textContent = `Blackout: ${blackoutInfo.reason}`;
                    dayElement.appendChild(tooltip);
                }

                // Only allow toggling for future dates
                if (!isPast) {
                    dayElement.onclick = () => toggleCalendarDate(dateStr, isBlackout);
                }

                container.appendChild(dayElement);
            }
        }

        function changeMonth(direction) {
            currentCalendarMonth.setMonth(currentCalendarMonth.getMonth() + direction);
            generateCalendar();
        }

        async function toggleCalendarDate(dateStr, isCurrentlyBlackout) {
            if (isCurrentlyBlackout) {
                // Remove the blackout date
                await removeBlackoutDate(dateStr);
            } else {
                // Add as blackout date
                const dateObj = new Date(dateStr + 'T12:00:00');
                const formattedDate = dateObj.toLocaleDateString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric'
                });
                
                const reason = prompt(`Add blackout date for ${formattedDate}?\n\nEnter reason (optional):`, 'School Closed');
                
                if (reason !== null) {  // User didn't cancel
                    try {
                        const response = await apiCall('add_blackout_date', {
                            date: dateStr,
                            reason: reason || 'School Closed'
                        });

                        if (response.success) {
                            showMessage('Blackout date added', 'success');
                            loadBlackoutDates();
                        } else {
                            showMessage(response.error || 'Failed to add blackout date', 'error');
                        }
                    } catch (error) {
                        showMessage('Failed to add blackout date', 'error');
                    }
                }
            }
        }

        // ==========================================
        // ORDER MANAGEMENT
        // ==========================================
        
        window.OM = {
            data: [],
            apiUrl: 'https://script.google.com/macros/s/AKfycbzgQFKeMYxYAHH8iP2ASjGk8nGS8KNZ4XbC7tqHYG5TQE04YEwmNh-WFEoSBcHkrvZs/exec',
            
            updateSearchPlaceholder: function() {
                var searchType = document.getElementById('search-type').value;
                var searchInput = document.getElementById('search-input');
                if (searchType === 'email') {
                    searchInput.placeholder = 'Enter family email...';
                    searchInput.type = 'text';
                } else {
                    searchInput.placeholder = 'Enter student first or last name...';
                    searchInput.type = 'text';
                }
            },

            search: function() {
                var searchType = document.getElementById('search-type').value;
                var searchInput = document.getElementById('search-input').value.trim();
                if (!searchInput) {
                    alert('Please enter a search term');
                    return;
                }

                var self = this;
                document.getElementById('order-display').innerHTML = '<div style="text-align: center; padding: 40px;">Loading...</div>';

                var url = this.apiUrl + '?action=lookup_orders';
                if (searchType === 'email') {
                    url += '&email=' + encodeURIComponent(searchInput);
                } else {
                    url += '&student_name=' + encodeURIComponent(searchInput);
                }

                fetch(url)
                    .then(function(r) { return r.json(); })
                    .then(function(result) {
                        if (result.success && result.orders) {
                            self.data = result.orders;

                            // Debug: Log the first order's structure to console
                            if (self.data.length > 0 && self.data[0].items && self.data[0].items.length > 0) {
                                console.log('Sample order structure:', self.data[0]);
                                console.log('Sample item structure:', self.data[0].items[0]);
                            }

                            self.processOrderData();
                            self.sortAndDisplay();

                            // Show search info
                            if (searchType === 'student' && result.matchedEmails) {
                                var info = '<div style="background: #e3f2fd; padding: 10px; margin-bottom: 15px; border-radius: 6px;">';
                                info += '<strong>Found orders for:</strong> ' + result.matchedEmails.join(', ');
                                info += '</div>';
                                document.getElementById('order-display').insertAdjacentHTML('afterbegin', info);
                            }
                        } else {
                            var msg = searchType === 'student'
                                ? 'No orders found for student: ' + searchInput
                                : 'No orders found for email: ' + searchInput;
                            document.getElementById('order-display').innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">' + msg + '</div>';
                            self.updateCounts(0, 0, 0);
                        }
                    })
                    .catch(function() {
                        document.getElementById('order-display').innerHTML = '<div style="text-align: center; padding: 40px; color: #f44336;">Error loading orders</div>';
                    });
            },
            
            processOrderData: function() {
                for (var i = 0; i < this.data.length; i++) {
                    var order = this.data[i];
                    
                    // Check overall order status
                    var allCancelled = true;
                    var totalItems = 0;
                    var cancelledItems = 0;
                    
                    if (order.items) {
                        for (var j = 0; j < order.items.length; j++) {
                            totalItems++;
                            if (order.items[j].status === 'cancelled') {
                                cancelledItems++;
                            } else {
                                allCancelled = false;
                            }
                        }
                    }
                    
                    order.status = allCancelled ? 'cancelled' : 'active';
                    order.totalItems = totalItems;
                    order.cancelledItems = cancelledItems;
                }
            },
            
            sortAndDisplay: function() {
                var sort = document.getElementById('sort-orders').value;
                
                if (sort === 'date') {
                    this.data.sort(function(a, b) {
                        return (b.orderId || '').localeCompare(a.orderId || '');
                    });
                } else if (sort === 'family') {
                    this.data.sort(function(a, b) {
                        var aName = (a.children && a.children[0]) ? a.children[0].lastName : '';
                        var bName = (b.children && b.children[0]) ? b.children[0].lastName : '';
                        return aName.localeCompare(bName);
                    });
                }
                
                this.render();
            },
            
            render: function() {
                var container = document.getElementById('order-display');
                
                if (this.data.length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">No orders</div>';
                    this.updateCounts(0, 0, 0);
                    return;
                }
                
                var html = '';
                var totalOrders = 0;
                var cancelledOrders = 0;
                var totalItems = 0;
                
                for (var i = 0; i < this.data.length; i++) {
                    var order = this.data[i];
                    totalOrders++;
                    totalItems += order.totalItems || 0;
                    
                    if (order.status === 'cancelled') {
                        cancelledOrders++;
                    }
                    
                    html += this.renderOrder(order, i);
                }
                
                container.innerHTML = html;
                this.updateCounts(totalOrders, cancelledOrders, totalItems);
            },
            
            renderOrder: function(order, index) {
                var id = order.orderId || '';
                var isCancelled = order.status === 'cancelled';
                var dateStr = this.parseDate(id);
                var family = this.getFamily(order);
                var total = (order.total || 0).toFixed(2);
                
                var html = '<div class="om-order-card' + (isCancelled ? ' om-cancelled-order' : '') + '">';
                
                // Order Header
                var headerOnclick = 'OM.toggleOrder(' + index + ')';
                html += '<div class="om-order-header" onclick="' + headerOnclick + '" id="header-' + index + '">';
                html += '<div class="om-order-info">';
                html += '<h3>' + dateStr + ' - ' + family + ' Family';
                if (isCancelled) html += '<span class="om-badge">CANCELLED</span>';
                html += '</h3>';
                html += '<div class="om-order-meta">';
                html += 'Order ID: ' + id + ' | ';
                html += 'Items: ' + (order.totalItems || 0) + ' | ';
                html += 'Total: $' + total;
                if (order.cancelledItems > 0) {
                    html += ' | Cancelled Items: ' + order.cancelledItems;
                }
                html += '</div>';
                html += '</div>';
                html += '<div class="om-expand-icon" id="icon-' + index + '">▼</div>';
                html += '</div>';
                
                // Order Details
                html += '<div class="om-order-details" id="details-' + index + '">';
                html += this.renderOrderDetails(order);
                html += '</div>';
                
                html += '</div>';
                return html;
            },
            
            renderOrderDetails: function(order) {
                var html = '<div class="om-children-container">';
                
                // Group items by child
                var childrenMap = {};
                if (order.items) {
                    for (var i = 0; i < order.items.length; i++) {
                        var item = order.items[i];
                        var childKey = item.childId || '1';
                        if (!childrenMap[childKey]) {
                            childrenMap[childKey] = {
                                name: item.childName || 'Unknown',
                                firstName: item.childFirstName || '',
                                lastName: item.childLastName || '',
                                grade: item.grade || '',
                                items: []
                            };
                        }
                        childrenMap[childKey].items.push(item);
                    }
                }
                
                // Render each child's section
                for (var childId in childrenMap) {
                    var child = childrenMap[childId];
                    html += this.renderChildSection(child, order.orderId);
                }
                
                // Order totals and actions
                html += this.renderOrderTotals(order);
                html += this.renderOrderActions(order);
                
                html += '</div>';
                return html;
            },
            
            renderChildSection: function(child, orderId) {
                var html = '<div class="om-child-section">';
                html += '<div class="om-child-header">';
                html += '<div class="om-child-info">';
                html += '<h4>' + child.name + '</h4>';
                html += '<div class="om-child-grade">Grade: ' + child.grade + '</div>';
                html += '</div>';
                html += '</div>';
                
                html += '<div class="om-items-grid">';
                for (var i = 0; i < child.items.length; i++) {
                    var item = child.items[i];
                    html += this.renderItem(item, orderId);
                }
                html += '</div>';
                
                html += '</div>';
                return html;
            },
            
            renderItem: function(item, orderId) {
                var isCancelled = item.status === 'cancelled';
                var hasDiscount = item.hasDiscount || (item.paidPrice < item.price);
                var displayPrice = item.paidPrice || item.price || 0;
                
                // Try to get date from various possible fields
                var itemDate = item.date || item.deliveryDate || item.orderDate || '';
                
                // If no date but we have orderId, try to extract date from orderId
                if (!itemDate && orderId) {
                    // OrderIds often have format like "241107-xxxxx" where 241107 is YYMMDD
                    var match = orderId.match(/^(\d{6})/);
                    if (match) {
                        var dateStr = match[1];
                        var yr = '20' + dateStr.substr(0, 2);
                        var mo = dateStr.substr(2, 2);
                        var dy = dateStr.substr(4, 2);
                        itemDate = yr + '-' + mo + '-' + dy;
                    }
                }
                
                // Format date for display
                var displayDate = 'Unknown';
                if (itemDate && itemDate !== 'Unknown') {
                    try {
                        var dateObj = new Date(itemDate);
                        if (!isNaN(dateObj.getTime())) {
                            displayDate = dateObj.toLocaleDateString('en-US', {
                                month: 'short',
                                day: 'numeric',
                                year: 'numeric'
                            });
                        }
                    } catch (e) {
                        displayDate = itemDate; // Use as-is if can't parse
                    }
                }
                
                var pastDeadline = this.isPastCancellationDeadline(itemDate, false);
                var itemId = (item.id || '').replace(/'/g, '');
                var safeOrderId = (orderId || '').replace(/'/g, '');

                var html = '<div class="om-item">';
                html += '<div class="om-item-info">';
                html += '<div class="om-item-name">' + (item.name || 'Unknown Item') + '</div>';
                html += '<div class="om-item-details">';
                html += 'Day: ' + (item.day || item.dayOfWeek || 'Unknown') + ' | ';
                html += 'Date: ' + displayDate;
                if (pastDeadline) {
                    html += ' | <span style="color: #e53e3e; font-weight: 600;">⚠️ Past Deadline</span>';
                }
                html += '</div>';
                html += '</div>';

                html += '<div class="om-item-actions">';

                // Price display
                if (hasDiscount) {
                    html += '<span class="om-original-price">$' + (item.price || 0).toFixed(2) + '</span>';
                    html += '<span class="om-item-price discounted">$' + displayPrice.toFixed(2) + '</span>';
                    html += '<span class="om-discount-badge">DISCOUNT</span>';
                } else {
                    html += '<span class="om-item-price">$' + displayPrice.toFixed(2) + '</span>';
                }

                // Status badge
                html += '<span class="om-item-status om-status-' + (isCancelled ? 'cancelled' : 'active') + '">';
                html += isCancelled ? 'Cancelled' : 'Active';
                html += '</span>';

                // Action button - Admins can always cancel (with override warning)
                if (isCancelled) {
                    if (item.refundAmount) {
                        html += '<span style="color: #38a169; font-size: 0.9em; margin-left: 10px;">Refunded: $' + item.refundAmount.toFixed(2) + '</span>';
                    }
                } else {
                    var cancelOnclick = 'OM.cancelItem(\'' + itemId + '\', \'' + safeOrderId + '\')';
                    var buttonLabel = pastDeadline ? 'Cancel (Override)' : 'Cancel Item';
                    html += '<button class="om-cancel-item" onclick="' + cancelOnclick + '">' + buttonLabel + '</button>';
                }
                
                html += '</div>';
                html += '</div>';
                return html;
            },
            
            renderOrderTotals: function(order) {
                var subtotal = order.subtotal || 0;
                var discount = order.discount || 0;
                var total = order.total || 0;
                
                var html = '<div class="om-order-totals">';
                html += '<div class="om-totals-row">';
                html += '<span>Subtotal:</span><span>$' + subtotal.toFixed(2) + '</span>';
                html += '</div>';
                
                if (discount > 0) {
                    html += '<div class="om-totals-row">';
                    html += '<span>Discount:</span><span>-$' + discount.toFixed(2) + '</span>';
                    html += '</div>';
                }
                
                html += '<div class="om-totals-row final">';
                html += '<span>Total:</span><span>$' + total.toFixed(2) + '</span>';
                html += '</div>';
                html += '</div>';
                
                return html;
            },
            
            renderOrderActions: function(order) {
                var isCancelled = order.status === 'cancelled';
                var email = order.email || order.parentEmail || 'Unknown';
                var orderId = (order.orderId || '').replace(/'/g, '');
                
                var html = '<div class="om-order-actions">';
                html += '<div>';
                html += '<strong>Order ID:</strong> ' + (order.orderId || 'Unknown');
                html += ' | <strong>Email:</strong> ' + email;
                html += '</div>';
                html += '<div>';
                
                if (isCancelled) {
                    html += '<span style="color: #999; font-style: italic;">Order is cancelled</span>';
                } else {
                    // Admin can cancel any active items
                    var hasActiveItems = false;
                    if (order.items) {
                        for (var i = 0; i < order.items.length; i++) {
                            var item = order.items[i];
                            if (item.status !== 'cancelled') {
                                hasActiveItems = true;
                                break;
                            }
                        }
                    }

                    if (hasActiveItems) {
                        var bulkOnclick = 'OM.cancelEntireOrder(\'' + orderId + '\')';
                        html += '<button class="om-bulk-cancel" onclick="' + bulkOnclick + '">Cancel Entire Order</button>';
                    } else {
                        html += '<span style="color: #999; font-style: italic;">All items are cancelled</span>';
                    }
                }
                
                html += '</div>';
                html += '</div>';
                
                return html;
            },
            
            isPastCancellationDeadline: function(dateStr, adminBypass) {
                // Admin bypass: Admins can cancel at any time
                if (adminBypass === true) {
                    return false;
                }

                if (!dateStr || dateStr === 'Unknown') return false;

                try {
                    var itemDate;

                    // Parse the date string
                    if (dateStr.includes('-')) {
                        itemDate = new Date(dateStr + 'T10:00:00'); // Set to 10am on delivery date
                    } else if (dateStr.includes('/')) {
                        var parts = dateStr.split('/');
                        if (parts.length === 3) {
                            // Assuming MM/DD/YYYY format
                            itemDate = new Date(parts[2], parts[0] - 1, parts[1], 10, 0, 0); // 10am
                        }
                    } else {
                        return false;
                    }

                    if (isNaN(itemDate.getTime())) {
                        return false;
                    }

                    // Get current time
                    var now = new Date();

                    // Check if we're past the cancellation deadline (10am on delivery day)
                    return now > itemDate;

                } catch (e) {
                    console.error('Error parsing date:', dateStr, e);
                    return false;
                }
            },
            
            toggleOrder: function(index) {
                var details = document.getElementById('details-' + index);
                var header = document.getElementById('header-' + index);
                var icon = document.getElementById('icon-' + index);
                
                if (details.classList.contains('expanded')) {
                    details.classList.remove('expanded');
                    header.classList.remove('expanded');
                    icon.classList.remove('expanded');
                } else {
                    details.classList.add('expanded');
                    header.classList.add('expanded');
                    icon.classList.add('expanded');
                }
            },
            
            cancelItem: function(itemId, orderId) {
                var self = this;
                var item = null;
                for (var i = 0; i < this.data.length; i++) {
                    var order = this.data[i];
                    if (order.orderId === orderId && order.items) {
                        for (var j = 0; j < order.items.length; j++) {
                            if (order.items[j].id === itemId) {
                                item = order.items[j];
                                break;
                            }
                        }
                    }
                    if (item) break;
                }

                if (!item) {
                    alert('Item not found');
                    return;
                }

                var itemDate = item.date || item.deliveryDate || item.orderDate;
                var pastDeadline = this.isPastCancellationDeadline(itemDate, false);

                // Admin override: Allow cancellation with confirmation
                var confirmMsg = 'Cancel this item?\n\nItem: ' + item.name + '\nDate: ' + itemDate;
                if (pastDeadline) {
                    confirmMsg += '\n\n⚠️ ADMIN OVERRIDE: This item is past the 10am cancellation deadline.\nAre you sure you want to proceed with this cancellation?';
                }
                confirmMsg += '\n\nThis action cannot be undone.';

                if (!confirm(confirmMsg)) return;

                var session = 'session_' + Date.now();
                var items = [{ itemId: itemId }];
                var url = this.apiUrl + '?action=cancel_multiple_items&session_id=' + session + '&items=' + encodeURIComponent(JSON.stringify(items)) + '&admin_override=true';

                fetch(url)
                    .then(function(r) { return r.json(); })
                    .then(function(result) {
                        if (result.success) {
                            self.updateLocalItemStatus(itemId, 'cancelled', result.totalRefund || 0);
                            self.processOrderData();
                            self.render();
                            alert('Item cancelled successfully. Refund: $' + (result.totalRefund || 0).toFixed(2));
                        } else {
                            alert('Failed to cancel item: ' + (result.error || 'Unknown error'));
                        }
                    })
                    .catch(function() {
                        alert('Error cancelling item');
                    });
            },
            
            updateLocalItemStatus: function(itemId, status, refundAmount) {
                for (var i = 0; i < this.data.length; i++) {
                    var order = this.data[i];
                    if (order.items) {
                        for (var j = 0; j < order.items.length; j++) {
                            if (order.items[j].id === itemId) {
                                order.items[j].status = status;
                                if (refundAmount) {
                                    order.items[j].refundAmount = refundAmount;
                                }
                                return;
                            }
                        }
                    }
                }
            },
            
            cancelEntireOrder: function(orderId) {
                var self = this;
                var order = null;

                for (var i = 0; i < this.data.length; i++) {
                    if (this.data[i].orderId === orderId) {
                        order = this.data[i];
                        break;
                    }
                }

                if (!order) return;

                var items = [];
                var pastDeadlineItems = 0;
                var alreadyCancelledItems = 0;

                // Admin override: Cancel ALL active items regardless of deadline
                if (order.items) {
                    for (var i = 0; i < order.items.length; i++) {
                        var item = order.items[i];
                        var itemDate = item.date || item.deliveryDate || item.orderDate;

                        if (item.status === 'cancelled') {
                            alreadyCancelledItems++;
                        } else {
                            // Check if past deadline for informational purposes only
                            if (this.isPastCancellationDeadline(itemDate, false)) {
                                pastDeadlineItems++;
                            }
                            // Add all active items for cancellation
                            var itemId = item.id || (orderId + '-' + (item.rowIndex || ''));
                            if (itemId && itemId !== orderId + '-') {
                                items.push({ itemId: itemId });
                            }
                        }
                    }
                }

                if (items.length === 0) {
                    alert('No active items to cancel. All items are already cancelled.');
                    return;
                }

                var confirmMsg = 'Cancel ' + items.length + ' active item(s) from this order?';
                if (pastDeadlineItems > 0) {
                    confirmMsg += '\n\n⚠️ ADMIN OVERRIDE: ' + pastDeadlineItems + ' item(s) are past the 10am cancellation deadline.\nProceeding will use admin override privileges.';
                }
                if (alreadyCancelledItems > 0) {
                    confirmMsg += '\n\nNote: ' + alreadyCancelledItems + ' item(s) were already cancelled.';
                }
                confirmMsg += '\n\nThis action cannot be undone.';

                if (!confirm(confirmMsg)) return;

                var session = 'session_' + Date.now();
                var url = this.apiUrl + '?action=cancel_multiple_items&session_id=' + session + '&items=' + encodeURIComponent(JSON.stringify(items)) + '&admin_override=true';

                fetch(url)
                    .then(function(r) { return r.json(); })
                    .then(function(result) {
                        if (result.success) {
                            // Update all active items to cancelled
                            for (var i = 0; i < order.items.length; i++) {
                                var item = order.items[i];
                                if (item.status !== 'cancelled') {
                                    item.status = 'cancelled';
                                }
                            }

                            // Check if all items are now cancelled
                            var allCancelled = true;
                            for (var i = 0; i < order.items.length; i++) {
                                if (order.items[i].status !== 'cancelled') {
                                    allCancelled = false;
                                    break;
                                }
                            }

                            if (allCancelled) {
                                order.status = 'cancelled';
                            }

                            self.processOrderData();
                            self.render();

                            var successMsg = items.length + ' item(s) cancelled successfully. Refund: $' + (result.totalRefund || 0).toFixed(2);
                            if (pastDeadlineItems > 0) {
                                successMsg += '\n\n✅ Admin override applied for ' + pastDeadlineItems + ' item(s) past deadline.';
                            }
                            alert(successMsg);
                        } else {
                            alert('Failed to cancel items: ' + (result.error || 'Unknown error'));
                        }
                    })
                    .catch(function() {
                        alert('Error cancelling items');
                    });
            },
            
            parseDate: function(id) {
                if (!id || id === 'Unknown') return 'No Date';
                var parts = id.split('-');
                if (parts[0] && parts[0].length === 6) {
                    var yr = '20' + parts[0].substr(0, 2);
                    var mo = parts[0].substr(2, 2);
                    var dy = parts[0].substr(4, 2);
                    return mo + '/' + dy + '/' + yr;
                }
                return 'No Date';
            },
            
            getFamily: function(order) {
                if (order.children && order.children[0] && order.children[0].lastName) {
                    return order.children[0].lastName;
                }
                return 'Unknown';
            },
            
            updateCounts: function(total, cancelled, items) {
                document.getElementById('total-count').textContent = total;
                document.getElementById('cancel-count').textContent = cancelled;
                document.getElementById('item-count').textContent = items;
            },
            
            refresh: function() {
                var searchInput = document.getElementById('search-input').value.trim();
                if (searchInput) {
                    this.search();
                } else {
                    alert('Enter a search term first');
                }
            }
        };

        // ==========================================
        // FINANCIALS TAB
        // ==========================================

        window.FIN = {
            allOrders: [],

            loadFinancials: async function() {
                try {
                    showMessage('Loading financial data...', 'info');

                    // Get all orders from the sheet
                    const response = await fetch(API_URL + '?action=get_all_orders_financial');
                    const result = await response.json();

                    if (!result.success) {
                        showMessage('Failed to load financial data', 'error');
                        return;
                    }

                    this.allOrders = result.orders || [];
                    this.processFinancials();
                    showMessage('Financial report generated successfully', 'success');

                } catch (error) {
                    console.error('Error loading financials:', error);
                    showMessage('Error loading financial data', 'error');
                }
            },

            processFinancials: function() {
                const startDate = document.getElementById('fin-start-date').value;
                const endDate = document.getElementById('fin-end-date').value;

                // Filter orders by date range if specified
                let filteredOrders = this.allOrders;
                if (startDate || endDate) {
                    filteredOrders = this.allOrders.filter(order => {
                        const orderDate = new Date(order.timestamp);
                        if (startDate && orderDate < new Date(startDate)) return false;
                        if (endDate && orderDate > new Date(endDate + 'T23:59:59')) return false;
                        return true;
                    });
                }

                // Calculate metrics
                const metrics = this.calculateMetrics(filteredOrders);
                const customerData = this.analyzeCustomers(filteredOrders);
                const itemData = this.analyzeItems(filteredOrders);

                // Update UI
                this.updateSummaryCards(metrics);
                this.updateDiscountBreakdown(metrics);
                this.updateCustomerAnalytics(customerData);
                this.updateTopCustomers(customerData.families);
                this.updatePopularItems(itemData);

                // Update period display
                const periodText = startDate || endDate
                    ? `${startDate || 'Start'} to ${endDate || 'Now'}`
                    : 'All Time';
                document.getElementById('fin-revenue-period').textContent = periodText;
            },

            calculateMetrics: function(orders) {
                let grossRevenue = 0;        // Sum of order.total (before cancellations)
                let actualRevenue = 0;       // Actual money collected (after refunds)
                let totalRefunds = 0;
                let refundCount = 0;
                let totalPromoDiscounts = 0;  // Promo code discounts (active items only)
                let totalComboDiscounts = 0;  // Combo meal discounts (active items only)
                let ordersWithPromoDiscounts = 0;
                let originalSubtotal = 0;     // Total before any discounts (active items only)
                const discountCodes = {};

                orders.forEach(order => {
                    // Original order total (what was charged at checkout)
                    const orderTotal = order.total || 0;
                    grossRevenue += orderTotal;

                    // Calculate the discount rate for this order (if promo code was used)
                    const orderDiscountRate = (order.discount > 0 && order.subtotal > 0)
                        ? order.discount / order.subtotal
                        : 0;

                    // Track original subtotal and discounts - only for active items
                    let activeSubtotal = 0;
                    let orderRefundTotal = 0;
                    let hasActiveItemsWithPromo = false;

                    if (order.items) {
                        order.items.forEach(item => {
                            const basePrice = item.price || 0;
                            const paidPrice = item.paidPrice || item.price || 0;
                            const itemComboDiscount = basePrice - paidPrice;
                            const isCancelled = item.status === 'cancelled';

                            if (isCancelled) {
                                // Track refund amount
                                if (item.refundAmount) {
                                    totalRefunds += item.refundAmount;
                                    orderRefundTotal += item.refundAmount;
                                    refundCount++;
                                }
                            } else {
                                // Active item - count subtotal and discounts
                                activeSubtotal += basePrice;
                                hasActiveItemsWithPromo = true;

                                // Combo discounts only for active items
                                if (itemComboDiscount > 0) {
                                    totalComboDiscounts += itemComboDiscount;
                                }
                            }
                        });
                    }

                    originalSubtotal += activeSubtotal;

                    // Promo code discounts - only count for orders with active items
                    if (order.discount > 0 && hasActiveItemsWithPromo) {
                        // Calculate promo discount only on active items
                        const activePromoDiscount = activeSubtotal * orderDiscountRate;
                        totalPromoDiscounts += activePromoDiscount;
                        ordersWithPromoDiscounts++;
                        const code = order.promoCode || 'Unknown';
                        discountCodes[code] = (discountCodes[code] || 0) + activePromoDiscount;
                    }

                    // Actual revenue for this order = what they paid minus what we refunded
                    actualRevenue += (orderTotal - orderRefundTotal);
                });

                const totalDiscounts = totalPromoDiscounts + totalComboDiscounts;
                const netRevenue = actualRevenue;  // Already accounts for refunds
                const avgOrderValue = orders.length > 0 ? actualRevenue / orders.length : 0;
                const netMargin = actualRevenue > 0 ? ((actualRevenue / (actualRevenue + totalRefunds)) * 100) : 0;

                return {
                    totalRevenue: actualRevenue,    // Actual $ collected (after refunds)
                    grossRevenue,                   // Original order totals (before refunds)
                    originalSubtotal,               // What it would have been without discounts (active only)
                    totalRefunds,
                    refundCount,
                    netRevenue,                     // Same as actualRevenue
                    netMargin,
                    avgOrderValue,
                    totalOrders: orders.length,
                    totalPromoDiscounts,            // Discount from promo codes (active items only)
                    totalComboDiscounts,            // Discount from combo meals (active items only)
                    totalDiscounts,                 // Total of all discounts (active items only)
                    ordersWithPromoDiscounts,
                    discountCodes                   // Breakdown by code (active items only)
                };
            },

            analyzeCustomers: function(orders) {
                const familyMap = {};

                orders.forEach(order => {
                    const email = order.email || order.parentEmail;
                    if (!familyMap[email]) {
                        familyMap[email] = {
                            email: email,
                            orderCount: 0,
                            itemCount: 0,
                            totalRevenue: 0,
                            firstOrderDate: order.timestamp,
                            lastOrderDate: order.timestamp
                        };
                    }

                    const family = familyMap[email];
                    family.orderCount++;
                    family.itemCount += (order.items || []).length;
                    family.totalRevenue += order.total || 0;

                    const orderDate = new Date(order.timestamp);
                    if (orderDate < new Date(family.firstOrderDate)) {
                        family.firstOrderDate = order.timestamp;
                    }
                    if (orderDate > new Date(family.lastOrderDate)) {
                        family.lastOrderDate = order.timestamp;
                    }
                });

                const families = Object.values(familyMap);
                const totalFamilies = families.length;
                const newCustomers = families.filter(f => f.orderCount === 1).length;
                const repeatCustomers = families.filter(f => f.orderCount > 1).length;
                const avgOrdersPerFamily = totalFamilies > 0
                    ? (families.reduce((sum, f) => sum + f.orderCount, 0) / totalFamilies).toFixed(1)
                    : 0;

                // Sort by revenue
                families.sort((a, b) => b.totalRevenue - a.totalRevenue);

                return {
                    families,
                    totalFamilies,
                    newCustomers,
                    repeatCustomers,
                    avgOrdersPerFamily
                };
            },

            analyzeItems: function(orders) {
                const itemMap = {};
                let totalItemRevenue = 0;

                orders.forEach(order => {
                    if (order.items) {
                        order.items.forEach(item => {
                            // Only count non-cancelled items
                            if (item.status !== 'cancelled') {
                                const itemName = item.name;
                                const revenue = item.paidPrice || item.price || 0;

                                if (!itemMap[itemName]) {
                                    itemMap[itemName] = {
                                        name: itemName,
                                        quantity: 0,
                                        revenue: 0
                                    };
                                }

                                itemMap[itemName].quantity++;
                                itemMap[itemName].revenue += revenue;
                                totalItemRevenue += revenue;
                            }
                        });
                    }
                });

                const items = Object.values(itemMap);
                items.sort((a, b) => b.revenue - a.revenue);

                // Add percentage of total
                items.forEach(item => {
                    item.percentOfTotal = totalItemRevenue > 0
                        ? ((item.revenue / totalItemRevenue) * 100).toFixed(1)
                        : 0;
                });

                return items;
            },

            updateSummaryCards: function(metrics) {
                // Main revenue card - ACTUAL money collected
                document.getElementById('fin-total-revenue').textContent = '$' + metrics.totalRevenue.toFixed(2);
                const periodText = document.getElementById('fin-revenue-period').textContent.split('\n')[0];
                document.getElementById('fin-revenue-period').innerHTML = periodText +
                    '<br><span style="font-size: 0.75em; opacity: 0.8;">(Actual $ Collected)</span>';

                document.getElementById('fin-total-refunds').textContent = '$' + metrics.totalRefunds.toFixed(2);
                document.getElementById('fin-refund-count').textContent = metrics.refundCount + ' items';

                document.getElementById('fin-net-revenue').textContent = '$' + metrics.netRevenue.toFixed(2);
                document.getElementById('fin-net-margin').textContent = metrics.netMargin.toFixed(1) + '% margin';

                document.getElementById('fin-avg-order').textContent = '$' + metrics.avgOrderValue.toFixed(2);
                document.getElementById('fin-total-orders').textContent = metrics.totalOrders + ' orders';

                // Update discount display
                document.getElementById('fin-total-discounts').textContent = '$' + metrics.totalDiscounts.toFixed(2);
                document.getElementById('fin-discount-orders').textContent = metrics.ordersWithPromoDiscounts;

                // Update reconciliation card
                document.getElementById('fin-original-subtotal').textContent = '$' + metrics.originalSubtotal.toFixed(2);
                document.getElementById('fin-combo-discount-display').textContent = '$' + metrics.totalComboDiscounts.toFixed(2);
                document.getElementById('fin-promo-discount-display').textContent = '$' + metrics.totalPromoDiscounts.toFixed(2);
                document.getElementById('fin-gross-revenue').textContent = '$' + metrics.grossRevenue.toFixed(2);
                document.getElementById('fin-refunds-display').textContent = '$' + metrics.totalRefunds.toFixed(2);
                document.getElementById('fin-net-display').textContent = '$' + metrics.netRevenue.toFixed(2);
            },

            updateDiscountBreakdown: function(metrics) {
                const container = document.getElementById('fin-discount-breakdown');
                let html = '<div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e9ecef;">';

                // Show breakdown by discount type
                html += '<div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px;">';
                html += '<div style="font-weight: 600; margin-bottom: 8px;">Discount Breakdown:</div>';
                html += '<div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 5px;">';
                html += '<span>Promo Codes:</span><span style="color: #dc3545; font-weight: 600;">$' + metrics.totalPromoDiscounts.toFixed(2) + '</span>';
                html += '</div>';
                html += '<div style="display: flex; justify-content: space-between; font-size: 0.9em; margin-bottom: 5px;">';
                html += '<span>Combo Meals:</span><span style="color: #dc3545; font-weight: 600;">$' + metrics.totalComboDiscounts.toFixed(2) + '</span>';
                html += '</div>';
                html += '<div style="display: flex; justify-content: space-between; font-size: 0.9em; padding-top: 8px; border-top: 1px solid #dee2e6; font-weight: 600;">';
                html += '<span>Total Discounts:</span><span style="color: #dc3545;">$' + metrics.totalDiscounts.toFixed(2) + '</span>';
                html += '</div>';
                html += '</div>';

                // Show promo code breakdown
                const codes = Object.entries(metrics.discountCodes).sort((a, b) => b[1] - a[1]);

                if (codes.length === 0) {
                    html += '<div style="color: #999; font-style: italic;">No discounts applied</div>';
                } else {
                    codes.forEach(([code, amount]) => {
                        html += `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #666;">${code}:</span>
                                <span style="font-weight: 600; color: #f44336;">-$${amount.toFixed(2)}</span>
                            </div>
                        `;
                    });
                }

                html += '</div>';
                container.innerHTML = html;
            },

            updateCustomerAnalytics: function(data) {
                document.getElementById('fin-total-families').textContent = data.totalFamilies;
                document.getElementById('fin-new-customers').textContent = data.newCustomers;
                document.getElementById('fin-repeat-customers').textContent = data.repeatCustomers;
                document.getElementById('fin-avg-orders-family').textContent = data.avgOrdersPerFamily;
            },

            updateTopCustomers: function(families) {
                const tbody = document.getElementById('fin-top-customers');
                const top20 = families.slice(0, 20);

                if (top20.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #999;">No customer data available</td></tr>';
                    return;
                }

                let html = '';
                top20.forEach((family, index) => {
                    const avgOrder = family.orderCount > 0 ? (family.totalRevenue / family.orderCount) : 0;
                    html += `
                        <tr style="border-bottom: 1px solid #e9ecef;">
                            <td style="padding: 12px;">${index + 1}</td>
                            <td style="padding: 12px;">${family.email}</td>
                            <td style="padding: 12px; text-align: center;">${family.orderCount}</td>
                            <td style="padding: 12px; text-align: center;">${family.itemCount}</td>
                            <td style="padding: 12px; text-align: right; font-weight: 600; color: #4caf50;">$${family.totalRevenue.toFixed(2)}</td>
                            <td style="padding: 12px; text-align: right;">$${avgOrder.toFixed(2)}</td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
            },

            updatePopularItems: function(items) {
                const tbody = document.getElementById('fin-popular-items');
                const top20 = items.slice(0, 20);

                if (top20.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding: 40px; text-align: center; color: #999;">No item sales data available</td></tr>';
                    return;
                }

                let html = '';
                top20.forEach((item, index) => {
                    html += `
                        <tr style="border-bottom: 1px solid #e9ecef;">
                            <td style="padding: 12px;">${index + 1}</td>
                            <td style="padding: 12px; font-weight: 500;">${item.name}</td>
                            <td style="padding: 12px; text-align: center;">${item.quantity}</td>
                            <td style="padding: 12px; text-align: right; font-weight: 600; color: #4caf50;">$${item.revenue.toFixed(2)}</td>
                            <td style="padding: 12px; text-align: right; color: #666;">${item.percentOfTotal}%</td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
            },

            clearDates: function() {
                document.getElementById('fin-start-date').value = '';
                document.getElementById('fin-end-date').value = '';
                if (this.allOrders.length > 0) {
                    this.processFinancials();
                }
            },

            setThisMonth: function() {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);

                document.getElementById('fin-start-date').value = firstDay.toISOString().split('T')[0];
                document.getElementById('fin-end-date').value = lastDay.toISOString().split('T')[0];

                if (this.allOrders.length > 0) {
                    this.processFinancials();
                }
            },

            setLastMonth: function() {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                const lastDay = new Date(now.getFullYear(), now.getMonth(), 0);

                document.getElementById('fin-start-date').value = firstDay.toISOString().split('T')[0];
                document.getElementById('fin-end-date').value = lastDay.toISOString().split('T')[0];

                if (this.allOrders.length > 0) {
                    this.processFinancials();
                }
            },

            setYearToDate: function() {
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), 0, 1);

                document.getElementById('fin-start-date').value = firstDay.toISOString().split('T')[0];
                document.getElementById('fin-end-date').value = now.toISOString().split('T')[0];

                if (this.allOrders.length > 0) {
                    this.processFinancials();
                }
            },

            setSchoolYear: function() {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();

                // School year starts in August
                // If we're before August, school year started last August
                // If we're August or later, school year started this August
                const schoolYearStart = currentMonth < 7
                    ? new Date(currentYear - 1, 7, 1)  // August 1 of last year
                    : new Date(currentYear, 7, 1);      // August 1 of this year

                document.getElementById('fin-start-date').value = schoolYearStart.toISOString().split('T')[0];
                document.getElementById('fin-end-date').value = now.toISOString().split('T')[0];

                if (this.allOrders.length > 0) {
                    this.processFinancials();
                }
            },

            exportData: function() {
                if (this.allOrders.length === 0) {
                    showMessage('No data to export. Please generate a report first.', 'error');
                    return;
                }

                const startDate = document.getElementById('fin-start-date').value;
                const endDate = document.getElementById('fin-end-date').value;
                const exportType = document.getElementById('export-type').value;

                // Filter orders by date range
                let filteredOrders = this.allOrders;
                if (startDate || endDate) {
                    filteredOrders = this.allOrders.filter(order => {
                        const orderDate = new Date(order.timestamp);
                        if (startDate && orderDate < new Date(startDate)) return false;
                        if (endDate && orderDate > new Date(endDate + 'T23:59:59')) return false;
                        return true;
                    });
                }

                if (filteredOrders.length === 0) {
                    showMessage('No orders in selected date range', 'error');
                    return;
                }

                // Build CSV based on export type
                let csv = '';

                if (exportType === 'full' || exportType === 'students') {
                    csv += this.buildStudentBreakdownCSV(filteredOrders);
                }

                if (exportType === 'full' || exportType === 'summary') {
                    csv += this.buildSummaryCSV(filteredOrders);
                }

                if (exportType === 'full' || exportType === 'orders') {
                    csv += this.buildOrderDetailsCSV(filteredOrders);
                }

                // Create and download file
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);

                const dateRange = startDate && endDate
                    ? `${startDate}_to_${endDate}`
                    : startDate
                    ? `from_${startDate}`
                    : endDate
                    ? `to_${endDate}`
                    : 'all_time';

                const typeLabel = exportType === 'full' ? 'full' : exportType;
                link.setAttribute('href', url);
                link.setAttribute('download', `artios_cafe_${typeLabel}_${dateRange}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage('Financial data exported successfully', 'success');
            },

            buildStudentBreakdownCSV: function(filteredOrders) {
                let csv = 'STUDENT BREAKDOWN\n\n';

                // Analyze by grade
                const gradeStats = {};
                const uniqueStudents = new Set();
                const gradeItemStats = {};

                filteredOrders.forEach(order => {
                    order.items.forEach(item => {
                        if (item.status === 'cancelled') return;

                        const studentKey = `${item.childName || 'Unknown'}_${order.email}`;
                        uniqueStudents.add(studentKey);

                        const grade = item.childGrade || 'Unknown';

                        // Grade summary
                        if (!gradeStats[grade]) {
                            gradeStats[grade] = {
                                orderCount: 0,
                                revenue: 0,
                                itemCount: 0
                            };
                        }
                        gradeStats[grade].orderCount++;
                        gradeStats[grade].itemCount++;
                        gradeStats[grade].revenue += item.paidPrice || item.price || 0;

                        // Item popularity by grade
                        if (!gradeItemStats[grade]) {
                            gradeItemStats[grade] = {};
                        }
                        if (!gradeItemStats[grade][item.name]) {
                            gradeItemStats[grade][item.name] = 0;
                        }
                        gradeItemStats[grade][item.name]++;
                    });
                });

                // Output total students
                csv += `"Total Unique Students Served",${uniqueStudents.size}\n\n`;

                // Output grade summary
                csv += 'ORDERS BY GRADE LEVEL\n';
                csv += 'Grade,Orders,Items,Revenue,Avg per Order\n';
                Object.keys(gradeStats).sort().forEach(grade => {
                    const stats = gradeStats[grade];
                    const avgPerOrder = stats.orderCount > 0 ? (stats.revenue / stats.orderCount) : 0;
                    csv += `"${grade}",${stats.orderCount},${stats.itemCount},"$${stats.revenue.toFixed(2)}","$${avgPerOrder.toFixed(2)}"\n`;
                });

                // Most popular items per grade
                csv += '\n\nMOST POPULAR ITEMS BY GRADE\n';
                csv += 'Grade,Item Name,Quantity\n';
                Object.keys(gradeItemStats).sort().forEach(grade => {
                    const items = gradeItemStats[grade];
                    const sortedItems = Object.entries(items)
                        .sort((a, b) => b[1] - a[1])
                        .slice(0, 3); // Top 3 per grade

                    sortedItems.forEach(([itemName, count]) => {
                        csv += `"${grade}","${itemName}",${count}\n`;
                    });
                });

                csv += '\n\n';
                return csv;
            },

            buildSummaryCSV: function(filteredOrders) {
                let csv = 'FINANCIAL SUMMARY\n\n';

                const metrics = this.calculateMetrics(filteredOrders);
                const customerData = this.analyzeCustomers(filteredOrders);
                const itemData = this.analyzeItems(filteredOrders);

                // Financial Metrics
                csv += 'REVENUE METRICS\n';
                csv += 'Metric,Value\n';
                csv += `"Total Revenue","$${metrics.totalRevenue.toFixed(2)}"\n`;
                csv += `"Total Refunds","$${metrics.totalRefunds.toFixed(2)}"\n`;
                csv += `"Net Revenue","$${metrics.netRevenue.toFixed(2)}"\n`;
                csv += `"Net Margin","${metrics.netMargin.toFixed(1)}%"\n`;
                csv += `"Total Orders",${metrics.totalOrders}\n`;
                csv += `"Average Order Value","$${metrics.avgOrderValue.toFixed(2)}"\n`;
                csv += `"Total Discounts Applied","$${metrics.totalDiscounts.toFixed(2)}"\n`;
                csv += `"Orders with Discounts",${metrics.ordersWithDiscounts}\n`;
                csv += `"Refunded Items",${metrics.refundCount}\n`;

                csv += '\n\n';

                // Discount Breakdown
                csv += 'DISCOUNT BREAKDOWN\n';
                csv += 'Promo Code,Total Discount\n';
                Object.keys(metrics.discountCodes).forEach(code => {
                    csv += `"${code}","$${metrics.discountCodes[code].toFixed(2)}"\n`;
                });

                csv += '\n\n';

                // Customer Summary
                csv += 'CUSTOMER SUMMARY\n';
                csv += 'Metric,Value\n';
                csv += `"Total Families",${customerData.totalFamilies}\n`;
                csv += `"New Customers",${customerData.newCustomers}\n`;
                csv += `"Repeat Customers",${customerData.repeatCustomers}\n`;
                csv += `"Avg Orders per Family",${customerData.avgOrdersPerFamily}\n`;

                csv += '\n\n';

                // Top Families
                csv += 'TOP FAMILIES BY REVENUE\n';
                csv += 'Rank,Email,Orders,Items,Total Revenue,Avg Order Value\n';
                customerData.families.forEach((family, index) => {
                    const avgOrder = family.orderCount > 0 ? (family.totalRevenue / family.orderCount) : 0;
                    csv += `${index + 1},"${family.email}",${family.orderCount},${family.itemCount},"$${family.totalRevenue.toFixed(2)}","$${avgOrder.toFixed(2)}"\n`;
                });

                csv += '\n\n';

                // Popular Items
                csv += 'POPULAR MENU ITEMS\n';
                csv += 'Rank,Item Name,Quantity Sold,Revenue,% of Total\n';
                itemData.forEach((item, index) => {
                    csv += `${index + 1},"${item.name}",${item.quantity},"$${item.revenue.toFixed(2)}","${item.percentOfTotal}%"\n`;
                });

                csv += '\n\n';
                return csv;
            },

            buildOrderDetailsCSV: function(filteredOrders) {
                let csv = 'ORDER DETAILS\n';
                csv += 'Order ID,Order Date,Order Time,Family Email,Student First,Student Last,Student Grade,Item Name,Quantity,Base Price,Paid Price,Promo Code,Discount,Status,Refund Amount,Lunch Date\n';

                filteredOrders.forEach(order => {
                    const orderDate = new Date(order.timestamp);
                    const dateStr = orderDate.toLocaleDateString();
                    const timeStr = orderDate.toLocaleTimeString();

                    order.items.forEach(item => {
                        // Extract student name from item's childName or children array
                        let firstName = '';
                        let lastName = '';
                        let grade = '';

                        if (item.childName) {
                            const nameParts = item.childName.trim().split(' ');
                            firstName = nameParts[0] || '';
                            lastName = nameParts.slice(1).join(' ') || '';
                        }

                        if (item.childGrade) {
                            grade = item.childGrade;
                        } else if (order.children && order.children.length > 0) {
                            const child = order.children[0];
                            if (!firstName) firstName = child.firstName || '';
                            if (!lastName) lastName = child.lastName || '';
                            grade = child.grade || '';
                        }

                        csv += `"${order.orderId}",`;
                        csv += `"${dateStr}",`;
                        csv += `"${timeStr}",`;
                        csv += `"${order.email || order.parentEmail}",`;
                        csv += `"${firstName}",`;
                        csv += `"${lastName}",`;
                        csv += `"${grade}",`;
                        csv += `"${item.name}",`;
                        csv += `${item.quantity || 1},`;
                        csv += `${item.price || 0},`;
                        csv += `${item.paidPrice || item.price || 0},`;
                        csv += `"${order.promoCode || ''}",`;
                        csv += `${order.discount || 0},`;
                        csv += `"${item.status}",`;
                        csv += `${item.refundAmount || 0},`;
                        csv += `"${item.date}"\n`;
                    });
                });

                return csv;
            }
        };

        // ==========================================
        // COMMUNICATIONS TAB
        // ==========================================

        window.COMM = {
            allFamilies: [],
            filteredFamilies: [],
            familyAccounts: [],
            
            loadFamilies: async function() {
                try {
                    showMessage('Loading family data...', 'info');

                    // Load both orders and family accounts
                    const [ordersResponse, accountsResponse] = await Promise.all([
                        fetch(API_URL + '?action=get_all_orders_financial'),
                        fetch(API_URL + '?action=get_family_accounts')
                    ]);

                    const ordersResult = await ordersResponse.json();
                    const accountsResult = await accountsResponse.json();

                    if (!ordersResult.success) {
                        showMessage('Failed to load order data', 'error');
                        return;
                    }

                    // Build family map from orders
                    const familyMap = {};
                    const orders = ordersResult.orders || [];

                    orders.forEach(order => {
                        const email = order.email || order.parentEmail;
                        if (!familyMap[email]) {
                            familyMap[email] = {
                                email: email,
                                students: new Set(),
                                grades: new Set(),
                                totalOrders: 0,
                                totalSpent: 0,
                                lastOrderDate: null,
                                hasAccount: false,
                                selected: false
                            };
                        }

                        const family = familyMap[email];
                        family.totalOrders++;
                        family.totalSpent += order.total || 0;

                        const orderDate = new Date(order.timestamp);
                        if (!family.lastOrderDate || orderDate > family.lastOrderDate) {
                            family.lastOrderDate = orderDate;
                        }

                        // Collect unique students (normalize names to avoid duplicates)
                        if (order.children) {
                            order.children.forEach(child => {
                                let studentName = child.name || `${child.firstName} ${child.lastName}`;
                                // Normalize: trim, remove extra spaces, title case
                                studentName = studentName.trim().replace(/\s+/g, ' ');
                                // Store normalized lowercase version as key to check duplicates
                                const normalizedKey = studentName.toLowerCase();

                                // Check if we already have this student (case-insensitive)
                                let found = false;
                                family.students.forEach(existing => {
                                    if (existing.toLowerCase() === normalizedKey) {
                                        found = true;
                                    }
                                });

                                if (!found) {
                                    family.students.add(studentName);
                                }

                                // Track grade
                                if (child.grade) {
                                    family.grades.add(child.grade);
                                }
                            });
                        }
                    });

                    // Mark families with accounts
                    if (accountsResult.success && accountsResult.accounts) {
                        accountsResult.accounts.forEach(account => {
                            if (familyMap[account.email]) {
                                familyMap[account.email].hasAccount = true;
                            }
                        });
                    }

                    // Convert to array - FIX: convert students Set to Array BEFORE accessing .length
                    this.allFamilies = Object.values(familyMap).map(family => {
                        const studentsArray = Array.from(family.students);
                        const gradesArray = Array.from(family.grades);

                        // Extract last name from first student
                        let lastName = '';
                        if (studentsArray.length > 0) {
                            const firstStudent = studentsArray[0];
                            const nameParts = firstStudent.trim().split(' ');
                            lastName = nameParts.length > 1 ? nameParts[nameParts.length - 1] : nameParts[0];
                        }

                        return {
                            email: family.email,
                            lastName: lastName,
                            students: studentsArray,
                            grades: gradesArray,
                            studentCount: studentsArray.length,
                            totalOrders: family.totalOrders,
                            totalSpent: family.totalSpent,
                            lastOrderDate: family.lastOrderDate,
                            hasAccount: family.hasAccount,
                            selected: family.selected
                        };
                    });

                    // Populate grade filter dropdown
                    this.populateGradeFilter();

                    this.filteredFamilies = [...this.allFamilies];
                    this.sortFamilies();
                    this.displayFamilies();

                    showMessage(`Loaded ${this.allFamilies.length} families`, 'success');
                } catch (error) {
                    console.error('Error loading families:', error);
                    showMessage('Error loading family data', 'error');
                }
            },

            populateGradeFilter: function() {
                const gradeSet = new Set();
                this.allFamilies.forEach(family => {
                    family.grades.forEach(grade => gradeSet.add(grade));
                });

                const gradeFilter = document.getElementById('comm-grade-filter');
                gradeFilter.innerHTML = '<option value="all">All Grades</option>';

                // Sort grades naturally (K, 1, 2, 3, etc.)
                const grades = Array.from(gradeSet).sort((a, b) => {
                    if (a === 'K') return -1;
                    if (b === 'K') return 1;
                    return parseInt(a) - parseInt(b);
                });

                grades.forEach(grade => {
                    const option = document.createElement('option');
                    option.value = grade;
                    option.textContent = `Grade ${grade}`;
                    gradeFilter.appendChild(option);
                });
            },

            filterFamilies: function() {
                const searchTerm = document.getElementById('comm-search').value.toLowerCase();
                const activityFilter = document.getElementById('comm-activity-filter').value;
                const gradeFilter = document.getElementById('comm-grade-filter').value;

                this.filteredFamilies = this.allFamilies.filter(family => {
                    // Search filter
                    if (searchTerm) {
                        const matchesEmail = family.email.toLowerCase().includes(searchTerm);
                        const matchesStudent = family.students.some(s => s.toLowerCase().includes(searchTerm));
                        if (!matchesEmail && !matchesStudent) {
                            return false;
                        }
                    }

                    // Grade filter
                    if (gradeFilter !== 'all') {
                        if (!family.grades.includes(gradeFilter)) {
                            return false;
                        }
                    }

                    // Activity filter
                    if (activityFilter !== 'all') {
                        const now = new Date();
                        const daysSinceOrder = family.lastOrderDate
                            ? (now - family.lastOrderDate) / (1000 * 60 * 60 * 24)
                            : Infinity;

                        switch (activityFilter) {
                            case 'active':
                                if (daysSinceOrder > 30) return false;
                                break;
                            case 'recent':
                                if (daysSinceOrder > 60) return false;
                                break;
                            case 'inactive':
                                if (daysSinceOrder <= 60) return false;
                                break;
                            case 'hasAccount':
                                if (!family.hasAccount) return false;
                                break;
                            case 'noAccount':
                                if (family.hasAccount) return false;
                                break;
                        }
                    }

                    return true;
                });

                this.sortFamilies();
                this.displayFamilies();
            },

            sortFamilies: function() {
                const sortBy = document.getElementById('comm-sort').value;

                this.filteredFamilies.sort((a, b) => {
                    switch (sortBy) {
                        case 'lastName':
                            const lastNameA = a.lastName || '';
                            const lastNameB = b.lastName || '';
                            return lastNameA.localeCompare(lastNameB);
                        case 'email':
                            return a.email.localeCompare(b.email);
                        case 'lastOrder':
                            if (!a.lastOrderDate) return 1;
                            if (!b.lastOrderDate) return -1;
                            return b.lastOrderDate - a.lastOrderDate;
                        case 'totalOrders':
                            return b.totalOrders - a.totalOrders;
                        case 'totalSpent':
                            return b.totalSpent - a.totalSpent;
                        default:
                            return a.email.localeCompare(b.email);
                    }
                });

                this.displayFamilies();
            },

            displayFamilies: function() {
                const tbody = document.getElementById('comm-family-list');

                if (this.filteredFamilies.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="10" style="padding: 40px; text-align: center; color: #999;">No families match the current filters</td></tr>';
                    document.getElementById('comm-filter-results').textContent = '0 families';
                    return;
                }

                let html = '';
                const now = new Date();

                this.filteredFamilies.forEach((family, index) => {
                    const daysSinceOrder = family.lastOrderDate
                        ? (now - family.lastOrderDate) / (1000 * 60 * 60 * 24)
                        : Infinity;

                    let statusColor = '#4caf50';
                    let statusText = 'Active';

                    if (daysSinceOrder > 60) {
                        statusColor = '#f44336';
                        statusText = 'Inactive';
                    } else if (daysSinceOrder > 30) {
                        statusColor = '#ff9800';
                        statusText = 'Recent';
                    }

                    const lastOrderStr = family.lastOrderDate
                        ? family.lastOrderDate.toLocaleDateString()
                        : 'Never';

                    html += `
                        <tr style="border-bottom: 1px solid #e9ecef;">
                            <td style="padding: 12px; text-align: center;">
                                <input type="checkbox" class="family-checkbox" data-index="${index}"
                                       ${family.selected ? 'checked' : ''}
                                       onchange="COMM.toggleFamily(${index})">
                            </td>
                            <td style="padding: 12px; font-weight: 600;">${family.lastName || ''}</td>
                            <td style="padding: 12px;">${family.email}</td>
                            <td style="padding: 12px; text-align: center;">${family.hasAccount ? '✅' : '❌'}</td>
                            <td style="padding: 12px; text-align: center;">${family.studentCount}</td>
                            <td style="padding: 12px; text-align: center;">${family.totalOrders}</td>
                            <td style="padding: 12px; text-align: right; font-weight: 600;">$${family.totalSpent.toFixed(2)}</td>
                            <td style="padding: 12px; text-align: center;">${lastOrderStr}</td>
                            <td style="padding: 12px; text-align: center;">
                                <span style="padding: 4px 8px; border-radius: 4px; font-size: 0.85em; font-weight: 600; background: ${statusColor}22; color: ${statusColor};">
                                    ${statusText}
                                </span>
                            </td>
                            <td style="padding: 12px; text-align: center;">
                                <button onclick="COMM.emailFamily('${family.email}')" class="action-btn" style="padding: 4px 8px; font-size: 0.85em;">
                                    ✉️ Email
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;

                const selectedCount = this.filteredFamilies.filter(f => f.selected).length;
                document.getElementById('comm-filter-results').textContent =
                    `Showing ${this.filteredFamilies.length} of ${this.allFamilies.length} families (${selectedCount} selected)`;
            },

            toggleSelectAll: function() {
                const checked = document.getElementById('comm-select-all').checked;
                this.filteredFamilies.forEach(family => {
                    family.selected = checked;
                });
                this.displayFamilies();
            },

            toggleFamily: function(index) {
                this.filteredFamilies[index].selected = !this.filteredFamilies[index].selected;
                this.displayFamilies();
            },

            showBulkEmail: function() {
                const selected = this.allFamilies.filter(f => f.selected);

                if (selected.length === 0) {
                    showMessage('Please select at least one family', 'error');
                    return;
                }

                // Show recipients
                const recipientsDiv = document.getElementById('bulk-email-recipients');
                recipientsDiv.innerHTML = selected.map(f =>
                    `<span style="display: inline-block; background: #e3f2fd; padding: 4px 8px; margin: 2px; border-radius: 4px; font-size: 0.9em;">${f.email}</span>`
                ).join('');

                // Clear form
                document.getElementById('bulk-email-subject').value = '';
                document.getElementById('bulk-email-message').value = '';

                // Show modal
                document.getElementById('bulk-email-modal').style.display = 'block';
            },

            closeBulkEmail: function() {
                document.getElementById('bulk-email-modal').style.display = 'none';
            },

            sendBulkEmail: function() {
                const subject = document.getElementById('bulk-email-subject').value.trim();
                const message = document.getElementById('bulk-email-message').value.trim();
                const selected = this.allFamilies.filter(f => f.selected);

                if (!subject || !message) {
                    showMessage('Please enter subject and message', 'error');
                    return;
                }

                if (selected.length === 0) {
                    showMessage('No families selected', 'error');
                    return;
                }

                const confirmed = confirm(`Send email to ${selected.length} families?\n\nThis will open your default email client with all addresses.`);

                if (confirmed) {
                    // Create mailto link
                    const emails = selected.map(f => f.email).join(',');
                    const mailtoLink = `mailto:${emails}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;

                    // Open email client
                    window.location.href = mailtoLink;

                    showMessage(`Opening email client for ${selected.length} recipients`, 'success');
                    this.closeBulkEmail();
                }
            },

            emailFamily: function(email) {
                window.location.href = `mailto:${email}?subject=${encodeURIComponent('Artios Cafe')}`;
            },

            exportContacts: function() {
                if (this.filteredFamilies.length === 0) {
                    showMessage('No families to export', 'error');
                    return;
                }

                let csv = 'Family Email,Has Account,Students,Student Count,Total Orders,Total Spent,Last Order Date,Status\n';

                const now = new Date();
                this.filteredFamilies.forEach(family => {
                    const daysSinceOrder = family.lastOrderDate
                        ? (now - family.lastOrderDate) / (1000 * 60 * 60 * 24)
                        : Infinity;

                    let statusText = 'Active';
                    if (daysSinceOrder > 60) statusText = 'Inactive';
                    else if (daysSinceOrder > 30) statusText = 'Recent';

                    const lastOrderStr = family.lastOrderDate
                        ? family.lastOrderDate.toLocaleDateString()
                        : 'Never';

                    const studentsStr = family.students.join('; ');

                    csv += `"${family.email}",`;
                    csv += `"${family.hasAccount ? 'Yes' : 'No'}",`;
                    csv += `"${studentsStr}",`;
                    csv += `${family.studentCount},`;
                    csv += `${family.totalOrders},`;
                    csv += `$${family.totalSpent.toFixed(2)},`;
                    csv += `"${lastOrderStr}",`;
                    csv += `"${statusText}"\n`;
                });

                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const date = new Date().toISOString().split('T')[0];

                link.setAttribute('href', url);
                link.setAttribute('download', `artios_cafe_contacts_${date}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage('Contact list exported successfully', 'success');
            },

            exportSelected: function() {
                const selected = this.filteredFamilies.filter(f => f.selected);

                if (selected.length === 0) {
                    showMessage('Please select at least one family to export', 'error');
                    return;
                }

                let csv = 'Family Email,Last Name,Has Account,Students,Grades,Student Count,Total Orders,Total Spent,Last Order Date,Status\n';

                const now = new Date();
                selected.forEach(family => {
                    const daysSinceOrder = family.lastOrderDate
                        ? (now - family.lastOrderDate) / (1000 * 60 * 60 * 24)
                        : Infinity;

                    let statusText = 'Active';
                    if (daysSinceOrder > 60) statusText = 'Inactive';
                    else if (daysSinceOrder > 30) statusText = 'Recent';

                    const lastOrderStr = family.lastOrderDate
                        ? family.lastOrderDate.toLocaleDateString()
                        : 'Never';

                    const studentsStr = family.students.join('; ');
                    const gradesStr = family.grades.join(', ');

                    csv += `"${family.email}",`;
                    csv += `"${family.lastName || ''}",`;
                    csv += `"${family.hasAccount ? 'Yes' : 'No'}",`;
                    csv += `"${studentsStr}",`;
                    csv += `"${gradesStr}",`;
                    csv += `${family.studentCount},`;
                    csv += `${family.totalOrders},`;
                    csv += `$${family.totalSpent.toFixed(2)},`;
                    csv += `"${lastOrderStr}",`;
                    csv += `"${statusText}"\n`;
                });

                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const date = new Date().toISOString().split('T')[0];

                link.setAttribute('href', url);
                link.setAttribute('download', `artios_cafe_selected_contacts_${date}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage(`Exported ${selected.length} selected families successfully`, 'success');
            }
        };

        // ==========================================
        // PAYMENTS / VENMO RECONCILIATION TAB
        // ==========================================

        window.PAYMENTS = {
            allOrders: [],
            filteredOrders: [],

            loadOrders: async function() {
                try {
                    showMessage('Loading orders for payment reconciliation...', 'info');

                    const response = await fetch(API_URL + '?action=get_orders_for_payment');
                    const result = await response.json();

                    if (!result.success) {
                        showMessage('Failed to load orders', 'error');
                        return;
                    }

                    this.allOrders = result.orders || [];
                    this.filteredOrders = [...this.allOrders];
                    this.filterOrders();

                    showMessage(`Loaded ${this.allOrders.length} orders`, 'success');
                } catch (error) {
                    console.error('Error loading orders:', error);
                    showMessage('Error loading orders', 'error');
                }
            },

            filterOrders: function() {
                const searchTerm = document.getElementById('payment-search').value.toLowerCase();
                const paymentFilter = document.querySelector('input[name="payment-filter"]:checked').value;
                const monthFilter = document.getElementById('payment-month-filter').value;

                this.filteredOrders = this.allOrders.filter(order => {
                    // Month filter
                    if (monthFilter) {
                        const orderDate = new Date(order.timestamp);
                        const orderMonth = `${orderDate.getFullYear()}-${String(orderDate.getMonth() + 1).padStart(2, '0')}`;
                        if (orderMonth !== monthFilter) {
                            return false;
                        }
                    }

                    // Search filter
                    if (searchTerm) {
                        const matchesEmail = order.parentEmail.toLowerCase().includes(searchTerm);
                        const matchesLastName = (order.lastName || '').toLowerCase().includes(searchTerm);
                        const matchesOrderId = order.orderId.toLowerCase().includes(searchTerm);
                        if (!matchesEmail && !matchesLastName && !matchesOrderId) {
                            return false;
                        }
                    }

                    // Payment status filter
                    if (paymentFilter === 'unpaid' && order.paymentStatus !== 'Pending') {
                        return false;
                    }
                    if (paymentFilter === 'paid' && order.paymentStatus !== 'Paid') {
                        return false;
                    }

                    return true;
                });

                this.sortOrders();
                this.displayOrders();
                this.updateSummary();
            },

            sortOrders: function() {
                const sortBy = document.getElementById('payment-sort').value;

                this.filteredOrders.sort((a, b) => {
                    switch (sortBy) {
                        case 'lastName':
                            return (a.lastName || '').localeCompare(b.lastName || '');
                        case 'orderDateNewest':
                            return new Date(b.timestamp) - new Date(a.timestamp);
                        case 'orderDateOldest':
                            return new Date(a.timestamp) - new Date(b.timestamp);
                        case 'amountHigh':
                            return b.total - a.total;
                        case 'amountLow':
                            return a.total - b.total;
                        default:
                            return (a.lastName || '').localeCompare(b.lastName || '');
                    }
                });

                this.displayOrders();
            },

            displayOrders: function() {
                const tbody = document.getElementById('payment-orders-list');

                if (this.filteredOrders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="padding: 40px; text-align: center; color: #999;">No orders match the current filters</td></tr>';
                    return;
                }

                let html = '';

                this.filteredOrders.forEach((order, index) => {
                    const orderDate = new Date(order.timestamp);
                    const orderDateStr = orderDate.toLocaleDateString() + ' ' + orderDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                    const isPaid = order.paymentStatus === 'Paid';

                    html += `
                        <tr style="border-bottom: 1px solid #e9ecef; ${isPaid ? 'opacity: 0.6;' : ''}">
                            <td style="padding: 12px; text-align: center;">
                                <input type="checkbox" class="paid-checkbox"
                                       ${isPaid ? 'checked' : ''}
                                       onchange="PAYMENTS.togglePaidStatus('${order.orderId}', this.checked)">
                            </td>
                            <td style="padding: 12px; font-weight: 600;">${order.lastName || ''}</td>
                            <td style="padding: 12px;">${order.parentEmail}</td>
                            <td style="padding: 12px; font-size: 0.85em; color: #666;">${order.orderId}</td>
                            <td style="padding: 12px; text-align: center; font-size: 0.9em;">${orderDateStr}</td>
                            <td style="padding: 12px; text-align: right; font-weight: 600; font-size: 1.1em;">$${order.total.toFixed(2)}</td>
                            <td style="padding: 12px; text-align: center; font-size: 0.9em; color: #666;">${order.itemsSummary}</td>
                        </tr>
                    `;
                });

                tbody.innerHTML = html;
            },

            updateSummary: function() {
                const unpaidOrders = this.filteredOrders.filter(o => o.paymentStatus !== 'Paid');
                const unpaidTotal = unpaidOrders.reduce((sum, o) => sum + o.total, 0);

                document.getElementById('payment-filter-results').textContent =
                    `${this.filteredOrders.length} orders (${unpaidOrders.length} unpaid)`;
                document.getElementById('payment-unpaid-summary').textContent =
                    `$${unpaidTotal.toFixed(2)} unpaid`;
            },

            togglePaidStatus: async function(orderId, isChecked) {
                try {
                    const status = isChecked ? 'Paid' : 'Pending';

                    const url = new URL(API_URL);
                    url.searchParams.append('action', 'update_payment_status');
                    url.searchParams.append('order_id', orderId);
                    url.searchParams.append('status', status);
                    url.searchParams.append('admin_email', 'Admin');

                    const response = await fetch(url);
                    const result = await response.json();

                    if (result.success) {
                        // Update locally instead of reloading - much faster!
                        const order = this.allOrders.find(o => o.orderId === orderId);
                        if (order) {
                            order.paymentStatus = status;
                            order.paymentDate = isChecked ? new Date() : null;
                        }
                        this.filterOrders(); // Re-filter and redisplay
                    } else {
                        showMessage('Failed to update payment status', 'error');
                    }
                } catch (error) {
                    console.error('Error toggling payment status:', error);
                    showMessage('Error updating payment status', 'error');
                }
            },

            exportUnpaidList: function() {
                const unpaidOrders = this.filteredOrders.filter(o => o.paymentStatus !== 'Paid');

                if (unpaidOrders.length === 0) {
                    showMessage('No unpaid orders to export', 'error');
                    return;
                }

                let csv = 'Last Name,Parent Email,Order ID,Order Date,Amount,Items,Students\n';

                unpaidOrders.forEach(order => {
                    const orderDate = new Date(order.timestamp).toLocaleDateString();
                    const students = order.children.map(c => c.name).join('; ');

                    csv += `"${order.lastName || ''}",`;
                    csv += `"${order.parentEmail}",`;
                    csv += `"${order.orderId}",`;
                    csv += `"${orderDate}",`;
                    csv += `$${order.total.toFixed(2)},`;
                    csv += `"${order.itemsSummary}",`;
                    csv += `"${students}"\n`;
                });

                // Download
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const date = new Date().toISOString().split('T')[0];

                link.setAttribute('href', url);
                link.setAttribute('download', `artios_cafe_unpaid_orders_${date}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showMessage(`Exported ${unpaidOrders.length} unpaid orders successfully`, 'success');
            }
        };

        // ==========================================
        // UTILITY FUNCTIONS
        // ==========================================

        function showMessage(message, type = 'info') {
            const messageDiv = document.getElementById('status-message');
            messageDiv.textContent = message;
            messageDiv.className = `status-message ${type} show`;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                messageDiv.classList.remove('show');
            }, 5000);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T12:00:00');
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        // API call wrapper
        async function apiCall(action, params = {}) {
            try {
                const url = new URL(API_URL);
                url.searchParams.append('action', action);
                Object.keys(params).forEach(key => {
                    url.searchParams.append(key, params[key]);
                });

                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }
    </script>
</body>
</html>
