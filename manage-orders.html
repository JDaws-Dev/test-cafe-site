.loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #17a2b8;
        }


        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .group-content {
            padding: 0;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .group-content.collapsed {
            max-height: 0;
            opacity: 0;
        }


    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxWSO9AKq5uWU7iReEoZcSx3Vn0oeL30ovCeTryKOmC2ze1kP-r7PhWBeAeIY4-82G3/exec';
        let currentItemToCancel = null;
        let allOrders = [];

        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setDefaultDate();
            // Try to load saved email from localStorage
            const savedEmail = localStorage.getItem('parentEmail');
            if (savedEmail) {
                document.getElementById('parentEmail').value = savedEmail;
                showInfo(`Welcome back! Loading orders for ${savedEmail}...`);
                setTimeout(() => loadMyOrders(), 500);
            }
        });

        function setupEventListeners() {
            // Modal close events
            document.querySelector('.close').onclick = closeModal;
            window.onclick = function(event) {
                const modal = document.getElementById('cancelModal');
                if (event.target === modal) {
                    closeModal();
                }
            };

            // Enter key functionality
            document.getElementById('parentEmail').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadMyOrders();
                }
            });

            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && document.getElementById('advanced-search').style.display !== 'none') {
                    searchOrders();
                }
            });

            // Added keyboard navigation for groups
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('cancelModal').style.display === 'block') {
                    closeModal();
                }
            });
        }

        // Enhanced loadMyOrders with better error handling and user feedback
        async function loadMyOrders() {
            const email = document.getElementById('parentEmail').value.trim();
            if (!email) {
                showError('Please enter your email address to view your orders');
                document.getElementById('parentEmail').focus();
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showError('Please enter a valid email address');
                document.getElementById('parentEmail').focus();
                return;
            }

            // Save email for future visits
            localStorage.setItem('parentEmail', email);

            const loadBtn = document.querySelector('button[onclick="loadMyOrders()"]');
            const originalText = loadBtn.textContent;
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<span class="loading-spinner"></span>Loading Orders...';

            showLoading(true, 'Loading your orders...');

            try {
                const searchUrl = `${API_URL}?action=lookup_orders&email=${encodeURIComponent(email)}`;
                const response = await fetch(searchUrl);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.success && data.orders && data.orders.length > 0) {
                    allOrders = data.orders;
                    displayGroupedOrders(data.orders);
                    document.getElementById('grouped-orders-section').style.display = 'block';
                    showSuccess(`Found ${data.orders.length} order${data.orders.length !== 1 ? 's' : ''} for ${email}`);
                } else if (data.success && (!data.orders || data.orders.length === 0)) {
                    showInfo(`No orders found for ${email}. Orders will appear here after you place them.`);
                    document.getElementById('grouped-orders-section').style.display = 'none';
                } else {
                    showError(data.error || 'Unable to load orders. Please try again.');
                    document.getElementById('grouped-orders-section').style.display = 'none';
                }
            } catch (error) {
                console.error('Load orders error:', error);
                showError('Unable to connect to the server. Please check your internet connection and try again.');
                document.getElementById('grouped-orders-section').style.display = 'none';
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = originalText;
                showLoading(false);
            }
        }

        // Enhanced displayGroupedOrders with better animations
        function displayGroupedOrders(orders) {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const sevenDaysFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

            // Group orders by category
            const todayOrders = [];
            const upcomingOrders = [];
            const recentOrders = [];

            orders.forEach(order => {
                order.items.forEach(item => {
                    const itemDate = new Date(item.date);
                    const orderWithItem = { ...order, currentItem: item };

                    if (item.date === todayStr) {
                        todayOrders.push(orderWithItem);
                    } else if (itemDate > today && itemDate <= sevenDaysFromNow) {
                        upcomingOrders.push(orderWithItem);
                    } else if (itemDate >= thirtyDaysAgo && itemDate < today) {
                        recentOrders.push(orderWithItem);
                    }
                });
            });

            // Display each group with animation
            setTimeout(() => displayOrderGroup('today', todayOrders, 'No orders for today'), 100);
            setTimeout(() => displayOrderGroup('upcoming', upcomingOrders, 'No upcoming orders in the next 7 days'), 200);
            setTimeout(() => displayOrderGroup('recent', recentOrders, 'No recent orders in the last 30 days'), 300);
        }

        // Enhanced displayOrderGroup with better formatting
        function displayOrderGroup(groupId, orders, emptyMessage) {
            const contentDiv = document.getElementById(`${groupId}-content`);
            
            if (orders.length === 0) {
                contentDiv.innerHTML = `<div class="empty-group">${emptyMessage}</div>`;
                contentDiv.classList.add('fade-in');
                return;
            }

            // Sort orders by date
            orders.sort((a, b) => new Date(a.currentItem.date) - new Date(b.currentItem.date));

            const totalItems = orders.length;
            const activeItems = orders.filter(order => order.currentItem.status === 'active').length;
            const cancelledItems = totalItems - activeItems;

            let tableHtml = `
                <div class="order-summary">
                    ${totalItems} item${totalItems !== 1 ? 's' : ''} found
                    ${cancelledItems > 0 ? ` (${activeItems} active, ${cancelledItems} cancelled)` : ''}
                </div>
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Child Name</th>
                            <th>Item</th>
                            <th>Day</th>
                            <th>Date</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            orders.forEach(order => {
                const item = order.currentItem;
                const statusClass = item.status === 'cancelled' ? 'status-cancelled' : 'status-active';
                const itemDate = new Date(item.date);
                const today = new Date();
                const cutoffTime = new Date(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate(), 8, 15, 0);
                const canCancel = item.status === 'active' && new Date() <= cutoffTime;
                
                let actionButton;
                if (item.status === 'cancelled') {
                    actionButton = '<span style="color: #6c757d;">Cancelled</span>';
                } else if (!canCancel) {
                    actionButton = '<span style="color: #6c757d;" title="Past 8:15 AM deadline">Cannot Cancel</span>';
                } else {
                    actionButton = `<button class="btn btn-danger" onclick="showCancelModal('${item.id}', '${item.name}', '${item.childName}', '${item.day}', '${item.date}', ${item.price})" title="Cancel this item">Cancel</button>`;
                }

                tableHtml += `
                    <tr>
                        <td>${item.childName}</td>
                        <td>${item.name}</td>
                        <td>${item.day}</td>
                        <td>${itemDate.toLocaleDateString()}</td>
                        <td>$${item.price.toFixed(2)}</td>
                        <td><span class="status-badge ${statusClass}">${item.status}</span></td>
                        <td>${actionButton}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';
            contentDiv.innerHTML = tableHtml;
            contentDiv.classList.add('fade-in');
        }

        function toggleGroup(groupId) {
            const content = document.getElementById(`${groupId}-content`);
            const icon = document.getElementById(`${groupId}-icon`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('rotated');
                icon.textContent = '▼';
            } else {
                content.classList.add('collapsed');
                icon.classList.add('rotated');
                icon.textContent = '▶';
            }
        }

        function toggleAdvancedSearch() {
            const searchSection = document.getElementById('advanced-search');
            const btn = document.getElementById('advanced-search-btn');
            
            if (searchSection.style.display === 'none') {
                searchSection.style.display = 'block';
                searchSection.classList.add('fade-in');
                btn.textContent = 'Hide Advanced Search';
            } else {
                searchSection.style.display = 'none';
                btn.textContent = 'Show Advanced Search';
            }
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('searchDate').value = today;
        }

        async function searchOrders() {
            const email = document.getElementById('searchEmail').value.trim();
            const orderId = document.getElementById('searchOrderId').value.trim();
            const date = document.getElementById('searchDate').value;
            const status = document.getElementById('searchStatus').value;

            if (!email && !orderId && !date) {
                showError('Please enter at least one search criteria');
                return;
            }

            showLoading(true, 'Searching orders...');

            try {
                let searchUrl = `${API_URL}?action=lookup_orders`;
                
                if (email) searchUrl += `&email=${encodeURIComponent(email)}`;
                if (orderId) searchUrl += `&order_id=${encodeURIComponent(orderId)}`;

                const response = await fetch(searchUrl);
                const data = await response.json();

                if (data.success && data.orders) {
                    let filteredOrders = data.orders;

                    // Filter by date if specified
                    if (date) {
                        filteredOrders = filteredOrders.filter(order => {
                            return order.items.some(item => item.date === date);
                        });
                    }

                    // Filter by status if specified
                    if (status) {
                        filteredOrders = filteredOrders.filter(order => {
                            return order.items.some(item => item.status === status);
                        });
                    }

                    displayOrders(filteredOrders);
                } else {
                    showError(data.error || 'No orders found matching your search criteria');
                }
            } catch (error) {
                console.error('Search error:', error);
                showError('Search failed. Please check your connection and try again.');
            } finally {
                showLoading(false);
            }
        }

        function displayOrders(orders) {
            const resultsSection = document.getElementById('results-section');
            
            if (orders.length === 0) {
                resultsSection.innerHTML = '<div class="info">No orders found matching your search criteria. Try adjusting your filters.</div>';
                return;
            }

            let tableHtml = `
                <h3>Search Results (${orders.length} order${orders.length !== 1 ? 's' : ''} found)</h3>
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Parent Email</th>
                            <th>Child Name</th>
                            <th>Item</th>
                            <th>Day</th>
                            <th>Date</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            orders.forEach(order => {
                order.items.forEach(item => {
                    const statusClass = item.status === 'cancelled' ? 'status-cancelled' : 'status-active';
                    const itemDate = new Date(item.date);
                    const cutoffTime = new Date(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate(), 8, 15, 0);
                    const canCancel = item.status === 'active' && new Date() <= cutoffTime;
                    
                    let actionButton;
                    if (item.status === 'cancelled') {
                        actionButton = '<span style="color: #6c757d;">Cancelled</span>';
                    } else if (!canCancel) {
                        actionButton = '<span style="color: #6c757d;" title="Past 8:15 AM deadline">Cannot Cancel</span>';
                    } else {
                        actionButton = `<button class="btn btn-danger" onclick="showCancelModal('${item.id}', '${item.name}', '${item.childName}', '${item.day}', '${item.date}', ${item.price})">Cancel</button>`;
                    }

                    tableHtml += `
                        <tr>
                            <td>${order.orderId}</td>
                            <td>${order.email}</td>
                            <td>${item.childName}</td>
                            <td>${item.name}</td>
                            <td>${item.day}</td>
                            <td>${itemDate.toLocaleDateString()}</td>
                            <td>$${item.price.toFixed(2)}</td>
                            <td><span class="status-badge ${statusClass}">${item.status}</span></td>
                            <td>${actionButton}</td>
                        </tr>
                    `;
                });
            });

            tableHtml += '</tbody></table>';
            resultsSection.innerHTML = tableHtml;
        }

        function showCancelModal(itemId, itemName, childName, day, date, price) {
            currentItemToCancel = itemId;
            
            document.getElementById('cancelItemDetails').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0;">
                    <strong>Item:</strong> ${itemName}<br>
                    <strong>Student:</strong> ${childName}<br>
                    <strong>Day:</strong> ${day}<br>
                    <strong>Date:</strong> ${new Date(date).toLocaleDateString()}<br>
                    <strong>Price:</strong> $${price.toFixed(2)}
                </div>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #2196f3;">
                    <strong>Refund Information:</strong><br>
                    • You will receive a confirmation email<br>
                    • Refund will be sent via Venmo within 24 hours<br>
                    • Amount: $${price.toFixed(2)}
                </div>
            `;
            
            document.getElementById('cancelModal').style.display = 'block';
            document.getElementById('cancelReason').focus();
        }

        function closeModal() {
            document.getElementById('cancelModal').style.display = 'none';
            currentItemToCancel = null;
        }

        // Enhanced confirmCancellation with better user feedback and auto-refresh
        async function confirmCancellation() {
            if (!currentItemToCancel) return;

            const reason = document.getElementById('cancelReason').value;
            const confirmBtn = document.getElementById('confirmCancelBtn');
            
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="loading-spinner"></span>Processing...';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'cancel_item',
                        item_id: currentItemToCancel,
                        reason: reason
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(`Item cancelled successfully! You will receive a confirmation email, and your refund of $${result.refundAmount.toFixed(2)} will be processed via Venmo within 24 hours.`);
                    closeModal();
                    
                    // Auto-refresh the orders after successful cancellation
                    const email = document.getElementById('parentEmail').value.trim();
                    if (email && document.getElementById('grouped-orders-section').style.display !== 'none') {
                        setTimeout(() => {
                            showInfo('Refreshing your orders...');
                            loadMyOrders();
                        }, 2000);
                    } else {
                        setTimeout(() => {
                            searchOrders();
                        }, 1000);
                    }
                } else {
                    showError(`Cancellation failed: ${result.message || result.error}`);
                }
            } catch (error) {
                console.error('Cancellation error:', error);
                showError('Unable to process cancellation. Please check your connection and try again.');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm Cancellation';
            }
        }

        // Enhanced loading function with custom messages
        function showLoading(show, message = 'Loading...') {
            const resultsSection = document.getElementById('results-section');
            if (show) {
                resultsSection.innerHTML = `<div class="loading" id="loading"><div class="loading-spinner"></div><p>${message}</p></div>`;
            }
        }

        function showError(message) {
            const resultsSection = document.getElementById('results-section');
            resultsSection.innerHTML = `<div class="error">❌ ${message}</div>`;
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function showSuccess(message) {
            const resultsSection = document.getElementById('results-section');
            const successDiv = document.createElement('div');
            successDiv.className = 'success fade-in';
            successDiv.innerHTML = `✅ ${message}`;
            resultsSection.insertBefore(successDiv, resultsSection.firstChild);
            
            successDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 8000);
        }

        // Added showInfo function for informational messages
        function showInfo(message) {
            const resultsSection = document.getElementById('results-section');
            const infoDiv = document.createElement('div');
            infoDiv.className = 'info fade-in';
            infoDiv.innerHTML = `ℹ️ ${message}`;
            resultsSection.insertBefore(infoDiv, resultsSection.firstChild);
            
            setTimeout(() => {
                if (infoDiv.parentNode) {
                    infoDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>
