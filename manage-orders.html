<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Orders - Artios Academies Lunch Program</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 10px;
        }

        .header h1 {
            margin: 0;
            text-align: center;
            font-size: 2.5em;
            font-weight: 300;
        }

        .nav {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            gap: 30px;
        }

        .nav a {
            text-decoration: none;
            color: #333;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }

        .nav a:hover, .nav a.active {
            background: #667eea;
            color: white;
        }

        .main-section {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .email-section {
            text-align: center;
            margin-bottom: 30px;
        }

        .email-section h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .email-input-group {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .email-input-group input {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            min-width: 250px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .order-group {
            margin-bottom: 25px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            overflow: hidden;
        }

        .group-header {
            background: #f8f9fa;
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s ease;
        }

        .group-header:hover {
            background: #e9ecef;
        }

        .group-title {
            font-weight: 600;
            color: #495057;
        }

        .group-icon {
            font-size: 14px;
            transition: transform 0.3s ease;
        }

        .group-icon.rotated {
            transform: rotate(-90deg);
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .orders-table th,
        .orders-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .orders-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }

        .orders-table tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            text-transform: uppercase;
        }

        .status-active {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        .empty-group {
            padding: 20px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        .order-summary {
            padding: 10px 15px;
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .advanced-search {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
            display: none;
        }

        .search-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-field {
            flex: 1;
            min-width: 200px;
        }

        .search-field label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #495057;
        }

        .search-field input,
        .search-field select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 15px;
            top: 15px;
        }

        .close:hover {
            color: #000;
        }

        .modal h2 {
            margin-top: 0;
            color: #dc3545;
        }

        .modal textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            resize: vertical;
            min-height: 80px;
            margin: 15px 0;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4285f4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #dc3545;
        }

        .success {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #28a745;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #17a2b8;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .group-content {
            padding: 0;
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.3s ease;
        }

        .group-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        .cancelled-item {
            background-color: #f8f9fa !important;
            opacity: 0.7;
        }

        .cancelled-badge {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2em;
            }

            .nav ul {
                flex-direction: column;
                gap: 10px;
            }

            .email-input-group {
                flex-direction: column;
                align-items: center;
            }

            .search-row {
                flex-direction: column;
            }

            .orders-table {
                font-size: 14px;
            }

            .orders-table th,
            .orders-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Manage Orders</h1>
        </div>

        <nav class="nav">
            <ul>
                <li><a href="dashboard.html">Dashboard</a></li>
                <li><a href="manage-orders.html" class="active">Manage Orders</a></li>
                <li><a href="login.html">Logout</a></li>
            </ul>
        </nav>

        <div class="main-section">
            <div class="email-section">
                <h2>View Your Orders</h2>
                <p>Enter your email address to view and manage your lunch orders</p>
                <div class="email-input-group">
                    <input type="email" id="parentEmail" placeholder="Enter your email address" required>
                    <button class="btn" onclick="loadMyOrders()">Load My Orders</button>
                </div>
                <button class="btn btn-secondary" id="advanced-search-btn" onclick="toggleAdvancedSearch()">Show Advanced Search</button>
            </div>

            <div id="grouped-orders-section" style="display: none;">
                <h3>Your Orders</h3>
                
                <div class="order-group">
                    <div class="group-header" onclick="toggleGroup('today')">
                        <span class="group-title">Today's Orders</span>
                        <span class="group-icon" id="today-icon">▼</span>
                    </div>
                    <div class="group-content" id="today-content">
                        <!-- Today's orders will be loaded here -->
                    </div>
                </div>

                <div class="order-group">
                    <div class="group-header" onclick="toggleGroup('upcoming')">
                        <span class="group-title">Upcoming Orders (Next 7 Days)</span>
                        <span class="group-icon" id="upcoming-icon">▼</span>
                    </div>
                    <div class="group-content" id="upcoming-content">
                        <!-- Upcoming orders will be loaded here -->
                    </div>
                </div>

                <div class="order-group">
                    <div class="group-header" onclick="toggleGroup('recent')">
                        <span class="group-title">Recent Orders (Last 30 Days)</span>
                        <span class="group-icon" id="recent-icon">▼</span>
                    </div>
                    <div class="group-content" id="recent-content">
                        <!-- Recent orders will be loaded here -->
                    </div>
                </div>
            </div>

            <div class="advanced-search" id="advanced-search">
                <h3>Advanced Search</h3>
                <div class="search-row">
                    <div class="search-field">
                        <label for="searchEmail">Email Address:</label>
                        <input type="email" id="searchEmail" placeholder="parent@example.com">
                    </div>
                    <div class="search-field">
                        <label for="searchOrderId">Order ID:</label>
                        <input type="text" id="searchOrderId" placeholder="Enter order ID">
                    </div>
                </div>
                <div class="search-row">
                    <div class="search-field">
                        <label for="searchDate">Date:</label>
                        <input type="date" id="searchDate">
                    </div>
                    <div class="search-field">
                        <label for="searchStatus">Status:</label>
                        <select id="searchStatus">
                            <option value="">All Statuses</option>
                            <option value="active">Active</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="searchOrders()">Search Orders</button>
                </div>
            </div>

            <div id="results-section">
                <!-- Search results will appear here -->
            </div>
        </div>
    </div>

    <!-- Cancel Order Modal -->
    <div id="cancelModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Cancel Order Item</h2>
            <p>Are you sure you want to cancel this item?</p>
            <div id="cancelItemDetails"></div>
            <label for="cancelReason">Reason for cancellation (optional):</label>
            <textarea id="cancelReason" placeholder="Please let us know why you're cancelling this item..."></textarea>
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal()">Keep Item</button>
                <button class="btn btn-danger" id="confirmCancelBtn" onclick="confirmCancellation()">Confirm Cancellation</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxWSO9AKq5uWU7iReEoZcSx3Vn0oeL30ovCeTryKOmC2ze1kP-r7PhWBeAeIY4-82G3/exec';
        let currentItemToCancel = null;
        let allOrders = [];

        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            setDefaultDate();
            // Try to load saved email from localStorage
            const savedEmail = localStorage.getItem('parentEmail');
            if (savedEmail) {
                document.getElementById('parentEmail').value = savedEmail;
                showInfo(`Welcome back! Loading orders for ${savedEmail}...`);
                setTimeout(() => loadMyOrders(), 500);
            }
        });

        function setupEventListeners() {
            // Modal close events
            document.querySelector('.close').onclick = closeModal;
            window.onclick = function(event) {
                const modal = document.getElementById('cancelModal');
                if (event.target === modal) {
                    closeModal();
                }
            };

            // Enter key functionality
            document.getElementById('parentEmail').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    loadMyOrders();
                }
            });

            document.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && document.getElementById('advanced-search').style.display !== 'none') {
                    searchOrders();
                }
            });

            // Added keyboard navigation for groups
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && document.getElementById('cancelModal').style.display === 'block') {
                    closeModal();
                }
            });
        }

        // Enhanced loadMyOrders with better error handling and user feedback
        async function loadMyOrders() {
            const email = document.getElementById('parentEmail').value.trim();
            if (!email) {
                showError('Please enter your email address to view your orders');
                document.getElementById('parentEmail').focus();
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                showError('Please enter a valid email address');
                document.getElementById('parentEmail').focus();
                return;
            }

            // Save email for future visits
            localStorage.setItem('parentEmail', email);

            const loadBtn = document.querySelector('button[onclick="loadMyOrders()"]');
            const originalText = loadBtn.textContent;
            loadBtn.disabled = true;
            loadBtn.innerHTML = '<span class="loading-spinner"></span>Loading Orders...';

            showLoading(true, 'Loading your orders...');

            try {
                const searchUrl = `${API_URL}?action=lookup_orders&email=${encodeURIComponent(email)}`;
                const response = await fetch(searchUrl);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();

                if (data.success && data.orders && data.orders.length > 0) {
                    allOrders = data.orders;
                    displayGroupedOrders(data.orders);
                    document.getElementById('grouped-orders-section').style.display = 'block';
                    showSuccess(`Found ${data.orders.length} order${data.orders.length !== 1 ? 's' : ''} for ${email}`);
                } else if (data.success && (!data.orders || data.orders.length === 0)) {
                    showInfo(`No orders found for ${email}. Orders will appear here after you place them.`);
                    document.getElementById('grouped-orders-section').style.display = 'none';
                } else {
                    showError(data.error || 'Unable to load orders. Please try again.');
                    document.getElementById('grouped-orders-section').style.display = 'none';
                }
            } catch (error) {
                console.error('Load orders error:', error);
                showError('Unable to connect to the server. Please check your internet connection and try again.');
                document.getElementById('grouped-orders-section').style.display = 'none';
            } finally {
                loadBtn.disabled = false;
                loadBtn.textContent = originalText;
                showLoading(false);
            }
        }

        // Enhanced displayGroupedOrders with better animations
        function displayGroupedOrders(orders) {
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const sevenDaysFromNow = new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
            const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

            // Group orders by category
            const todayOrders = [];
            const upcomingOrders = [];
            const recentOrders = [];

            orders.forEach(order => {
                order.items.forEach(item => {
                    const itemDate = new Date(item.date);
                    const orderWithItem = { ...order, currentItem: item };

                    if (item.date === todayStr) {
                        todayOrders.push(orderWithItem);
                    } else if (itemDate > today && itemDate <= sevenDaysFromNow) {
                        upcomingOrders.push(orderWithItem);
                    } else if (itemDate >= thirtyDaysAgo && itemDate < today) {
                        recentOrders.push(orderWithItem);
                    }
                });
            });

            // Display each group with animation
            setTimeout(() => displayOrderGroup('today', todayOrders, 'No orders for today'), 100);
            setTimeout(() => displayOrderGroup('upcoming', upcomingOrders, 'No upcoming orders in the next 7 days'), 200);
            setTimeout(() => displayOrderGroup('recent', recentOrders, 'No recent orders in the last 30 days'), 300);
        }

        // Enhanced displayOrderGroup with simplified cancelled item display
        function displayOrderGroup(groupId, orders, emptyMessage) {
            const contentDiv = document.getElementById(`${groupId}-content`);
            
            if (orders.length === 0) {
                contentDiv.innerHTML = `<div class="empty-group">${emptyMessage}</div>`;
                contentDiv.classList.add('fade-in');
                return;
            }

            // Sort orders by date
            orders.sort((a, b) => new Date(a.currentItem.date) - new Date(b.currentItem.date));

            const totalItems = orders.length;
            const activeItems = orders.filter(order => order.currentItem.status === 'active').length;
            const cancelledItems = totalItems - activeItems;

            let tableHtml = `
                <div class="order-summary">
                    ${totalItems} item${totalItems !== 1 ? 's' : ''} found
                    ${cancelledItems > 0 ? ` (${activeItems} active, ${cancelledItems} cancelled)` : ''}
                </div>
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Child Name</th>
                            <th>Item</th>
                            <th>Day</th>
                            <th>Date</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            orders.forEach(order => {
                const item = order.currentItem;
                const statusClass = item.status === 'cancelled' ? 'status-cancelled' : 'status-active';
                const itemDate = new Date(item.date);
                const today = new Date();
                const cutoffTime = new Date(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate(), 8, 15, 0);
                const canCancel = item.status === 'active' && new Date() <= cutoffTime;
                
                // Row styling for cancelled items
                const rowClass = item.status === 'cancelled' ? 'cancelled-item' : '';
                const itemNameDisplay = item.status === 'cancelled' ? `<del>${item.name}</del>` : item.name;
                const priceDisplay = item.status === 'cancelled' ? `<del>${item.price.toFixed(2)}</del>` : `${item.price.toFixed(2)}`;
                
                let actionButton;
                if (item.status === 'cancelled') {
                    const cancelDate = item.cancellationDate ? new Date(item.cancellationDate).toLocaleDateString() : 'Unknown';
                    actionButton = `<span class="cancelled-badge">Cancelled ${cancelDate}</span>`;
                } else if (!canCancel) {
                    actionButton = '<span style="color: #6c757d;" title="Past 8:15 AM deadline">Cannot Cancel</span>';
                } else {
                    actionButton = `<button class="btn btn-danger" onclick="showCancelModal('${item.id}', '${item.name}', '${item.childName}', '${item.day}', '${item.date}', ${item.price})" title="Cancel this item">Cancel</button>`;
                }

                tableHtml += `
                    <tr class="${rowClass}">
                        <td>${item.childName}</td>
                        <td>${itemNameDisplay}</td>
                        <td>${item.day}</td>
                        <td>${itemDate.toLocaleDateString()}</td>
                        <td>${priceDisplay}</td>
                        <td><span class="status-badge ${statusClass}">${item.status === 'cancelled' ? `Cancelled - ${item.price.toFixed(2)} refund` : item.status}</span></td>
                        <td>${actionButton}</td>
                    </tr>
                `;
            });

            tableHtml += '</tbody></table>';
            contentDiv.innerHTML = tableHtml;
            contentDiv.classList.add('fade-in');
        }

        function toggleGroup(groupId) {
            const content = document.getElementById(`${groupId}-content`);
            const icon = document.getElementById(`${groupId}-icon`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                icon.classList.remove('rotated');
                icon.textContent = '▼';
            } else {
                content.classList.add('collapsed');
                icon.classList.add('rotated');
                icon.textContent = '▶';
            }
        }

        function toggleAdvancedSearch() {
            const searchSection = document.getElementById('advanced-search');
            const btn = document.getElementById('advanced-search-btn');
            
            if (searchSection.style.display === 'none') {
                searchSection.style.display = 'block';
                searchSection.classList.add('fade-in');
                btn.textContent = 'Hide Advanced Search';
            } else {
                searchSection.style.display = 'none';
                btn.textContent = 'Show Advanced Search';
            }
        }

        function setDefaultDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('searchDate').value = today;
        }

        async function searchOrders() {
            const email = document.getElementById('searchEmail').value.trim();
            const orderId = document.getElementById('searchOrderId').value.trim();
            const date = document.getElementById('searchDate').value;
            const status = document.getElementById('searchStatus').value;

            if (!email && !orderId && !date) {
                showError('Please enter at least one search criteria');
                return;
            }

            showLoading(true, 'Searching orders...');

            try {
                let searchUrl = `${API_URL}?action=lookup_orders`;
                
                if (email) searchUrl += `&email=${encodeURIComponent(email)}`;
                if (orderId) searchUrl += `&order_id=${encodeURIComponent(orderId)}`;

                const response = await fetch(searchUrl);
                const data = await response.json();

                if (data.success && data.orders) {
                    let filteredOrders = data.orders;

                    // Filter by date if specified
                    if (date) {
                        filteredOrders = filteredOrders.filter(order => {
                            return order.items.some(item => item.date === date);
                        });
                    }

                    // Filter by status if specified
                    if (status) {
                        filteredOrders = filteredOrders.filter(order => {
                            return order.items.some(item => item.status === status);
                        });
                    }

                    displayOrders(filteredOrders);
                } else {
                    showError(data.error || 'No orders found matching your search criteria');
                }
            } catch (error) {
                console.error('Search error:', error);
                showError('Search failed. Please check your connection and try again.');
            } finally {
                showLoading(false);
            }
        }

        function displayOrders(orders) {
            const resultsSection = document.getElementById('results-section');
            
            if (orders.length === 0) {
                resultsSection.innerHTML = '<div class="info">No orders found matching your search criteria. Try adjusting your filters.</div>';
                return;
            }

            let tableHtml = `
                <h3>Search Results (${orders.length} order${orders.length !== 1 ? 's' : ''} found)</h3>
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Parent Email</th>
                            <th>Child Name</th>
                            <th>Item</th>
                            <th>Day</th>
                            <th>Date</th>
                            <th>Price</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            orders.forEach(order => {
                order.items.forEach(item => {
                    const statusClass = item.status === 'cancelled' ? 'status-cancelled' : 'status-active';
                    const itemDate = new Date(item.date);
                    const cutoffTime = new Date(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate(), 8, 15, 0);
                    const canCancel = item.status === 'active' && new Date() <= cutoffTime;
                    
                    // Row styling for cancelled items
                    const rowClass = item.status === 'cancelled' ? 'cancelled-item' : '';
                    const itemNameDisplay = item.status === 'cancelled' ? `<del>${item.name}</del>` : item.name;
                    const priceDisplay = item.status === 'cancelled' ? `<del>${item.price.toFixed(2)}</del>` : `${item.price.toFixed(2)}`;
                    
                    let actionButton;
                    if (item.status === 'cancelled') {
                        const cancelDate = item.cancellationDate ? new Date(item.cancellationDate).toLocaleDateString() : 'Unknown';
                        actionButton = `<span class="cancelled-badge">Cancelled ${cancelDate}</span>`;
                    } else if (!canCancel) {
                        actionButton = '<span style="color: #6c757d;" title="Past 8:15 AM deadline">Cannot Cancel</span>';
                    } else {
                        actionButton = `<button class="btn btn-danger" onclick="showCancelModal('${item.id}', '${item.name}', '${item.childName}', '${item.day}', '${item.date}', ${item.price})">Cancel</button>`;
                    }

                    tableHtml += `
                        <tr class="${rowClass}">
                            <td>${order.orderId}</td>
                            <td>${order.email}</td>
                            <td>${item.childName}</td>
                            <td>${itemNameDisplay}</td>
                            <td>${item.day}</td>
                            <td>${itemDate.toLocaleDateString()}</td>
                            <td>${priceDisplay}</td>
                            <td><span class="status-badge ${statusClass}">${item.status === 'cancelled' ? `Cancelled - ${item.price.toFixed(2)} refund` : item.status}</span></td>
                            <td>${actionButton}</td>
                        </tr>
                    `;
                });
            });

            tableHtml += '</tbody></table>';
            resultsSection.innerHTML = tableHtml;
        }

        function showCancelModal(itemId, itemName, childName, day, date, price) {
            currentItemToCancel = itemId;
            
            document.getElementById('cancelItemDetails').innerHTML = `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 15px 0;">
                    <strong>Item:</strong> ${itemName}<br>
                    <strong>Student:</strong> ${childName}<br>
                    <strong>Day:</strong> ${day}<br>
                    <strong>Date:</strong> ${new Date(date).toLocaleDateString()}<br>
                    <strong>Price:</strong> ${price.toFixed(2)}
                </div>
                <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #2196f3;">
                    <strong>Refund Information:</strong><br>
                    • You will receive a confirmation email<br>
                    • Refund will be sent via Venmo within 24 hours<br>
                    • Amount: ${price.toFixed(2)}<br>
                    • This cancellation will be processed as part of your current session
                </div>
            `;
            
            document.getElementById('cancelModal').style.display = 'block';
            document.getElementById('cancelReason').focus();
        }

        function closeModal() {
            document.getElementById('cancelModal').style.display = 'none';
            currentItemToCancel = null;
        }

        // Enhanced confirmCancellation with session-based processing
        async function confirmCancellation() {
            if (!currentItemToCancel) return;

            const reason = document.getElementById('cancelReason').value;
            const confirmBtn = document.getElementById('confirmCancelBtn');
            
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="loading-spinner"></span>Processing...';

            try {
                // Generate session ID for this cancellation
                const sessionId = generateSessionId();
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: new URLSearchParams({
                        action: 'cancel_item',
                        item_id: currentItemToCancel,
                        reason: reason,
                        session_id: sessionId
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(`Item cancelled successfully! You will receive a confirmation email with refund details.`);
                    closeModal();
                    
                    // Auto-refresh the orders after successful cancellation
                    const email = document.getElementById('parentEmail').value.trim();
                    if (email && document.getElementById('grouped-orders-section').style.display !== 'none') {
                        setTimeout(() => {
                            showInfo('Refreshing your orders...');
                            loadMyOrders();
                        }, 2000);
                    } else {
                        setTimeout(() => {
                            searchOrders();
                        }, 1000);
                    }
                } else {
                    showError(`Cancellation failed: ${result.message || result.error}`);
                }
            } catch (error) {
                console.error('Cancellation error:', error);
                showError('Unable to process cancellation. Please check your connection and try again.');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Confirm Cancellation';
            }
        }

        // Generate session ID
        function generateSessionId() {
            const now = new Date();
            const datePart = now.toISOString().slice(2, 10).replace(/-/g, '');
            const timePart = now.toTimeString().slice(0, 8).replace(/:/g, '');
            const randomPart = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `S${datePart}${timePart}${randomPart}`;
        }

        // Enhanced loading function with custom messages
        function showLoading(show, message = 'Loading...') {
            const resultsSection = document.getElementById('results-section');
            if (show) {
                resultsSection.innerHTML = `<div class="loading" id="loading"><div class="loading-spinner"></div><p>${message}</p></div>`;
            }
        }

        function showError(message) {
            const resultsSection = document.getElementById('results-section');
            resultsSection.innerHTML = `<div class="error">❌ ${message}</div>`;
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function showSuccess(message) {
            const resultsSection = document.getElementById('results-section');
            const successDiv = document.createElement('div');
            successDiv.className = 'success fade-in';
            successDiv.innerHTML = `✅ ${message}`;
            resultsSection.insertBefore(successDiv, resultsSection.firstChild);
            
            successDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.remove();
                }
            }, 8000);
        }

        // Added showInfo function for informational messages
        function showInfo(message) {
            const resultsSection = document.getElementById('results-section');
            const infoDiv = document.createElement('div');
            infoDiv.className = 'info fade-in';
            infoDiv.innerHTML = `ℹ️ ${message}`;
            resultsSection.insertBefore(infoDiv, resultsSection.firstChild);
            
            setTimeout(() => {
                if (infoDiv.parentNode) {
                    infoDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>
</html>      // Enhanced showInfo function for session-based messaging
      function showInfo(message) {
        const resultsSection = document.getElementById('results-section');
        const infoDiv = document.createElement('div');
        infoDiv.className = 'info fade-in';
        infoDiv.innerHTML = `ℹ️ ${message}`;
        resultsSection.insertBefore(infoDiv, resultsSection.firstChild);
        
        setTimeout(() => {
          if (infoDiv.parentNode) {
            infoDiv.remove();
          }
        }, 5000);
      }

      // Initialize session-based features on page load
      document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
        setDefaultDate();
        initializeBatchCancellation();
        
        // Try to load saved email from localStorage
        const savedEmail = localStorage.getItem('parentEmail');
        if (savedEmail) {
          document.getElementById('parentEmail').value = savedEmail;
          showInfo(`Welcome back! Loading orders for ${savedEmail}...`);
          setTimeout(() => loadMyOrders(), 500);
        }
      });    .cancelled-item {
      background-color: #f8f9fa !important;
      opacity: 0.7;
    }

    .cancelled-badge {
      background: #dc3545;
      color: white;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 0.75em;
      font-weight: 500;
    }    // Enhanced displayOrderGroup with simplified cancelled item display
    function displayOrderGroup(groupId, orders, emptyMessage) {
      const contentDiv = document.getElementById(`${groupId}-content`);
      
      if (orders.length === 0) {
        contentDiv.innerHTML = `<div class="empty-group">${emptyMessage}</div>`;
        contentDiv.classList.add('fade-in');
        return;
      }

      // Sort orders by date
      orders.sort((a, b) => new Date(a.currentItem.date) - new Date(b.currentItem.date));

      const totalItems = orders.length;
      const activeItems = orders.filter(order => order.currentItem.status === 'active').length;
      const cancelledItems = totalItems - activeItems;

      let tableHtml = `
        <div class="order-summary">
          ${totalItems} item${totalItems !== 1 ? 's' : ''} found
          ${cancelledItems > 0 ? ` (${activeItems} active, ${cancelledItems} cancelled)` : ''}
        </div>
        <table class="orders-table">
          <thead>
            <tr>
              <th>Child Name</th>
              <th>Item</th>
              <th>Day</th>
              <th>Date</th>
              <th>Price</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
      `;

      orders.forEach(order => {
        const item = order.currentItem;
        const statusClass = item.status === 'cancelled' ? 'status-cancelled' : 'status-active';
        const itemDate = new Date(item.date);
        const today = new Date();
        const cutoffTime = new Date(itemDate.getFullYear(), itemDate.getMonth(), itemDate.getDate(), 8, 15, 0);
        const canCancel = item.status === 'active' && new Date() <= cutoffTime;
        
        // Row styling for cancelled items
        const rowClass = item.status === 'cancelled' ? 'cancelled-item' : '';
        const itemNameDisplay = item.status === 'cancelled' ? `<del>${item.name}</del>` : item.name;
        const priceDisplay = item.status === 'cancelled' ? `<del>$${item.price.toFixed(2)}</del>` : `$${item.price.toFixed(2)}`;
        
        let actionButton;
        if (item.status === 'cancelled') {
          const cancelDate = item.cancellationDate ? new Date(item.cancellationDate).toLocaleDateString() : 'Unknown';
          actionButton = `<span class="cancelled-badge">Cancelled ${cancelDate}</span>`;
        } else if (!canCancel) {
          actionButton = '<span style="color: #6c757d;" title="Past 8:15 AM deadline">Cannot Cancel</span>';
        } else {
          actionButton = `<button class="btn btn-danger" onclick="showCancelModal('${item.id}', '${item.name}', '${item.childName}', '${item.day}', '${item.date}', ${item.price})" title="Cancel this item">Cancel</button>`;
        }

        tableHtml += `
          <tr class="${rowClass}">
            <td>${item.childName}</td>
            <td>${itemNameDisplay}</td>
            <td>${item.day}</td>
            <td>${itemDate.toLocaleDateString()}</td>
            <td>${priceDisplay}</td>
            <td><span class="status-badge ${statusClass}">${item.status === 'cancelled' ? `Cancelled - $${item.price.toFixed(2)} refund` : item.status}</span></td>
            <td>${actionButton}</td>
          </tr>
        `;
      });

      tableHtml += '</tbody></table>';
      contentDiv.innerHTML = tableHtml;
      contentDiv.classList.add('fade-in');
    }
