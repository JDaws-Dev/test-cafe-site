<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orders â€” Fixed (Everything)</title>
  <style>
    :root{
      --border:#e5e7eb; --muted:#6b7280; --brand:#2563eb; --ok:#16a34a; --err:#ef4444;
      --pad:14px;
    }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Arial,Helvetica,sans-serif;margin:0;color:#111827;background:#fff;}
    header{padding:16px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;}
    h1{font-size:20px;margin:0;}
    .wrap{max-width:1100px;margin:0 auto;padding:18px;}
    /* Week & tabs */
    #week-indicator{background:#fef3c7;border:1px solid #f59e0b;color:#92400e;border-radius:8px;padding:10px 12px;margin:10px 0;font-weight:600;text-align:center;}
    #day-tabs{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0;}
    .day-tab{border:1px solid var(--border);border-radius:8px;padding:8px 10px;cursor:pointer;user-select:none;}
    .day-tab.active{background:#eef2ff;border-color:#c7d2fe;}
    .day-tab.disabled{opacity:.45;cursor:not-allowed;text-decoration:line-through;}
    /* Grid */
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:18px;}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }
    /* Children */
    .children-card, .cart-card{border:1px solid var(--border);border-radius:12px;padding:var(--pad);}
    .child-section{border:1px dashed var(--border);border-radius:10px;padding:10px;margin-top:10px;}
    .child-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;}
    .child-title{font-weight:700;}
    .form-row{display:flex;gap:8px;flex-wrap:wrap}
    .form-group{display:flex;flex-direction:column;min-width:160px;flex:1}
    input,select,button{font:inherit}
    input,select{border:1px solid var(--border);border-radius:8px;padding:8px}
    .add-child{margin-top:10px}
    /* Menu */
    .menu-for-day{display:none}
    .menu-for-day.active{display:block}
    .menu-category{border:1px solid var(--border);border-radius:12px;margin-bottom:12px}
    .menu-category-header{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;font-weight:700;cursor:pointer}
    .menu-items{padding:10px 12px;border-top:1px solid var(--border);display:grid;gap:10px}
    .menu-item{display:flex;gap:12px;align-items:flex-start}
    .menu-item-image{width:64px;height:64px;object-fit:cover;border-radius:10px;border:1px solid var(--border)}
    .item-header{display:flex;justify-content:space-between;gap:12px}
    .item-name{font-weight:700}
    .child-checkboxes{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .child-checkbox{display:flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:8px;padding:6px 8px}
    /* Cart */
    .cart-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .cart-item{display:flex;justify-content:space-between;align-items:center;border-top:1px solid var(--border);padding:8px 0}
    .empty-cart{color:var(--muted);padding:12px 0}
    .total-line{display:flex;justify-content:space-between;font-weight:700;border-top:2px solid var(--border);padding-top:8px;margin-top:8px}
    .checkout{display:flex;gap:8px;justify-content:flex-end;margin-top:10px}
    .btn{background:#111827;color:#fff;border:0;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn[disabled]{opacity:.5;cursor:not-allowed}
    /* Payment modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.32);display:none;align-items:flex-start;justify-content:center;padding:14px;z-index:50}
    .modal.show{display:flex}
    .modal-card{background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.15);max-width:620px;width:100%;margin-top:6vh;padding:14px 14px 10px}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
    .modal-body{display:grid;gap:10px;max-height:78vh;overflow:auto}
    .venmo-panel{border:1px solid var(--border);border-radius:12px;padding:10px;background:#f8fafc}
    .venmo-btn{display:inline-block;background:#3d95ce;color:#fff;text-decoration:none;border-radius:10px;padding:10px 12px}
    .notice{font-size:.9rem;color:#374151}
    /* Toast */
    .toast{position:fixed;right:12px;bottom:12px;background:#111827;color:#fff;border-radius:10px;padding:10px 12px;opacity:.96}
  </style>
</head>
<body>
  <header><h1>Artios Orders</h1></header>
  <div class="wrap">
    <div id="week-indicator">Loadingâ€¦</div>
    <div id="day-tabs" role="tablist" aria-label="Ordering Days"></div>

    <div class="grid">
      <div>
        <div id="menu-container"></div>
      </div>

      <aside>
        <div class="children-card">
          <div class="child-header"><div class="child-title">Children</div></div>
          <div id="children-container">
            <div class="child-section" data-child="1">
              <div class="form-row">
                <div class="form-group">
                  <label>First Name *</label>
                  <input type="text" class="child-first-name" />
                </div>
                <div class="form-group">
                  <label>Last Name *</label>
                  <input type="text" class="child-last-name" />
                </div>
                <div class="form-group">
                  <label>Grade *</label>
                  <select class="child-grade">
                    <option value="">Select</option>
                    <option>K-2</option><option>3-4</option><option>5-6</option>
                    <option>7-8</option><option>9-12</option><option>Staff</option><option>Parent</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <button id="add-child-btn" class="btn add-child" type="button">+ Add Child</button>
        </div>

        <div class="cart-card" style="margin-top:14px">
          <div class="cart-header"><div style="font-weight:700">Cart</div></div>
          <div id="cart-items" class="empty-cart">No items selected</div>
          <div class="total-line"><div>Total</div><div>$<span id="total-amount">0.00</span></div></div>
          <div class="checkout">
            <button id="checkout-btn" class="btn" disabled>Checkout</button>
          </div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Payment Modal (compact) -->
  <div id="payment-modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="payTitle">
    <div class="modal-card">
      <div class="modal-head">
        <div id="payTitle" style="font-weight:700">Complete Your Order</div>
        <button id="modal-close" class="btn" style="background:#6b7280">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="venmo-panel">
          <div class="notice">Amount: $<span id="payment-amount">0.00</span> â€¢ Order <span id="payment-order-id">â€”</span></div>
          <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
            <a id="venmo-link" class="venmo-btn" href="#">Pay with Venmo</a>
            <button id="confirm-paid" class="btn" style="background:#16a34a" disabled>I've Paid â€” Submit</button>
          </div>
          <div class="notice" style="margin-top:6px">Mobile opens the app. Desktop opens venmo.com in a new tab.</div>
        </div>

        <div id="summary" style="border:1px solid var(--border);border-radius:12px;padding:10px">
          <div style="font-weight:700;margin-bottom:6px">Summary</div>
          <div id="summary-items"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  class OrderSystem {
    constructor(){
      this.config = {
        webAppUrl: '', // optional Apps Script endpoint
      };
      this.state = {
        currentDay: 'monday',
        currentWeekMonday: null,
        orderItems: [],
        currentTotal: 0,
        childCount: 1,
        orderId: ''
      };
      this.constants = {
        days: ['monday','tuesday','wednesday','thursday','friday'],
        dayNames: ['Monday','Tuesday','Wednesday','Thursday','Friday']
      };
    }

    /* ---------- INIT & WEEK ---------- */
    async init(){
      try{
        await this.loadMenuData();
        this.setupEventListeners();
        this.updateWeekIndicator();
        this.toast('Menu data loaded successfully');
      }catch(e){ console.error(e); this.toast('Error loading menu','err'); }
    }

    getOrderingWeekMonday(){
      const now = new Date();
      const dow = now.getDay();
      const hr = now.getHours();
      const monday = new Date(now);
      if ((dow===5 && hr>=12) || dow===6 || dow===0){
        const delta = dow===0 ? 1 : (8 - dow);
        monday.setDate(monday.getDate()+delta);
      } else {
        const back = dow===0 ? -6 : (1 - dow);
        monday.setDate(monday.getDate()+back);
      }
      monday.setHours(0,0,0,0);
      this.state.currentWeekMonday = monday;
      return monday;
    }
    updateWeekIndicator(){
      const mon = this.getOrderingWeekMonday();
      const fri = new Date(mon); fri.setDate(mon.getDate()+4);
      const fmt = d => d.toLocaleDateString('en-US',{month:'short',day:'numeric'});
      const nowMon = this.getCurrentWeekMonday(new Date());
      const next = mon > nowMon ? 'NEXT' : 'THIS';
      const el = document.getElementById('week-indicator');
      if (el) el.textContent = `ðŸ“… Ordering for ${next} WEEK: ${fmt(mon)} - ${fmt(fri)}`;
    }
    getCurrentWeekMonday(d){
      const x = new Date(d); const day = x.getDay();
      x.setDate(x.getDate() - day + (day===0?-6:1)); x.setHours(0,0,0,0); return x;
    }
    calculateDateForDay(dayName){
      const mon = this.state.currentWeekMonday || this.getOrderingWeekMonday();
      const idx = this.constants.dayNames.indexOf(dayName);
      const d = new Date(mon); d.setDate(mon.getDate()+idx);
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }
    formatDate(dateStr){
      const d = new Date(dateStr+'T12:00:00');
      return d.toLocaleDateString('en-US',{month:'short'})+' '+d.getDate();
    }

    /* ---------- MENU ---------- */
    async loadMenuData(){
      // static data; mimic async for consistency
      await new Promise(r=>setTimeout(r,50));
      this.menuData = {
        entrees: [
          { id:'chicken-sandwich', name:'Chicken Sandwich', price:6.50, desc:'Classic breast of chicken', image:'' },
          { id:'spicy-chicken', name:'Spicy Chicken Sandwich', price:6.75, desc:'Spicy seasoning', image:'' },
          { id:'nuggets-12', name:'Nuggets (12ct)', price:8.50, desc:'Twelve bite-size pieces', image:'' },
          { id:'nuggets-8', name:'Nuggets (8ct)', price:6.50, desc:'Eight bite-size pieces', image:'' },
          { id:'grilled-sandwich', name:'Grilled Sandwich', price:8.25, desc:'Grilled chicken sandwich', image:'' },
          { id:'chicken-wrap', name:'Chicken Wrap', price:9.75, desc:'Grilled chicken wrap', image:'' }
        ],
        salads: [
          { id:'cobb-salad', name:'Cobb Salad', price:11.25, desc:'Mixed greens with toppings', image:'' },
          { id:'southwest-salad', name:'Southwest Salad', price:11.50, desc:'Southwest style', image:'' }
        ],
        sides: [
          { id:'fries-only', name:'Fries', price:3.75, desc:'Waffle fries', image:'' },
          { id:'fruit-only', name:'Fruit Cup', price:5.50, desc:'Fresh fruit', image:'' },
          { id:'mac-only', name:'Mac & Cheese', price:5.50, desc:'Creamy mac', image:'' }
        ],
        drinks: [
          { id:'regular-drink', name:'Regular Drink', basePrice:1.50, desc:'Sodas/Water at pickup', category:'regular' },
          { id:'premium-drink', name:'Premium Drink', basePrice:3.00, desc:'Iced coffee/Vitamin water', category:'premium' }
        ]
      };
      this.generateDayTabs();
      this.generateMenus();
      const firstAvailable = document.querySelector('.day-tab:not(.disabled)');
      this.switchDay(firstAvailable ? firstAvailable.dataset.day : 'monday');
    }

    generateDayTabs(){
      const tabs = document.getElementById('day-tabs'); if (!tabs) return;
      tabs.innerHTML='';
      const now = new Date();
      const mon = this.state.currentWeekMonday || this.getOrderingWeekMonday();
      let firstAvail = null;
      this.constants.days.forEach((day, i)=>{
        const d = new Date(mon); d.setDate(mon.getDate()+i);
        const cutoff = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 10, 0, 0, 0);
        const isPast = now > cutoff;
        const tab = document.createElement('div');
        tab.className = 'day-tab'; tab.dataset.day = day; tab.setAttribute('role','tab'); tab.textContent = this.constants.dayNames[i];
        if (isPast){ tab.classList.add('disabled'); tab.title = 'Closed (10:00 AM cutoff)'; }
        else {
          tab.addEventListener('click', ()=>this.switchDay(day));
          tab.addEventListener('keydown', e=>{ if(e.key==='Enter'||e.key===' ') { e.preventDefault(); this.switchDay(day); } });
          if (!firstAvail) firstAvail = day;
        }
        tabs.appendChild(tab);
      });
      const act = firstAvail || 'monday';
      this.state.currentDay = act;
      const el = document.querySelector(`[data-day="${act}"]`); if (el){ el.classList.add('active'); el.setAttribute('aria-selected','true'); }
    }

    generateMenus(){
      const container = document.getElementById('menu-container'); if (!container) return;
      container.innerHTML='';
      this.constants.days.forEach(day=>{
        const wrap = document.createElement('div'); wrap.className='menu-for-day'; wrap.dataset.day = day;
        if (day===this.state.currentDay) wrap.classList.add('active');

        Object.keys(this.menuData).forEach(category=>{
          const catDiv = document.createElement('div'); catDiv.className='menu-category';
          const head = document.createElement('div'); head.className='menu-category-header'; head.innerHTML = `<span>${category[0].toUpperCase()+category.slice(1)}</span><span>â–¼</span>`;
          const itemsDiv = document.createElement('div'); itemsDiv.className='menu-items';

          if (category==='drinks'){
            const dn = document.createElement('div');
            dn.style.cssText = 'background:#ecfdf5;border:1px solid #a7f3d0;border-radius:10px;padding:8px';
            dn.innerHTML = '<strong>Combo Drink Discount</strong>: Entree/Salad + Side â†’ Regular Drink <b>FREE</b>, Premium <b>$1.50</b>';
            itemsDiv.appendChild(dn);
          }

          this.menuData[category].forEach(item=>{
            const itemDiv = document.createElement('div'); itemDiv.className='menu-item';
            const price = category==='drinks'? `$${item.basePrice.toFixed(2)}` : `$${item.price.toFixed(2)}`;
            itemDiv.innerHTML = `
              ${item.image?`<img class="menu-item-image" src="${item.image}" alt="${item.name}" onerror="this.style.display='none'">`:''}
              <div class="menu-item-content">
                <div class="item-header">
                  <div class="item-name">${item.name}</div>
                  <div class="item-price" data-item-id="${item.id}">${price}</div>
                </div>
                <div class="item-desc">${item.desc}</div>
                <div class="child-checkboxes" id="${item.id}-${day}-checkboxes"></div>
              </div>`;
            itemsDiv.appendChild(itemDiv);
          });

          head.addEventListener('click', ()=>catDiv.classList.toggle('collapsed'));
          catDiv.appendChild(head); catDiv.appendChild(itemsDiv);
          wrap.appendChild(catDiv);
        });

        container.appendChild(wrap);
      });

      this.updateChildCheckboxes();
    }

    switchDay(day){
      document.querySelectorAll('.day-tab').forEach(t=>{
        const active = t.dataset.day===day; t.classList.toggle('active', active); t.setAttribute('aria-selected', String(active));
      });
      document.querySelectorAll('.menu-for-day').forEach(m=>m.classList.toggle('active', m.dataset.day===day));
      this.state.currentDay = day;
    }

    /* ---------- CHILDREN & CHECKBOXES ---------- */
    addChild(){
      this.state.childCount += 1;
      const n = this.state.childCount;
      const container = document.getElementById('children-container');
      const sec = document.createElement('div'); sec.className='child-section'; sec.dataset.child = String(n);
      sec.innerHTML = `
        <div class="form-row">
          <div class="form-group"><label>First Name *</label><input type="text" class="child-first-name"></div>
          <div class="form-group"><label>Last Name *</label><input type="text" class="child-last-name"></div>
          <div class="form-group">
            <label>Grade *</label>
            <select class="child-grade">
              <option value="">Select</option><option>K-2</option><option>3-4</option><option>5-6</option>
              <option>7-8</option><option>9-12</option><option>Staff</option><option>Parent</option>
            </select>
          </div>
        </div>`;
      container.appendChild(sec);
      this.updateChildCheckboxes();
    }

    updateChildCheckboxes(){
      const children = Array.from(document.querySelectorAll('.child-section')).map(sec=>{
        const f = sec.querySelector('.child-first-name')?.value.trim()||'';
        const l = sec.querySelector('.child-last-name')?.value.trim()||'';
        return f ? (l? `${f} ${l}` : f) : '';
      }).filter(Boolean);

      document.querySelectorAll('.child-checkboxes').forEach(holder=>{
        const id = holder.id||''; const parts = id.split('-'); const itemId = parts[0]; const day = parts[1];
        const dayLabel = day.charAt(0).toUpperCase()+day.slice(1);
        holder.innerHTML='';
        children.forEach(name=>{
          const wrap = document.createElement('label'); wrap.className='child-checkbox';
          const cb = document.createElement('input'); cb.type='checkbox'; cb.dataset.item=itemId; cb.dataset.day=day; cb.dataset.child=name;
          const lab = document.createElement('span'); lab.textContent = `${name} (${dayLabel})`;
          wrap.appendChild(cb); wrap.appendChild(lab); holder.appendChild(wrap);
        });
      });
    }

    /* ---------- CART ---------- */
    updateCart(){
      const cartEl = document.getElementById('cart-items');
      const totalEl = document.getElementById('total-amount');
      const selected = Array.from(document.querySelectorAll('input[type="checkbox"][data-item]:checked'));
      const items = selected.map(cb=>{
        const itemId = cb.dataset.item; const day = cb.dataset.day; const childName = cb.dataset.child;
        const category = Object.keys(this.menuData).find(cat=>this.menuData[cat].some(i=>i.id===itemId));
        const item = this.menuData[category].find(i=>i.id===itemId);
        const basePrice = category==='drinks'? item.basePrice : item.price;
        let finalPrice = basePrice;
        if (category==='drinks'){
          const childDayItems = selected.filter(c=>c.dataset.day===day && c.dataset.child===childName);
          const hasMain = childDayItems.some(c=>{const id=c.dataset.item; const cat=Object.keys(this.menuData).find(ct=>this.menuData[ct].some(i=>i.id===id)); return (cat==='entrees'||cat==='salads');});
          const hasSide = childDayItems.some(c=>{const id=c.dataset.item; const cat=Object.keys(this.menuData).find(ct=>this.menuData[ct].some(i=>i.id===id)); return (cat==='sides');});
          if (hasMain && hasSide){ finalPrice = (item.category==='regular')? 0 : 1.50; }
        }
        return { day, childName, itemId, itemName:item.name, finalPrice, category };
      });
      this.state.orderItems = items;

      if (items.length===0){ cartEl.classList.add('empty-cart'); cartEl.innerHTML='No items selected'; totalEl.textContent='0.00'; }
      else {
        cartEl.classList.remove('empty-cart');
        const byChild = items.reduce((acc,it)=>{ (acc[it.childName]=acc[it.childName]||[]).push(it); return acc; },{});
        const frag = document.createDocumentFragment();
        let total = 0;
        Object.keys(byChild).forEach(child=>{
          const head = document.createElement('div'); head.style.cssText='font-weight:700;margin-top:6px'; head.textContent = child; frag.appendChild(head);
          byChild[child].forEach(it=>{
            total += it.finalPrice;
            const row = document.createElement('div'); row.className='cart-item';
            row.innerHTML = `<div>${it.itemName} â€” ${it.day[0].toUpperCase()+it.day.slice(1)}</div><div>$${it.finalPrice.toFixed(2)}</div>`;
            frag.appendChild(row);
          });
        });
        cartEl.innerHTML=''; cartEl.appendChild(frag);
        totalEl.textContent = total.toFixed(2);
        this.state.currentTotal = total;
      }
      document.getElementById('checkout-btn').disabled = !(this.validAtLeastOneChild() && this.state.orderItems.length>0);
      this.renderSummary();
    }

    validAtLeastOneChild(){
      const kids = Array.from(document.querySelectorAll('.child-section')).map(sec=>{
        const f = sec.querySelector('.child-first-name')?.value.trim()||'';
        const l = sec.querySelector('.child-last-name')?.value.trim()||'';
        const g = sec.querySelector('.child-grade')?.value||'';
        return !!(f && l && g);
      });
      return kids.some(Boolean);
    }

    /* ---------- PAYMENT ---------- */
    dayShort(day){ return {monday:'M',tuesday:'T',wednesday:'W',thursday:'Th',friday:'F'}[day] || day[0].toUpperCase(); }
    getAbbrevForItem(it){
      const map = {
        'chicken-sandwich':'ChkSand','spicy-chicken':'SpicySand','nuggets-8':'Nugg8','nuggets-12':'Nugg12',
        'cobb-salad':'Cobb','southwest-salad':'SwSalad','market-salad':'Market','fries-only':'Fries','fruit-only':'Fruit',
        'mac-only':'Mac','salad-only':'SideSalad','kale-crunch':'Kale','parfait-only':'Parfait','chips-only':'Chips',
        'regular-drink':'Reg Drink','premium-drink':'Prem Drink','chicken-wrap':'Wrap','veggie-wrap':'VegWrap',
        'grilled-sandwich':'GrilledSand','grilled-gf':'GrilledGF','grilled-nuggets':'GrilledNugg','chicken-strips':'Strips'
      };
      return map[it.itemId] || it.itemName;
    }
    buildVenmoNote(orderId, total, items){
      const perDay = {};
      items.forEach(it=>{
        const d = this.dayShort(it.day);
        const ab = this.getAbbrevForItem(it);
        (perDay[d]=perDay[d]||{})[ab] = (perDay[d]?.[ab]||0)+1;
      });
      const makeLines = pd => ['M','T','W','Th','F'].map(d=>{
        const row = pd[d]; if (!row) return null;
        return `${d}: ${Object.keys(row).map(k=>`${row[k]} ${k}`).join(', ')}`;
      }).filter(Boolean);

      let note = `#${orderId} $${total.toFixed(2)} ${makeLines(perDay).join(' ')}`;
      if (note.length <= 165) return note;

      const totalItems = items.length;
      return `#${orderId} $${total.toFixed(2)} M-F: ${totalItems} items total`;
    }

    openPaymentModal(){
      const modal = document.getElementById('payment-modal');
      const payAmt = document.getElementById('payment-amount');
      const orderIdEl = document.getElementById('payment-order-id');
      const venmoLink = document.getElementById('venmo-link');
      const confirmBtn = document.getElementById('confirm-paid');

      if (!this.state.orderId) this.state.orderId = 'ORD-' + Math.random().toString(36).slice(2,8).toUpperCase();
      orderIdEl.textContent = this.state.orderId;
      payAmt.textContent = (Number(this.state.currentTotal)||0).toFixed(2);

      // Build Venmo link (mobile deep link / desktop web)
      const note = this.buildVenmoNote(this.state.orderId, Number(this.state.currentTotal)||0, this.state.orderItems||[]);
      const handle = 'ChanTa-Rivers';
      const appUrl = `venmo://paycharge?txn=pay&recipients=${handle}&amount=${(Number(this.state.currentTotal)||0).toFixed(2)}&note=${encodeURIComponent(note)}`;
      const webUrl = `https://venmo.com/${handle}?txn=pay&amount=${(Number(this.state.currentTotal)||0).toFixed(2)}&note=${encodeURIComponent(note)}`;
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent||'');

      venmoLink.onclick = null;
      if (isMobile){
        venmoLink.setAttribute('href', appUrl);
        venmoLink.removeAttribute('target');
      } else {
        venmoLink.setAttribute('href', webUrl);
        venmoLink.setAttribute('target', '_blank');
      }

      // Enable confirm after click (user indicates they paid)
      confirmBtn.disabled = false;

      modal.classList.add('show');
    }

    closePaymentModal(){ document.getElementById('payment-modal')?.classList.remove('show'); }

    /* ---------- SUMMARY ---------- */
    renderSummary(){
      const box = document.getElementById('summary-items'); if (!box) return;
      const items = this.state.orderItems||[];
      if (!items.length){ box.innerHTML = '<div class="notice">No items</div>'; return; }
      const byDay = items.reduce((acc,it)=>{ (acc[it.day]=acc[it.day]||[]).push(it); return acc; },{});
      const frag = document.createDocumentFragment();
      Object.keys(byDay).sort((a,b)=>this.constants.days.indexOf(a)-this.constants.days.indexOf(b)).forEach(day=>{
        const head = document.createElement('div'); head.style.cssText='font-weight:700;margin-top:4px'; const idx=this.constants.days.indexOf(day);
        head.textContent = `${this.constants.dayNames[idx]} â€¢ ${this.formatDate(this.calculateDateForDay(this.constants.dayNames[idx]))}`;
        frag.appendChild(head);
        byDay[day].forEach(it=>{
          const row = document.createElement('div'); row.style.cssText='display:flex;justify-content:space-between';
          row.innerHTML = `<div>${it.childName} â€” ${it.itemName}</div><div>$${it.finalPrice.toFixed(2)}</div>`;
          frag.appendChild(row);
        });
      });
      box.innerHTML=''; box.appendChild(frag);
    }

    /* ---------- EVENTS ---------- */
    setupEventListeners(){
      document.getElementById('add-child-btn')?.addEventListener('click', ()=>this.addChild());
      document.addEventListener('input', e=>{
        const el = e.target;
        if (el.classList?.contains('child-first-name') || el.classList?.contains('child-last-name') || el.classList?.contains('child-grade')){
          this.updateChildCheckboxes();
          this.updateCart();
        }
      });
      document.addEventListener('change', e=>{
        const t = e.target;
        if (t && t.type==='checkbox' && t.dataset.item) this.updateCart();
      });
      document.getElementById('checkout-btn')?.addEventListener('click', (e)=>{
        e.preventDefault();
        if (!(this.validAtLeastOneChild() && this.state.orderItems.length>0)){ this.toast('Add kids & items','err'); return; }
        this.openPaymentModal();
      });
      document.getElementById('modal-close')?.addEventListener('click', ()=>this.closePaymentModal());
      document.getElementById('confirm-paid')?.addEventListener('click', ()=>{
        this.closePaymentModal();
        this.toast('Order saved â€” thank you!', 'ok');
        // Reset after closing
        setTimeout(()=>this.resetForm(), 400);
      });
    }

    resetForm(){
      // Uncheck all
      document.querySelectorAll('input[type="checkbox"][data-item]').forEach(cb=>cb.checked=false);
      // Clear children back to one
      const cont = document.getElementById('children-container');
      cont.innerHTML = cont.innerHTML = document.querySelector('.child-section')?.outerHTML || '';
      // Clear state
      this.state.orderItems = []; this.state.currentTotal = 0; this.state.childCount = 1; this.state.orderId='';
      // Refresh UI
      this.updateChildCheckboxes(); this.updateCart();
    }

    /* ---------- UTIL ---------- */
    toast(msg, type){
      const t = document.createElement('div'); t.className='toast'; t.textContent=msg;
      t.style.background = type==='ok' ? '#16a34a' : type==='err' ? '#ef4444' : '#111827';
      document.body.appendChild(t); setTimeout(()=>{ t.remove(); }, 2200);
    }
  }

  let app;
  document.addEventListener('DOMContentLoaded', ()=>{
    app = new OrderSystem(); app.init();
  });
  </script>
</body>
</html>
